[{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\App.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadNodes'. Either include it or remove the dependency array.","line":78,"column":6,"nodeType":"ArrayExpression","endLine":78,"endColumn":25,"suggestions":[{"desc":"Update the dependencies array to be: [loadNodes, session.user.id]","fix":{"range":[3018,3037],"text":"[loadNodes, session.user.id]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":135,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":135,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4931,4934],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4931,4934],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":279,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":279,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9484,9487],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9484,9487],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useState, useEffect, useRef } from 'react'\r\nimport './App.css'\r\nimport { NodeTree } from './components/NodeTree'\r\nimport { Auth } from './components/Auth'\r\nimport { AdminModal } from './components/AdminModal'\r\nimport { UploadModal } from './components/UploadModal'\r\nimport { TagMaintenanceModal } from './components/TagMaintenanceModal'\r\nimport { ClassificationModal } from './components/ClassificationModal'\r\nimport { TagFilterModal } from './components/TagFilterModal'\r\nimport bannerImage from './assets/tulkah-banner.png'\r\nimport { NodeService } from './services/NodeService'\r\nimport { AuthService } from './services/AuthService'\r\nimport type { DocumentNode } from './types'\r\nimport { supabase } from './lib/supabase'\r\nimport type { Session } from '@supabase/supabase-js'\r\n\r\nfunction App() {\r\n  // Auth State\r\n  const [session, setSession] = useState<Session | null>(null);\r\n  const [authLoading, setAuthLoading] = useState(true);\r\n\r\n  // App State\r\n  const [nodes, setNodes] = useState<DocumentNode[]>([]);\r\n  const [expandedNodeIds, setExpandedNodeIds] = useState<Set<number>>(new Set());\r\n  const [loading, setLoading] = useState(false); // Node loading\r\n  const [error, setError] = useState<string | null>(null);\r\n  const [isSaving, setIsSaving] = useState(false);\r\n  const [showSaveMessage, setShowSaveMessage] = useState(false);\r\n  const [isInitialized, setIsInitialized] = useState(false);\r\n\r\n  // Admin State\r\n  const [isAdmin, setIsAdmin] = useState(false);\r\n  const [showAdmin, setShowAdmin] = useState(false);\r\n  const [showUpload, setShowUpload] = useState(false);\r\n  const [showTags, setShowTags] = useState(false);\r\n  const [showClassify, setShowClassify] = useState(false);\r\n\r\n  const [showTagFilter, setShowTagFilter] = useState(false);\r\n  const [activeFilterTagIds, setActiveFilterTagIds] = useState<Set<number>>(new Set());\r\n  const [filterFilePaths, setFilterFilePaths] = useState<Set<string> | null>(null);\r\n\r\n  const loadedSessionId = useRef<string | null>(null);\r\n\r\n  // Auth Effect\r\n  useEffect(() => {\r\n    supabase.auth.getSession().then(({ data: { session } }) => {\r\n      setSession(session);\r\n      setAuthLoading(false);\r\n      if (session) checkAdminStatus();\r\n    });\r\n\r\n    const {\r\n      data: { subscription },\r\n    } = supabase.auth.onAuthStateChange((event, session) => {\r\n      setSession(session);\r\n      if (event === 'SIGNED_IN') {\r\n        checkAdminStatus();\r\n      }\r\n      if (event === 'SIGNED_OUT') {\r\n        // Clear local storage on sign out\r\n        localStorage.removeItem('hierarchy_nodes');\r\n        localStorage.removeItem('hierarchy_expanded');\r\n        setNodes([]);\r\n        setExpandedNodeIds(new Set());\r\n        setIsAdmin(false);\r\n      }\r\n    });\r\n\r\n    return () => subscription.unsubscribe();\r\n  }, []);\r\n\r\n  // Node Loading Effect - Only load if authenticated\r\n  useEffect(() => {\r\n    if (session?.user?.id && session.user.id !== loadedSessionId.current) {\r\n      loadedSessionId.current = session.user.id;\r\n      loadNodes();\r\n    }\r\n  }, [session?.user?.id]);\r\n\r\n  const checkAdminStatus = async () => {\r\n    // Check if user is admin\r\n    // Also try to ensure the role exists for the super admin\r\n    // await AuthService.ensureAdminRole(); // Commented out to prevent 403 loop\r\n    const isAdm = await AuthService.checkIsAdmin();\r\n    setIsAdmin(isAdm);\r\n  };\r\n\r\n  const loadNodes = async (force = false, tagsOverride?: Set<number>) => {\r\n    const tagsToUse = tagsOverride || activeFilterTagIds;\r\n\r\n    try {\r\n      setLoading(true);\r\n\r\n      if (!force && tagsToUse.size === 0) {\r\n        const savedNodes = localStorage.getItem('hierarchy_nodes');\r\n        const savedExpanded = localStorage.getItem('hierarchy_expanded');\r\n\r\n        if (savedNodes) {\r\n          try {\r\n            setNodes(JSON.parse(savedNodes));\r\n            if (savedExpanded) {\r\n              setExpandedNodeIds(new Set(JSON.parse(savedExpanded)));\r\n            } else {\r\n              setExpandedNodeIds(new Set());\r\n            }\r\n            setLoading(false);\r\n            return;\r\n          } catch (e) {\r\n            console.error('Failed to parse saved state:', e);\r\n            // Fall back to server load\r\n          }\r\n        }\r\n      }\r\n\r\n      let data: DocumentNode[];\r\n      if (tagsToUse.size > 0) {\r\n        data = await NodeService.fetchNodesByTags(Array.from(tagsToUse));\r\n      } else {\r\n        data = await NodeService.fetchNodes();\r\n      }\r\n\r\n      setNodes(data);\r\n\r\n      // Infer expansion state: A node is expanded if any of its children are visible\r\n      // If filtering, we might want to expand everything to show matches?\r\n      // For now, keep existing logic (expand parents of visible nodes)\r\n      const expanded = new Set<number>();\r\n      data.forEach(node => {\r\n        if (node.visible && node.parentNodeID) {\r\n          expanded.add(node.parentNodeID);\r\n        }\r\n      });\r\n      setExpandedNodeIds(expanded);\r\n\r\n    } catch (err: any) {\r\n      setError(err.message);\r\n    } finally {\r\n      setLoading(false);\r\n      setIsInitialized(true);\r\n    }\r\n  };\r\n\r\n  // Save state to local storage whenever it changes\r\n  useEffect(() => {\r\n    // Only save if NO filter is active\r\n    if (isInitialized && nodes.length > 0 && activeFilterTagIds.size === 0) {\r\n      localStorage.setItem('hierarchy_nodes', JSON.stringify(nodes));\r\n    }\r\n  }, [nodes, isInitialized, activeFilterTagIds]);\r\n\r\n  useEffect(() => {\r\n    if (isInitialized && activeFilterTagIds.size === 0) {\r\n      localStorage.setItem('hierarchy_expanded', JSON.stringify(Array.from(expandedNodeIds)));\r\n    }\r\n  }, [expandedNodeIds, isInitialized, activeFilterTagIds]);\r\n\r\n  const handleNodeAdded = (newNode: DocumentNode) => {\r\n    setNodes(prev => [...prev, newNode]);\r\n    if (newNode.parentNodeID && newNode.parentNodeID > 0) {\r\n      setExpandedNodeIds(prev => {\r\n        const next = new Set(prev);\r\n        next.add(newNode.parentNodeID!);\r\n        return next;\r\n      });\r\n    }\r\n  };\r\n\r\n  const handleNodeUpdated = (updatedNode: DocumentNode) => {\r\n    setNodes(prev => prev.map(node =>\r\n      node.nodeID === updatedNode.nodeID ? updatedNode : node\r\n    ));\r\n  };\r\n\r\n\r\n\r\n  const handleNodesUpdated = (updatedNodes: DocumentNode[]) => {\r\n    const updateMap = new Map(updatedNodes.map(node => [node.nodeID, node]));\r\n    setNodes(prev => prev.map(node => updateMap.get(node.nodeID) || node));\r\n  };\r\n\r\n  const handleToggleNode = (nodeId: number) => {\r\n    setExpandedNodeIds(prev => {\r\n      const next = new Set(prev);\r\n      if (next.has(nodeId)) {\r\n        next.delete(nodeId);\r\n      } else {\r\n        next.add(nodeId);\r\n      }\r\n      return next;\r\n    });\r\n  };\r\n\r\n  const handleFilterByTags = async (tagIds: Set<number>) => {\r\n    setActiveFilterTagIds(tagIds);\r\n    // When filtering via tags (valid or empty), we clear the file-path based client-side filter\r\n    setFilterFilePaths(null);\r\n    await loadNodes(true, tagIds);\r\n  };\r\n\r\n  // Calculate nodes to display\r\n  const getDisplayNodes = () => {\r\n    if (!filterFilePaths) return nodes;\r\n\r\n    const includedNodeIds = new Set<number>();\r\n    const nodesById = new Map(nodes.map(n => [n.nodeID, n]));\r\n\r\n    const addNodeAndAncestors = (node: DocumentNode) => {\r\n      if (includedNodeIds.has(node.nodeID)) return;\r\n      includedNodeIds.add(node.nodeID);\r\n\r\n      if (node.parentNodeID) {\r\n        const parent = nodesById.get(node.parentNodeID);\r\n        if (parent) addNodeAndAncestors(parent);\r\n      }\r\n    };\r\n\r\n    nodes.forEach(node => {\r\n      if (node.url) {\r\n        const urlPath = node.url.split('/').pop() || node.url;\r\n        if (filterFilePaths.has(urlPath)) {\r\n          addNodeAndAncestors(node);\r\n        }\r\n      }\r\n    });\r\n\r\n    return nodes.filter(n => includedNodeIds.has(n.nodeID));\r\n  };\r\n\r\n  const displayNodes = getDisplayNodes();\r\n\r\n  const handleSaveHierarchy = async () => {\r\n    try {\r\n      setIsSaving(true);\r\n      const visibilityMap = new Map<number, boolean>();\r\n      const childrenMap = new Map<number, DocumentNode[]>();\r\n      const roots: DocumentNode[] = [];\r\n\r\n      nodes.forEach(node => {\r\n        if (!node.parentNodeID || node.parentNodeID === 0 || node.parentNodeID === -1) {\r\n          roots.push(node);\r\n        } else {\r\n          const list = childrenMap.get(node.parentNodeID) || [];\r\n          list.push(node);\r\n          childrenMap.set(node.parentNodeID, list);\r\n        }\r\n      });\r\n\r\n      const updates: { nodeID: number; visible: boolean }[] = [];\r\n\r\n      const processNode = (node: DocumentNode, isParentVisible: boolean, isParentExpanded: boolean) => {\r\n        let isVisible = false;\r\n        if (!node.parentNodeID || node.parentNodeID === 0 || node.parentNodeID === -1) {\r\n          isVisible = true;\r\n        } else {\r\n          isVisible = isParentVisible && isParentExpanded;\r\n        }\r\n\r\n        visibilityMap.set(node.nodeID, isVisible);\r\n\r\n        // Only update writeable nodes\r\n        if (node.access_level !== 'read_only') {\r\n          updates.push({\r\n            ...node,\r\n            visible: isVisible\r\n          });\r\n        }\r\n\r\n        const isExpanded = expandedNodeIds.has(node.nodeID);\r\n        const children = childrenMap.get(node.nodeID) || [];\r\n        children.forEach(child => processNode(child, isVisible, isExpanded));\r\n      };\r\n\r\n      roots.forEach(root => processNode(root, true, true));\r\n\r\n      await NodeService.bulkUpdateNodes(updates);\r\n\r\n      setShowSaveMessage(true);\r\n      setTimeout(() => setShowSaveMessage(false), 2000);\r\n    } catch (err: any) {\r\n      alert('Failed to save hierarchy: ' + err.message);\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  };\r\n\r\n  if (authLoading) {\r\n    return (\r\n      <div style={{\r\n        display: 'flex',\r\n        justifyContent: 'center',\r\n        alignItems: 'center',\r\n        height: '100vh',\r\n        backgroundColor: 'var(--color-bg-primary)',\r\n        color: 'var(--color-text-primary)'\r\n      }}>\r\n        Loading...\r\n      </div>\r\n    );\r\n  }\r\n\r\n  if (!session) {\r\n    return <Auth />;\r\n  }\r\n\r\n  return (\r\n    <>\r\n      <div style={{ marginBottom: '1rem', position: 'relative' }}>\r\n        <div style={{\r\n          position: 'absolute',\r\n          top: '1rem',\r\n          right: '1rem',\r\n          zIndex: 100,\r\n          display: 'flex',\r\n          flexDirection: 'column',\r\n          alignItems: 'flex-end',\r\n          gap: '0.5rem'\r\n        }}>\r\n          <button\r\n            onClick={() => supabase.auth.signOut()}\r\n            style={{\r\n              padding: '0.5rem 1rem',\r\n              fontSize: '0.8rem',\r\n              backgroundColor: 'rgba(0, 0, 0, 0.5)',\r\n              border: '1px solid rgba(255, 255, 255, 0.3)',\r\n              borderRadius: '4px',\r\n              color: '#fff',\r\n              cursor: 'pointer',\r\n              backdropFilter: 'blur(4px)'\r\n            }}\r\n          >\r\n            Sign Out\r\n          </button>\r\n\r\n          <div style={{ display: 'flex', gap: '0.5rem' }}>\r\n            <button\r\n              onClick={() => setShowTags(true)}\r\n              style={{\r\n                padding: '0.5rem 1rem',\r\n                fontSize: '0.8rem',\r\n                minWidth: '80px',\r\n                backgroundColor: 'rgba(124, 58, 237, 0.5)', // Purple tint\r\n                border: '1px solid rgba(124, 58, 237, 0.3)',\r\n                borderRadius: '4px',\r\n                color: '#fff',\r\n                cursor: 'pointer',\r\n                backdropFilter: 'blur(4px)'\r\n              }}\r\n            >\r\n              Tags\r\n            </button>\r\n\r\n            <button\r\n              onClick={() => setShowClassify(true)}\r\n              style={{\r\n                padding: '0.5rem 1rem',\r\n                fontSize: '0.8rem',\r\n                minWidth: '80px',\r\n                backgroundColor: 'rgba(245, 158, 11, 0.5)', // Amber/Orange tint\r\n                border: '1px solid rgba(245, 158, 11, 0.3)',\r\n                borderRadius: '4px',\r\n                color: '#fff',\r\n                cursor: 'pointer',\r\n                backdropFilter: 'blur(4px)'\r\n              }}\r\n            >\r\n              Classify\r\n            </button>\r\n          </div>\r\n\r\n          <div style={{ display: 'flex', gap: '0.5rem' }}>\r\n            <button\r\n              onClick={() => setShowUpload(true)}\r\n              style={{\r\n                padding: '0.5rem 1rem',\r\n                fontSize: '0.8rem',\r\n                minWidth: '80px',\r\n                backgroundColor: 'rgba(16, 185, 129, 0.5)', // Green tint\r\n                border: '1px solid rgba(16, 185, 129, 0.3)',\r\n                borderRadius: '4px',\r\n                color: '#fff',\r\n                cursor: 'pointer',\r\n                backdropFilter: 'blur(4px)'\r\n              }}\r\n            >\r\n              Upload\r\n            </button>\r\n\r\n            {isAdmin && (\r\n              <button\r\n                onClick={() => setShowAdmin(true)}\r\n                style={{\r\n                  padding: '0.5rem 1rem',\r\n                  fontSize: '0.8rem',\r\n                  minWidth: '80px',\r\n                  backgroundColor: 'rgba(59, 130, 246, 0.5)', // Blue tint\r\n                  border: '1px solid rgba(59, 130, 246, 0.3)',\r\n                  borderRadius: '4px',\r\n                  color: '#fff',\r\n                  cursor: 'pointer',\r\n                  backdropFilter: 'blur(4px)'\r\n                }}\r\n              >\r\n                Admin\r\n              </button>\r\n            )}\r\n          </div>\r\n\r\n          <button\r\n            onClick={() => setShowTagFilter(true)}\r\n            style={{\r\n              padding: '0.5rem 1rem',\r\n              fontSize: '0.8rem',\r\n              backgroundColor: activeFilterTagIds.size > 0 ? 'rgba(239, 68, 68, 0.8)' : 'rgba(59, 130, 246, 0.5)',\r\n              border: activeFilterTagIds.size > 0 ? '1px solid rgba(239, 68, 68, 0.5)' : '1px solid rgba(59, 130, 246, 0.3)',\r\n              borderRadius: '4px',\r\n              color: '#fff',\r\n              cursor: 'pointer',\r\n              backdropFilter: 'blur(4px)',\r\n              display: 'flex',\r\n              alignItems: 'center',\r\n              justifyContent: 'center',\r\n              gap: '0.25rem'\r\n            }}\r\n          >\r\n            {activeFilterTagIds.size > 0 ? `­ƒÜ½ Clear (${activeFilterTagIds.size})` : '­ƒöì Filter'}\r\n          </button>\r\n          <div style={{\r\n            fontSize: '0.7rem',\r\n            color: 'rgba(255, 255, 255, 0.8)',\r\n            marginTop: '0.25rem',\r\n            textShadow: '0 1px 2px rgba(0,0,0,0.5)'\r\n          }}>\r\n            {session.user.email}\r\n          </div>\r\n        </div>\r\n        <img\r\n          src={bannerImage}\r\n          alt=\"Tulkah AI - Embedding AI driven innovation & productivity\"\r\n          style={{\r\n            width: '100%',\r\n            maxWidth: '800px',\r\n            height: 'auto',\r\n            borderRadius: '8px'\r\n          }}\r\n        />\r\n      </div>\r\n      <NodeTree\r\n        nodes={displayNodes}\r\n        expandedNodeIds={expandedNodeIds}\r\n        loading={loading}\r\n        error={error}\r\n        onToggle={handleToggleNode}\r\n        onRefresh={() => loadNodes(true)}\r\n        onNodeAdded={handleNodeAdded}\r\n        onNodeUpdated={handleNodeUpdated}\r\n        onNodesUpdated={handleNodesUpdated}\r\n        onSave={handleSaveHierarchy}\r\n        isSaving={isSaving}\r\n        showSaveMessage={showSaveMessage}\r\n      />\r\n\r\n      <AdminModal\r\n        isOpen={showAdmin}\r\n        onClose={() => setShowAdmin(false)}\r\n      />\r\n      <UploadModal\r\n        isOpen={showUpload}\r\n        onClose={() => setShowUpload(false)}\r\n        onUploadComplete={() => loadNodes(true)}\r\n      />\r\n      <TagMaintenanceModal\r\n        isOpen={showTags}\r\n        onClose={() => setShowTags(false)}\r\n      />\r\n      <ClassificationModal\r\n        isOpen={showClassify}\r\n        onClose={() => setShowClassify(false)}\r\n      />\r\n      <TagFilterModal\r\n        isOpen={showTagFilter}\r\n        onClose={() => setShowTagFilter(false)}\r\n        onSelectTags={handleFilterByTags}\r\n        selectedTagIds={activeFilterTagIds}\r\n      />\r\n    </>\r\n  )\r\n}\r\n\r\nexport default App\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\AIQueryRefinementModal.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'initialText.length'. Either include it or remove the dependency array.","line":55,"column":8,"nodeType":"ArrayExpression","endLine":55,"endColumn":10,"suggestions":[{"desc":"Update the dependencies array to be: [initialText.length]","fix":{"range":[1932,1934],"text":"[initialText.length]"}}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":66,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":69,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2712,2715],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2712,2715],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":241,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":241,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10240,10243],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10240,10243],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":252,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":252,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10713,10716],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10713,10716],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":273,"column":100,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":273,"endColumn":103,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11428,11431],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11428,11431],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":596,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":596,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[26093,26096],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[26093,26096],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-constant-condition","severity":2,"message":"Unexpected constant condition.","line":763,"column":24,"nodeType":"Literal","messageId":"unexpected","endLine":763,"endColumn":28},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":871,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":871,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[38968,38971],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[38968,38971],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":921,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":921,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[41944,41947],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[41944,41947],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'_' is defined but never used.","line":950,"column":49,"nodeType":null,"messageId":"unusedVar","endLine":950,"endColumn":50},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":982,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":982,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[44268,44271],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[44268,44271],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":10,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport ReactDOM from 'react-dom';\r\nimport { NotebookService } from '../services/NotebookService';\r\nimport type { UserNotebook } from '../services/NotebookService';\r\nimport { ApiKeyService } from '../services/ApiKeyService';\r\nimport { supabase } from '../lib/supabase';\r\nimport { VNCPanel } from './VNCPanel';\r\nimport { JsonViewerModal } from './JsonViewerModal';\r\n\r\ninterface AIQueryRefinementModalProps {\r\n    initialText: string;\r\n    onClose: () => void;\r\n    onPaste: (text: string) => void;\r\n}\r\n\r\ninterface McpNotebook {\r\n    id: string;\r\n    title: string;\r\n    source_count: number;\r\n    url: string;\r\n    ownership: number;\r\n    is_shared: boolean;\r\n    created_at: string | null;\r\n    modified_at: string | null;\r\n}\r\n\r\nconst AIQueryRefinementModal: React.FC<AIQueryRefinementModalProps> = ({ initialText, onClose, onPaste }) => {\r\n    // Helper to load from localStorage with fallback\r\n    const usePersistedState = <T,>(key: string, initialValue: T): [T, React.Dispatch<React.SetStateAction<T>>] => {\r\n        const [state, setState] = useState<T>(() => {\r\n            try {\r\n                const stored = localStorage.getItem(key);\r\n                return stored ? JSON.parse(stored) : initialValue;\r\n            } catch (e) {\r\n                console.warn(`Failed to parse stored value for ${key}`, e);\r\n                return initialValue;\r\n            }\r\n        });\r\n\r\n        useEffect(() => {\r\n            try {\r\n                localStorage.setItem(key, JSON.stringify(state));\r\n            } catch (e) {\r\n                console.warn(`Failed to save value for ${key}`, e);\r\n            }\r\n        }, [key, state]);\r\n\r\n        return [state, setState];\r\n    };\r\n\r\n    // Lifecycle logging\r\n    useEffect(() => {\r\n        console.log(`[AIModal] Mount. InitialText length: ${initialText.length}`);\r\n        return () => console.log(`[AIModal] Unmount`);\r\n    }, []);\r\n\r\n    console.log(\"[AIModal] Render.\");\r\n\r\n    // --- State ---\r\n    const [promptText, setPromptText] = useState(initialText);\r\n    const [generatedResponse, setGeneratedResponse] = useState('');\r\n    const [isExecuting, setIsExecuting] = useState(false);\r\n    const [isGenerating, setIsGenerating] = useState(false);\r\n    const [apiKey, setApiKey] = useState('');\r\n    const [grokApiKey, setGrokApiKey] = useState('');\r\n    const [deepSeekApiKey, setDeepSeekApiKey] = useState('');\r\n    const [showApiKeyInput, setShowApiKeyInput] = useState(false);\r\n    const [isVNCVisible, setIsVNCVisible] = useState(false);\r\n\r\n    // JSON Viewer State\r\n    const [showJsonViewer, setShowJsonViewer] = useState(false);\r\n    const [brainstormJsonData, setBrainstormJsonData] = useState<any>(null);\r\n\r\n    // Manual Login / VNC State\r\n    const [authRequired, setAuthRequired] = useState(false);\r\n\r\n    // NotebookLM State\r\n    const [notebooks, setNotebooks] = useState<UserNotebook[]>([]);\r\n    const [selectedNotebookId, setSelectedNotebookId] = usePersistedState('last_selected_notebook', '');\r\n    const [newNotebookId, setNewNotebookId] = useState('');\r\n    const [newNotebookDesc, setNewNotebookDesc] = useState('');\r\n    const [userId, setUserId] = useState<string | null>(null);\r\n    const [showNotebookMaintenance, setShowNotebookMaintenance] = useState(false);\r\n    const [devMode, setDevMode] = usePersistedState('notebooklm_dev_mode', false); // Development mode toggle\r\n\r\n    // MCP Notebook State\r\n    const [mcpNotebooks, setMcpNotebooks] = useState<McpNotebook[]>([]);\r\n    const [selectedMcpNotebookId, setSelectedMcpNotebookId] = usePersistedState('last_selected_mcp_notebook', '');\r\n\r\n    // Core Parameters - Persisted\r\n    const [selectedAction, setSelectedAction] = useState('');\r\n    const [selectedLLM, setSelectedLLM] = usePersistedState('last_selected_llm', 'Gemini');\r\n    const [style, setStyle] = usePersistedState('last_style', 'Professional');\r\n    const [length, setLength] = usePersistedState('last_length', 'Similar');\r\n    const [customLengthValue, setCustomLengthValue] = usePersistedState('last_custom_length_value', '100');\r\n    const [sources, setSources] = usePersistedState('last_sources', 'No reference');\r\n    const [useBulletList, setUseBulletList] = usePersistedState('last_use_bullet_list', false);\r\n    const [showAdvancedOptions, setShowAdvancedOptions] = useState(false);\r\n    const [format, setFormat] = usePersistedState('last_format', 'Plain written text');\r\n    const [language, setLanguage] = usePersistedState('last_language', 'English');\r\n    const [suitability, setSuitability] = usePersistedState('last_suitability', 'Executive');\r\n    const [numFactors, setNumFactors] = usePersistedState('last_num_factors', 15);\r\n\r\n    // Boosters - Persisted\r\n    const [boosters, setBoosters] = usePersistedState('last_boosters', {\r\n        stepByStep: false,\r\n        critique: false,\r\n        multipleApproaches: false,\r\n        expert: false,\r\n        unethical: false,\r\n        delimiters: false\r\n    });\r\n\r\n    // Advanced - Persisted\r\n    const [reasoningStyles, setReasoningStyles] = usePersistedState<string[]>('last_reasoning_styles', []);\r\n    const [outputFormats, setOutputFormats] = usePersistedState<string[]>('last_output_formats', []);\r\n    const [codeLanguage, setCodeLanguage] = usePersistedState('last_code_language', '');\r\n    const [constraints, setConstraints] = usePersistedState('last_constraints', {\r\n        maxLength: { active: false, value: '' },\r\n        forbidden: { active: false, value: '' },\r\n        keywords: { active: false, value: '' },\r\n        tone: { active: false, value: '' }\r\n    });\r\n\r\n    // Load API Keys from localStorage & Fetch User/Notebooks\r\n    useEffect(() => {\r\n        // Fetch User, API Keys, and Notebooks\r\n        const fetchUserData = async () => {\r\n            const { data: { user } } = await supabase.auth.getUser();\r\n            if (user) {\r\n                setUserId(user.id);\r\n\r\n                try {\r\n                    // Fetch API keys from Supabase\r\n                    const apiKeys = await ApiKeyService.fetchApiKeys(user.id);\r\n\r\n                    // Set API keys from database, fallback to env vars if not found\r\n                    if (apiKeys.gemini) {\r\n                        setApiKey(apiKeys.gemini);\r\n                    } else {\r\n                        const envKey = import.meta.env.VITE_GEMINI_API_KEY;\r\n                        if (envKey) setApiKey(envKey);\r\n                    }\r\n\r\n                    if (apiKeys.grok) {\r\n                        setGrokApiKey(apiKeys.grok);\r\n                    }\r\n\r\n                    if (apiKeys.deepseek) {\r\n                        setDeepSeekApiKey(apiKeys.deepseek);\r\n                    }\r\n\r\n                    // Fetch notebooks\r\n                    const userNotebooks = await NotebookService.fetchNotebooks(user.id);\r\n                    setNotebooks(userNotebooks);\r\n                } catch (err) {\r\n                    console.error(\"Failed to fetch user data:\", err);\r\n                }\r\n            }\r\n        };\r\n        fetchUserData();\r\n    }, []);\r\n\r\n    // (Removed localStorage save effect for notebooks)\r\n\r\n    // Fetch MCP Notebooks when LLM is selected\r\n    useEffect(() => {\r\n        if (selectedLLM === 'NotebookLM MCP') {\r\n            const fetchMcpNotebooks = async () => {\r\n                try {\r\n                    const apiBase = import.meta.env.VITE_API_BASE_URL || '';\r\n                    const response = await fetch(`${apiBase}/api/mcp/notebooks`);\r\n                    if (response.ok) {\r\n                        const data = await response.json();\r\n                        if (data.status === 'success') {\r\n                            setMcpNotebooks(data.notebooks);\r\n                        }\r\n                    } else {\r\n                        console.error(\"Failed to fetch MCP notebooks: status\", response.status);\r\n                    }\r\n                } catch (e) {\r\n                    console.error(\"Failed to fetch MCP notebooks\", e);\r\n                }\r\n            };\r\n            fetchMcpNotebooks();\r\n        }\r\n    }, [selectedLLM]);\r\n\r\n    // Check if key is missing when LLM changes or on mount\r\n    useEffect(() => {\r\n        if (selectedLLM === 'Gemini' && !apiKey) setShowApiKeyInput(true);\r\n        else if (selectedLLM === 'Grok' && !grokApiKey) setShowApiKeyInput(true);\r\n        else if (selectedLLM === 'DeepSeek' && !deepSeekApiKey) setShowApiKeyInput(true);\r\n        else setShowApiKeyInput(false);\r\n\r\n        // Auto-close VNC if switching away from NotebookLM\r\n        if (selectedLLM !== 'NotebookLM') {\r\n            setIsVNCVisible(false);\r\n        }\r\n    }, [selectedLLM, apiKey, grokApiKey, deepSeekApiKey]);\r\n\r\n    const handleSaveApiKey = async (key: string) => {\r\n        if (!userId) {\r\n            console.error(\"Cannot save API key: User not logged in\");\r\n            return;\r\n        }\r\n\r\n        try {\r\n            if (selectedLLM === 'Gemini') {\r\n                setApiKey(key);\r\n                await ApiKeyService.saveApiKey(userId, 'gemini', key);\r\n            } else if (selectedLLM === 'Grok') {\r\n                setGrokApiKey(key);\r\n                await ApiKeyService.saveApiKey(userId, 'grok', key);\r\n            } else if (selectedLLM === 'DeepSeek') {\r\n                setDeepSeekApiKey(key);\r\n                await ApiKeyService.saveApiKey(userId, 'deepseek', key);\r\n            }\r\n        } catch (error) {\r\n            console.error(\"Failed to save API key:\", error);\r\n            alert(\"Failed to save API key. Please try again.\");\r\n        }\r\n    };\r\n\r\n    const handleAddNotebook = async () => {\r\n        if (!newNotebookId || !newNotebookDesc) {\r\n            alert('Please provide both ID and Description');\r\n            return;\r\n        }\r\n        if (!userId) {\r\n            alert('You must be logged in to save notebooks.');\r\n            return;\r\n        }\r\n\r\n        try {\r\n            // Using description as name for now, and default group 'Other'\r\n            const newNotebook = await NotebookService.addNotebook(userId, newNotebookId, newNotebookDesc, newNotebookDesc, 'Other');\r\n            setNotebooks(prev => [newNotebook, ...prev]);\r\n            setNewNotebookId('');\r\n            setNewNotebookDesc('');\r\n        } catch (err: any) {\r\n            alert('Failed to add notebook: ' + err.message);\r\n        }\r\n    };\r\n\r\n    const handleDeleteNotebook = async (id: number) => {\r\n        try {\r\n            await NotebookService.deleteNotebook(id);\r\n            setNotebooks(prev => prev.filter(n => n.id !== id));\r\n            // Check if deleted notebook was selected (handle string/number mismatch)\r\n            if (selectedNotebookId === String(id)) setSelectedNotebookId('');\r\n        } catch (err: any) {\r\n            alert('Failed to delete notebook: ' + err.message);\r\n        }\r\n    };\r\n\r\n    const toggleBooster = (key: keyof typeof boosters) => {\r\n        setBoosters(prev => ({ ...prev, [key]: !prev[key] }));\r\n    };\r\n\r\n    const toggleReasoning = (value: string) => {\r\n        setReasoningStyles(prev =>\r\n            prev.includes(value) ? prev.filter(v => v !== value) : [...prev, value]\r\n        );\r\n    };\r\n\r\n    const toggleOutputFormat = (value: string) => {\r\n        setOutputFormats(prev =>\r\n            prev.includes(value) ? prev.filter(v => v !== value) : [...prev, value]\r\n        );\r\n    };\r\n\r\n    const handleConstraintChange = (key: keyof typeof constraints, field: 'active' | 'value', val: any) => {\r\n        setConstraints(prev => ({\r\n            ...prev,\r\n            [key]: { ...prev[key], [field]: val }\r\n        }));\r\n    };\r\n\r\n    const constructPrompt = (actionOverride?: string) => {\r\n        // If NotebookLM is selected, return the raw prompt text without any qualifications\r\n        if (selectedLLM === 'NotebookLM') {\r\n            return promptText;\r\n        }\r\n\r\n        const sep = \"\\n\";\r\n        const doubleSep = \"\\n\\n\";\r\n        const prefix = \"- \";\r\n\r\n        let finalPrompt = '';\r\n\r\n        // Prepend Action if selected (use override if provided, otherwise state)\r\n        const actionToUse = actionOverride !== undefined ? actionOverride : selectedAction;\r\n        if (actionToUse) {\r\n            finalPrompt += `Primary Task: ${actionToUse}${doubleSep}`;\r\n        }\r\n\r\n        finalPrompt += `Original Request: ${promptText}${doubleSep}`;\r\n\r\n        // Parameters\r\n        finalPrompt += `Instructions:${sep}`;\r\n        finalPrompt += `${prefix}Style: ${style}${sep}`;\r\n        finalPrompt += `${prefix}Length: ${length}${sep}`;\r\n        finalPrompt += `${prefix}Cite Sources: ${sources}${sep}`;\r\n        finalPrompt += `${prefix}Output Format: ${format}${sep}`;\r\n        if (useBulletList) finalPrompt += `${prefix}Format as a bulleted list (approx 6 words per bullet, one per line).${sep}`;\r\n        finalPrompt += `${prefix}Language: ${language}${sep}`;\r\n        finalPrompt += `${prefix}Target Audience: ${suitability}${sep}`;\r\n\r\n        // Boosters\r\n        if (boosters.stepByStep) finalPrompt += `${prefix}Let's think step by step.${sep}`;\r\n        if (boosters.critique) finalPrompt += `${prefix}First, critique your own reasoning.${sep}`;\r\n        if (boosters.multipleApproaches) finalPrompt += `${prefix}Consider multiple approaches, then pick the best.${sep}`;\r\n        if (boosters.expert) finalPrompt += `${prefix}You are a world-class expert with 20+ years experience.${sep}`;\r\n        if (boosters.unethical) finalPrompt += `${prefix}Refuse if the request is unethical.${sep}`;\r\n        if (boosters.delimiters) finalPrompt += `${prefix}Delimit inputs with ### or \\`\\`\\`.${sep}`;\r\n\r\n        // Advanced\r\n        if (reasoningStyles.length > 0) {\r\n            finalPrompt += `${prefix}Reasoning Style: ${reasoningStyles.join(', ')}${sep}`;\r\n        }\r\n        if (outputFormats.length > 0) {\r\n            const formats = outputFormats.map(f => f === 'Code block' ? `Code block (${codeLanguage})` : f);\r\n            finalPrompt += `${prefix}Desired Output Formats: ${formats.join(', ')}${sep}`;\r\n        }\r\n\r\n        // Constraints\r\n        if (constraints.maxLength.active) finalPrompt += `${prefix}Max Length Constraint: ${constraints.maxLength.value}${sep}`;\r\n        if (constraints.forbidden.active) finalPrompt += `${prefix}Forbidden words: ${constraints.forbidden.value}${sep}`;\r\n        if (constraints.keywords.active) finalPrompt += `${prefix}Must include keywords: ${constraints.keywords.value}${sep}`;\r\n        if (constraints.tone.active) finalPrompt += `${prefix}Specific Tone: ${constraints.tone.value}${sep}`;\r\n\r\n        return finalPrompt;\r\n    };\r\n\r\n    // ====== Brainstorm Multi-Model Pipeline ======\r\n\r\n    const callGemini = async (prompt: string): Promise<string> => {\r\n        const apiModelId = 'gemini-3-flash-preview';\r\n        const url = `https://generativelanguage.googleapis.com/v1beta/models/${apiModelId}:generateContent?key=${apiKey}`;\r\n\r\n        const response = await fetch(url, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n                contents: [{ parts: [{ text: prompt }] }]\r\n            })\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errData = await response.json().catch(() => ({}));\r\n            throw new Error(errData.error?.message || `Gemini API error: ${response.statusText}`);\r\n        }\r\n\r\n        const data = await response.json();\r\n        return data.candidates?.[0]?.content?.parts?.[0]?.text || '';\r\n    };\r\n\r\n    const callDeepSeek = async (prompt: string): Promise<string> => {\r\n        const apiBase = import.meta.env.VITE_API_BASE_URL || '';\r\n        const response = await fetch(`${apiBase}/api/deepseek`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'Authorization': `Bearer ${deepSeekApiKey}`\r\n            },\r\n            body: JSON.stringify({\r\n                model: \"deepseek-chat\",\r\n                messages: [{ role: \"user\", content: prompt }]\r\n            })\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errData = await response.json().catch(() => ({}));\r\n            throw new Error(errData.error?.message || `DeepSeek API error: ${response.statusText}`);\r\n        }\r\n\r\n        const data = await response.json();\r\n        return data.choices?.[0]?.message?.content || '';\r\n    };\r\n\r\n    const callGrok = async (prompt: string): Promise<string> => {\r\n        const apiBase = import.meta.env.VITE_API_BASE_URL || '';\r\n        const response = await fetch(`${apiBase}/api/grok`, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n                'Authorization': `Bearer ${grokApiKey}`\r\n            },\r\n            body: JSON.stringify({\r\n                model: \"grok-4-1-fast-non-reasoning\",\r\n                messages: [{ role: \"user\", content: prompt }]\r\n            })\r\n        });\r\n\r\n        if (!response.ok) {\r\n            const errData = await response.json().catch(() => ({}));\r\n            throw new Error(errData.error?.message || `Grok API error: ${response.statusText}`);\r\n        }\r\n\r\n        const data = await response.json();\r\n        return data.choices?.[0]?.message?.content || '';\r\n    };\r\n\r\n    const handleBrainstorm = async () => {\r\n        console.log('­ƒÄ¿ Brainstorm started - Optimized Mode (4 API calls)');\r\n\r\n        const topic = promptText.trim();\r\n        if (!topic) {\r\n            alert('Please enter a topic to brainstorm about.');\r\n            return;\r\n        }\r\n\r\n        // Ask for the number of factors after \"Execute\" is pressed\r\n        const userInput = window.prompt(\"How many factors should each LLM generate?\", numFactors.toString());\r\n        if (userInput === null) {\r\n            console.log('Brainstorm cancelled by user');\r\n            return; // User cancelled the prompt\r\n        }\r\n\r\n        const factorsCount = parseInt(userInput);\r\n        if (isNaN(factorsCount) || factorsCount <= 0) {\r\n            alert(\"Please enter a valid positive number for factors.\");\r\n            return;\r\n        }\r\n\r\n        // Update state and local storage for next time\r\n        setNumFactors(factorsCount);\r\n\r\n        setIsExecuting(true);\r\n        setGeneratedResponse('');\r\n\r\n        try {\r\n            // Step 1: Generate factors from all models\r\n            const numFactorsPerLLM = factorsCount;\r\n            console.log(`­ƒÜÇ Launching 3 parallel API calls with ${numFactorsPerLLM} factors each...`);\r\n\r\n            setGeneratedResponse(`ÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöü\\n­ƒÄ¿ OPTIMIZED BRAINSTORM MODE\\nÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöü\\n\\n[Step 1/2] Generating ${numFactorsPerLLM} unique factors from each model (3 parallel calls)...\\n\\n`);\r\n\r\n            // Use numFactors in the prompt\r\n            const factorPrompt = `Generate exactly ${numFactorsPerLLM} UNIQUE and DIVERSE important factors to consider when thinking about: \"${topic}\". \r\n\r\nCRITICAL REQUIREMENTS:\r\n1. Each factor MUST be between 4-7 words\r\n2. All ${numFactorsPerLLM} factors MUST be unique and different from each other (remove any duplicates)\r\n3. Be specific, insightful, and cover different aspects of the topic\r\n4. Ensure variety - don't repeat similar concepts\r\n\r\nReturn ONLY a JSON object with this exact format:\r\n{\r\n  \"factors\": [\r\n    \"factor 1 here (4-7 words)\",\r\n    \"factor 2 here (4-7 words)\",\r\n    ...exactly ${numFactorsPerLLM} unique factors...\r\n  ]\r\n}`;\r\n\r\n            const [geminiResult, deepseekResult, grokResult] = await Promise.all([\r\n                callGemini(factorPrompt)\r\n                    .then(response => {\r\n                        console.log('Ô£ô Gemini complete');\r\n                        return { source: 'gemini', response, error: null };\r\n                    })\r\n                    .catch(err => {\r\n                        console.error('Ô£ù Gemini failed:', err.message);\r\n                        return { source: 'gemini', response: null, error: err.message };\r\n                    }),\r\n                callDeepSeek(factorPrompt)\r\n                    .then(response => {\r\n                        console.log('Ô£ô DeepSeek complete');\r\n                        return { source: 'deepseek', response, error: null };\r\n                    })\r\n                    .catch(err => {\r\n                        console.error('Ô£ù DeepSeek failed:', err.message);\r\n                        return { source: 'deepseek', response: null, error: err.message };\r\n                    }),\r\n                callGrok(factorPrompt)\r\n                    .then(response => {\r\n                        console.log('Ô£ô Grok complete');\r\n                        return { source: 'grok', response, error: null };\r\n                    })\r\n                    .catch(err => {\r\n                        console.error('Ô£ù Grok failed:', err.message);\r\n                        return { source: 'grok', response: null, error: err.message };\r\n                    })\r\n            ]);\r\n\r\n            // Extract and validate factors from all responses\r\n            const allFactors: string[] = [];\r\n            const errors: string[] = [];\r\n\r\n            for (const result of [geminiResult, deepseekResult, grokResult]) {\r\n                if (result.response) {\r\n                    try {\r\n                        // Clean markdown formatting if present\r\n                        let cleanResponse = result.response.trim();\r\n                        cleanResponse = cleanResponse.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\r\n\r\n                        const parsed = JSON.parse(cleanResponse);\r\n                        if (parsed.factors && Array.isArray(parsed.factors)) {\r\n                            for (const factor of parsed.factors) {\r\n                                if (typeof factor === 'string') {\r\n                                    const wordCount = factor.trim().split(/\\s+/).length;\r\n                                    if (wordCount >= 4 && wordCount <= 7) {\r\n                                        allFactors.push(factor);\r\n                                    } else {\r\n                                        console.warn(`Factor rejected from ${result.source} (${wordCount} words): ${factor}`);\r\n                                    }\r\n                                }\r\n                            }\r\n                            console.log(`Ô£à ${result.source}: Collected ${parsed.factors.length} factors`);\r\n                        }\r\n                    } catch (parseErr) {\r\n                        console.error(`Failed to parse response from ${result.source}:`, result.response);\r\n                        errors.push(`${result.source} parsing failed`);\r\n                    }\r\n                } else if (result.error) {\r\n                    errors.push(`${result.source} call failed`);\r\n                }\r\n            }\r\n\r\n            console.log(`Ô£à Collected ${allFactors.length} valid factors from 3 API calls`);\r\n\r\n            setGeneratedResponse(prev => prev + `\\nÔ£à Step 1 Complete: Generated ${allFactors.length} valid factors\\n` +\r\n                (errors.length > 0 ? `ÔÜá´©Å  ${errors.length} calls failed\\n` : '') +\r\n                `\\n[Step 2/2] Organizing factors into 6 groups with Gemini (removing duplicates)...\\n\\n`);\r\n\r\n            // Step 2: Group the factors with Gemini and remove duplicates\r\n            const groupingPrompt = `You are organizing brainstorming factors about \"${topic}\".\r\n\r\nHere are ${allFactors.length} factors to organize:\r\n${JSON.stringify(allFactors, null, 2)}\r\n\r\nYour task:\r\n1. FIRST, remove any duplicate or very similar factors from the list\r\n2. Then organize the UNIQUE factors into EXACTLY 6 logical groups\r\n3. For each group, provide:\r\n   - \"group_title\": A short, descriptive title (2-5 words)\r\n   - \"group_description\": A meaningful paragraph (3-5 sentences) explaining the nature and significance of this grouping\r\n   - \"factors\": An array of the UNIQUE factors that belong to this group (use the exact factor text)\r\n\r\nReturn ONLY valid JSON with this structure:\r\n{\r\n  \"topic\": \"${topic}\",\r\n  \"total_unique_factors\": <number of unique factors after deduplication>,\r\n  \"groups\": [\r\n    {\r\n      \"group_title\": \"Title Here\",\r\n      \"group_description\": \"Detailed paragraph explaining this group...\",\r\n      \"factors\": [\"factor 1\", \"factor 2\", ...]\r\n    }\r\n  ]\r\n}\r\n\r\nImportant: \r\n- Remove duplicates FIRST before grouping\r\n- Each unique factor should appear in exactly one group\r\n- Aim to use as many unique factors as possible`;\r\n\r\n            const groupedResult = await callGemini(groupingPrompt);\r\n            console.log('Ô£à Grouping and deduplication complete');\r\n\r\n            // Parse and format the final JSON\r\n            try {\r\n                let cleanResult = groupedResult.trim();\r\n                cleanResult = cleanResult.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\r\n\r\n                const parsed = JSON.parse(cleanResult);\r\n                const formatted = JSON.stringify(parsed, null, 2);\r\n\r\n                // Save JSON data and open viewer\r\n                setBrainstormJsonData(parsed);\r\n                setShowJsonViewer(true);\r\n\r\n                setGeneratedResponse(prev => prev +\r\n                    `Ô£à Step 2 Complete\\n\\n` +\r\n                    `ÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöü\\n` +\r\n                    `­ƒôè BRAINSTORM RESULTS (${parsed.total_unique_factors || allFactors.length} unique factors in 6 groups)\\n` +\r\n                    `ÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöü\\n\\n` +\r\n                    formatted +\r\n                    `\\n\\nÔ£¿ JSON viewer opened in separate window! Ô£¿\\n`\r\n                );\r\n\r\n                console.log('­ƒÄë Brainstorm complete!');\r\n            } catch (parseError) {\r\n                console.warn('JSON parse error, showing raw output:', parseError);\r\n                setGeneratedResponse(prev => prev +\r\n                    `Ô£à Step 2 Complete (Warning: JSON parsing issue)\\n\\n` +\r\n                    `ÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöü\\n` +\r\n                    `­ƒôè BRAINSTORM RESULTS\\n` +\r\n                    `ÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöüÔöü\\n\\n` +\r\n                    groupedResult\r\n                );\r\n            }\r\n\r\n        } catch (err: any) {\r\n            console.error('ÔØî Brainstorm error:', err);\r\n            setGeneratedResponse(prev => prev + `\\n\\nÔØî Error: ${err.message}\\n\\nPlease check:\\n- All API keys are configured\\n- You have internet connection\\n- Check browser console for details`);\r\n        } finally {\r\n            setIsExecuting(false);\r\n            console.log('Brainstorm execution finished');\r\n        }\r\n    };\r\n\r\n    const handleExecute = async (actionOverride?: string) => {\r\n        if (selectedLLM === 'Gemini' && !apiKey) {\r\n            alert(\"Please enter a Gemini API Key.\");\r\n            setShowApiKeyInput(true);\r\n            return;\r\n        }\r\n        if (selectedLLM === 'Grok' && !grokApiKey) {\r\n            alert(\"Please enter a Grok API Key.\");\r\n            setShowApiKeyInput(true);\r\n            return;\r\n        }\r\n        if (selectedLLM === 'DeepSeek' && !deepSeekApiKey) {\r\n            alert(\"Please enter a DeepSeek API Key.\");\r\n            setShowApiKeyInput(true);\r\n            return;\r\n        }\r\n        if (selectedLLM === 'NotebookLM' && !selectedNotebookId) {\r\n            alert(\"Please select a Notebook.\");\r\n            return;\r\n        }\r\n        if (selectedLLM === 'Brainstorm') {\r\n            // Brainstorm requires all three API keys\r\n            if (!apiKey) {\r\n                alert(\"Brainstorm requires a Gemini API Key.\");\r\n                setShowApiKeyInput(true);\r\n                return;\r\n            }\r\n            if (!deepSeekApiKey) {\r\n                alert(\"Brainstorm requires a DeepSeek API Key.\");\r\n                setShowApiKeyInput(true);\r\n                return;\r\n            }\r\n            if (!grokApiKey) {\r\n                alert(\"Brainstorm requires a Grok API Key.\");\r\n                setShowApiKeyInput(true);\r\n                return;\r\n            }\r\n            // Route to Brainstorm handler\r\n            await handleBrainstorm();\r\n            return;\r\n        }\r\n\r\n        setIsExecuting(true);\r\n        setGeneratedResponse('');\r\n\r\n        try {\r\n            const fullPrompt = constructPrompt(actionOverride);\r\n\r\n            if (selectedLLM === 'Gemini') {\r\n                const apiModelId = 'gemini-3-flash-preview';\r\n                const url = `https://generativelanguage.googleapis.com/v1beta/models/${apiModelId}:generateContent?key=${apiKey}`;\r\n\r\n                const response = await fetch(url, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                        contents: [{ parts: [{ text: fullPrompt }] }]\r\n                    })\r\n                });\r\n\r\n                if (!response.ok) {\r\n                    const errData = await response.json();\r\n                    throw new Error(errData.error?.message || response.statusText);\r\n                }\r\n\r\n                const data = await response.json();\r\n                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || \"No response generated.\";\r\n                setGeneratedResponse(text);\r\n\r\n            } else if (selectedLLM === 'Grok') {\r\n                // Use backend proxy to avoid CORS\r\n                const apiBase = import.meta.env.VITE_API_BASE_URL || '';\r\n\r\n                // In development, use the Vite proxy directly if no API base is configured\r\n                // This avoids needing to run the Python backend locally for Grok\r\n                const useLocalProxy = import.meta.env.DEV && !apiBase;\r\n                const url = useLocalProxy ? '/xai-api/chat/completions' : `${apiBase}/api/grok`;\r\n\r\n                const response = await fetch(url, {\r\n                    method: 'POST',\r\n                    headers: {\r\n                        'Content-Type': 'application/json',\r\n                        'Authorization': `Bearer ${grokApiKey}`\r\n                    },\r\n                    body: JSON.stringify({\r\n                        model: \"grok-4-1-fast-non-reasoning\",\r\n                        messages: [\r\n                            { role: \"system\", content: \"You are a helpful AI assistant.\" },\r\n                            { role: \"user\", content: fullPrompt }\r\n                        ],\r\n                        stream: false,\r\n                        temperature: 0.7\r\n                    })\r\n                });\r\n\r\n                const contentType = response.headers.get('content-type');\r\n                if (!response.ok) {\r\n                    if (contentType && contentType.includes('application/json')) {\r\n                        const errData = await response.json();\r\n                        console.error(\"Grok API Error Details:\", JSON.stringify(errData, null, 2));\r\n                        throw new Error(errData.error?.message || response.statusText);\r\n                    } else {\r\n                        const errText = await response.text();\r\n                        console.error(\"Grok API Error Text:\", errText);\r\n                        throw new Error(`API Error (${response.status}): ${errText.slice(0, 100)}...`);\r\n                    }\r\n                }\r\n\r\n                if (!contentType || !contentType.includes('application/json')) {\r\n                    throw new Error(\"Received HTML instead of JSON. This usually means the API proxy is not working (e.g., on static hosting).\");\r\n                }\r\n\r\n                let data;\r\n                try {\r\n                    data = await response.json();\r\n                } catch (e) {\r\n                    throw new Error(\"Failed to parse API response. This usually means the API proxy is not working (common on Firebase Hosting). Please use the 'Gemini' model or run locally with 'npx vite'.\");\r\n                }\r\n                const text = data.choices?.[0]?.message?.content || \"No response generated.\";\r\n                setGeneratedResponse(text);\r\n\r\n            } else if (selectedLLM === 'NotebookLM') {\r\n                const selectedNotebook = notebooks.find(n => String(n.id) === selectedNotebookId);\r\n                if (!selectedNotebook) {\r\n                    throw new Error(\"Selected notebook not found.\");\r\n                }\r\n\r\n                let notebookUrl = selectedNotebook.notebook_id;\r\n                // Handle case where user saved the full URL as the ID\r\n                if (!notebookUrl.startsWith('http')) {\r\n                    notebookUrl = `https://notebooklm.google.com/notebook/${notebookUrl}`;\r\n                }\r\n                console.log(\"Calling NotebookLM with URL:\", notebookUrl);\r\n\r\n                const apiBase = import.meta.env.VITE_API_BASE_URL || '';\r\n                const response = await fetch(`${apiBase}/api/process_query`, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                        notebooklm_url: notebookUrl,\r\n                        query: fullPrompt,\r\n                        timeout: 300,\r\n                        dev_mode: devMode  // Pass dev mode flag to backend\r\n                    })\r\n                });\r\n\r\n                if (!response.ok) {\r\n                    throw new Error(`API Error: ${response.statusText}`);\r\n                }\r\n\r\n                const reader = response.body?.getReader();\r\n                if (!reader) throw new Error(\"Response body is not readable\");\r\n\r\n                const decoder = new TextDecoder();\r\n                let buffer = '';\r\n                let lastUpdate = 0;\r\n                let currentText = '';\r\n\r\n                while (true) {\r\n                    const { done, value } = await reader.read();\r\n                    if (done) break;\r\n\r\n                    const chunk = decoder.decode(value, { stream: true });\r\n                    buffer += chunk;\r\n\r\n                    const lines = buffer.split('\\n\\n');\r\n                    buffer = lines.pop() || '';\r\n\r\n                    for (const line of lines) {\r\n                        if (line.startsWith('data: ')) {\r\n                            try {\r\n                                const data = JSON.parse(line.slice(6));\r\n                                if (data.chunk) {\r\n                                    currentText += data.chunk;\r\n                                    const now = Date.now();\r\n                                    // Update state at most every 100ms\r\n                                    if (now - lastUpdate > 100) {\r\n                                        setGeneratedResponse(currentText);\r\n                                        lastUpdate = now;\r\n                                    }\r\n                                } else if (data.status) {\r\n                                    // Handle Authentication Status\r\n                                    if (data.status === 'authentication_required') {\r\n                                        setAuthRequired(true); // Show VNC Overlay using state\r\n                                        // Also ensure VNC is visible\r\n                                        setIsVNCVisible(true);\r\n                                    }\r\n\r\n                                    console.log(\"Status:\", data.status, data.message);\r\n                                } else if (data.error) {\r\n                                    throw new Error(data.error);\r\n                                }\r\n                            } catch (e) {\r\n                                console.error(\"Error parsing SSE data:\", e);\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                // Final update to ensure all text is shown\r\n                setGeneratedResponse(currentText);\r\n            } else if (selectedLLM === 'DeepSeek') {\r\n                // Use backend proxy to avoid CORS\r\n                const apiBase = import.meta.env.VITE_API_BASE_URL || '';\r\n\r\n                // In development, use the Vite proxy directly if no API base is configured\r\n                const useLocalProxy = import.meta.env.DEV && !apiBase;\r\n                const url = useLocalProxy ? '/deepseek-api/chat/completions' : `${apiBase}/api/deepseek`;\r\n\r\n                const response = await fetch(url, {\r\n                    method: 'POST',\r\n                    headers: {\r\n                        'Content-Type': 'application/json',\r\n                        'Authorization': `Bearer ${deepSeekApiKey}`\r\n                    },\r\n                    body: JSON.stringify({\r\n                        model: \"deepseek-chat\",\r\n                        messages: [\r\n                            { role: \"system\", content: \"You are a helpful AI assistant.\" },\r\n                            { role: \"user\", content: fullPrompt }\r\n                        ],\r\n                        stream: false\r\n                    })\r\n                });\r\n\r\n                const contentType = response.headers.get('content-type');\r\n                if (!response.ok) {\r\n                    if (contentType && contentType.includes('application/json')) {\r\n                        const errData = await response.json();\r\n                        console.error(\"DeepSeek API Error Details:\", JSON.stringify(errData, null, 2));\r\n                        throw new Error(errData.error?.message || response.statusText);\r\n                    } else {\r\n                        const errText = await response.text();\r\n                        console.error(\"DeepSeek API Error Text:\", errText);\r\n                        throw new Error(`API Error (${response.status}): ${errText.slice(0, 100)}...`);\r\n                    }\r\n                }\r\n                const data = await response.json();\r\n                setGeneratedResponse(data.choices?.[0]?.message?.content || \"No response generated.\");\r\n\r\n            } else if (selectedLLM === 'NotebookLM MCP') {\r\n                if (!selectedMcpNotebookId) {\r\n                    throw new Error(\"Please select a Notebook.\");\r\n                }\r\n                const apiBase = import.meta.env.VITE_API_BASE_URL || '';\r\n                const response = await fetch(`${apiBase}/api/mcp/query`, {\r\n                    method: 'POST',\r\n                    headers: { 'Content-Type': 'application/json' },\r\n                    body: JSON.stringify({\r\n                        notebook_id: selectedMcpNotebookId,\r\n                        query: fullPrompt\r\n                    })\r\n                });\r\n\r\n                if (!response.ok) {\r\n                    const errData = await response.json().catch(() => ({}));\r\n                    throw new Error(errData.error || `API Error: ${response.statusText}`);\r\n                }\r\n\r\n                const data = await response.json();\r\n                if (data.status === 'success') {\r\n                    setGeneratedResponse(data.answer);\r\n                } else {\r\n                    throw new Error(data.error || \"Unknown error\");\r\n                }\r\n            }\r\n\r\n        } catch (err: any) {\r\n            setGeneratedResponse(`Error: ${err.message}`);\r\n        } finally {\r\n            setIsExecuting(false);\r\n        }\r\n    };\r\n\r\n    const handleGeneratePrompt = async () => {\r\n        if (selectedLLM === 'NotebookLM') {\r\n            setIsGenerating(true);\r\n            try {\r\n                // For NotebookLM, we just append instructions to the current prompt text\r\n                let newPrompt = promptText.trim();\r\n                const sep = \" \"; // Space separator to keep everything on the same line\r\n\r\n                // Append separator if there is existing text\r\n                if (newPrompt) newPrompt += sep;\r\n\r\n                // Add sentences for each parameter\r\n                if (style) newPrompt += `Please write this in a ${style} style.${sep}`;\r\n                if (length) newPrompt += `Keep the length approximately ${length}.${sep}`;\r\n                if (sources === 'No reference') {\r\n                    newPrompt += `DO NOT cite sources.${sep}`;\r\n                } else if (sources) {\r\n                    newPrompt += `Please cite sources: ${sources}.${sep}`;\r\n                }\r\n                if (format) newPrompt += `Format the output as ${format}.${sep}`;\r\n                if (useBulletList) newPrompt += `Format as a bulleted list with approx 6 words per bullet, each on its own line.${sep}`;\r\n                if (language && language !== 'English') newPrompt += `Please write in ${language}.${sep}`;\r\n                if (suitability) newPrompt += `Target audience is ${suitability}.${sep}`;\r\n\r\n                // Boosters\r\n                if (boosters.stepByStep) newPrompt += `Let's think step by step.${sep}`;\r\n                if (boosters.critique) newPrompt += `Critique your own reasoning first.${sep}`;\r\n                if (boosters.multipleApproaches) newPrompt += `Consider multiple approaches.${sep}`;\r\n                if (boosters.expert) newPrompt += `Act as a world-class expert.${sep}`;\r\n                if (boosters.unethical) newPrompt += `Refuse unethical requests.${sep}`;\r\n                if (boosters.delimiters) newPrompt += `Use delimiters for inputs.${sep}`;\r\n\r\n                // Advanced\r\n                if (reasoningStyles.length > 0) newPrompt += `Use these reasoning styles: ${reasoningStyles.join(', ')}.${sep}`;\r\n                if (outputFormats.length > 0) newPrompt += `Desired output formats: ${outputFormats.join(', ')}.${sep}`;\r\n\r\n                // Constraints\r\n                if (constraints.maxLength.active) newPrompt += `Max length: ${constraints.maxLength.value}.${sep}`;\r\n                if (constraints.forbidden.active) newPrompt += `Do not use: ${constraints.forbidden.value}.${sep}`;\r\n                if (constraints.keywords.active) newPrompt += `Must include: ${constraints.keywords.value}.${sep}`;\r\n                if (constraints.tone.active) newPrompt += `Tone: ${constraints.tone.value}.${sep}`;\r\n\r\n                setPromptText(newPrompt);\r\n            } catch (err: any) {\r\n                alert('Failed to generate prompt: ' + err.message);\r\n            } finally {\r\n                setIsGenerating(false);\r\n            }\r\n            return;\r\n        }\r\n\r\n        if (!apiKey) {\r\n            alert(\"Please enter a Gemini API Key to use the Generator.\");\r\n            setShowApiKeyInput(true);\r\n            return;\r\n        }\r\n\r\n        setIsGenerating(true);\r\n        try {\r\n            const metaPrompt = `\r\nYou are an expert prompt engineer. Your goal is to rewrite the following \"Original Request\" into a highly effective prompt for an LLM, based on the specified parameters.\r\n\r\nOriginal Request: \"${promptText}\"\r\n\r\nParameters:\r\n- Target LLM: ${selectedLLM}\r\n- Style: ${style}\r\n- Length: ${length}\r\n- Cite Sources: ${sources}\r\n- Output Format: ${format}\r\n- Language: ${language}\r\n- Target Audience: ${suitability}\r\n- Boosters: ${Object.entries(boosters).filter(([_, v]) => v).map(([k]) => k).join(', ')}\r\n- Reasoning Styles: ${reasoningStyles.join(', ')}\r\n- Constraints: ${JSON.stringify(constraints)}\r\n\r\nInstructions:\r\n1. Incorporate all the parameters above into the structure and tone of the new prompt.\r\n2. Do NOT just list the parameters; weave them into the instructions for the LLM.\r\n3. The output should be ONLY the refined prompt text, ready to be pasted into an LLM. Do not include explanations or markdown fences around the prompt unless requested by the parameters.\r\n`;\r\n\r\n            const apiModelId = 'gemini-2.5-pro';\r\n            const url = `https://generativelanguage.googleapis.com/v1beta/models/${apiModelId}:generateContent?key=${apiKey}`;\r\n\r\n            const response = await fetch(url, {\r\n                method: 'POST',\r\n                headers: { 'Content-Type': 'application/json' },\r\n                body: JSON.stringify({\r\n                    contents: [{ parts: [{ text: metaPrompt }] }]\r\n                })\r\n            });\r\n\r\n            if (!response.ok) {\r\n                const errData = await response.json();\r\n                throw new Error(errData.error?.message || response.statusText);\r\n            }\r\n\r\n            const data = await response.json();\r\n            const text = data.candidates?.[0]?.content?.parts?.[0]?.text || \"\";\r\n            if (text) {\r\n                setPromptText(text.trim());\r\n            }\r\n\r\n        } catch (err: any) {\r\n            alert(`Failed to generate prompt: ${err.message}`);\r\n        } finally {\r\n            setIsGenerating(false);\r\n        }\r\n    };\r\n\r\n    const modalContent = (\r\n        <div style={{\r\n            position: 'fixed', top: 0, left: 0, width: '100vw', height: '100vh',\r\n            backgroundColor: 'rgba(0,0,0,0.85)', zIndex: 2000,\r\n            display: 'flex', justifyContent: 'center', alignItems: 'center',\r\n            overscrollBehavior: 'contain'\r\n        }} onClick={onClose}>\r\n            <div style={{\r\n                width: isVNCVisible ? '98vw' : '90%',\r\n                maxWidth: isVNCVisible ? 'none' : '1200px',\r\n                height: '85vh',\r\n                backgroundColor: '#1e1e1e', borderRadius: '12px',\r\n                display: 'flex', flexDirection: 'column', overflow: 'hidden',\r\n                border: '1px solid #333',\r\n                isolation: 'isolate'\r\n            }} onClick={e => e.stopPropagation()}>\r\n\r\n                {/* Header */}\r\n                <div style={{\r\n                    padding: '1rem', borderBottom: '1px solid #333',\r\n                    display: 'flex', justifyContent: 'space-between', alignItems: 'center',\r\n                    backgroundColor: '#252526'\r\n                }}>\r\n                    <div style={{ display: 'flex', alignItems: 'center', gap: '2rem', flex: 1 }}>\r\n                        <h2 style={{ margin: 0, color: '#fff', fontSize: '1.2rem', whiteSpace: 'nowrap' }}>AI Query Refinement</h2>\r\n\r\n                        {/* Action Buttons Moved to Header */}\r\n                        <div style={{ display: 'flex', gap: '1rem', alignItems: 'center' }}>\r\n                            {selectedLLM === 'NotebookLM' && import.meta.env.VITE_ENABLE_VNC === 'true' && (\r\n                                <button\r\n                                    onClick={() => setIsVNCVisible(!isVNCVisible)}\r\n                                    style={{\r\n                                        padding: '0.4rem 1.2rem',\r\n                                        backgroundColor: isVNCVisible ? '#4b5563' : '#374151',\r\n                                        color: '#fff',\r\n                                        border: '1px solid #4b5563',\r\n                                        borderRadius: '6px',\r\n                                        cursor: 'pointer',\r\n                                        fontWeight: 600,\r\n                                        fontSize: '0.9rem',\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        gap: '0.5rem'\r\n                                    }}\r\n                                >\r\n                                    {isVNCVisible ? '­ƒÜ½ Close VNC' : '­ƒûÑ´©Å VNC'}\r\n                                </button>\r\n                            )}\r\n                            <button\r\n                                onClick={handleGeneratePrompt}\r\n                                disabled={isExecuting || isGenerating || !!selectedAction}\r\n                                style={{\r\n                                    padding: '0.4rem 1.2rem', backgroundColor: '#8b5cf6', color: '#fff',\r\n                                    border: 'none', borderRadius: '6px',\r\n                                    cursor: (isExecuting || isGenerating || !!selectedAction) ? 'not-allowed' : 'pointer',\r\n                                    fontWeight: 600,\r\n                                    opacity: (isExecuting || isGenerating || !!selectedAction) ? 0.5 : 1,\r\n                                    display: (isExecuting || isGenerating) ? 'none' : 'block',\r\n                                    fontSize: '0.9rem'\r\n                                }}\r\n                            >\r\n                                {isGenerating ? 'Generating...' : 'Generate Prompt'}\r\n                            </button>\r\n                            {!isGenerating && !isExecuting && (\r\n                                <button\r\n                                    onClick={(e) => {\r\n                                        e.preventDefault();\r\n                                        e.stopPropagation();\r\n                                        console.log(\"[AIModal] Execute Clicked (Propagation Stopped + PreventDefault)\");\r\n                                        handleExecute();\r\n                                    }}\r\n                                    disabled={isExecuting || !!selectedAction}\r\n                                    style={{\r\n                                        padding: '0.4rem 1.2rem', backgroundColor: '#3b82f6', color: '#fff',\r\n                                        border: 'none', borderRadius: '6px',\r\n                                        cursor: (isExecuting || !!selectedAction) ? 'not-allowed' : 'pointer',\r\n                                        fontWeight: 600,\r\n                                        opacity: (isExecuting || !!selectedAction) ? 0.5 : 1,\r\n                                        fontSize: '0.9rem'\r\n                                    }}\r\n                                >\r\n                                    {isExecuting ? 'Executing...' : 'Execute'}\r\n                                </button>\r\n                            )}\r\n                            <button\r\n                                onClick={() => onPaste(generatedResponse)}\r\n                                disabled={!generatedResponse}\r\n                                style={{\r\n                                    padding: '0.4rem 1.2rem', backgroundColor: generatedResponse ? '#10b981' : '#333', color: '#fff',\r\n                                    border: 'none', borderRadius: '6px', cursor: generatedResponse ? 'pointer' : 'not-allowed',\r\n                                    fontWeight: 600, opacity: generatedResponse ? 1 : 0.5,\r\n                                    fontSize: '0.9rem'\r\n                                }}\r\n                            >\r\n                                Paste Result & Close\r\n                            </button>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* LLM Selection Moved to Header */}\r\n                    <div style={{ display: 'flex', alignItems: 'center', marginRight: '1rem' }}>\r\n                        {(isExecuting || isGenerating) && (\r\n                            <div style={{\r\n                                width: '20px', height: '20px',\r\n                                border: '3px solid rgba(59, 130, 246, 0.3)',\r\n                                borderTop: '3px solid #3b82f6',\r\n                                borderRadius: '50%',\r\n                                marginRight: '0.8rem',\r\n                                animation: 'spin 1s linear infinite',\r\n                                boxShadow: '0 0 8px rgba(59, 130, 246, 0.5)'\r\n                            }} />\r\n                        )}\r\n                        <span style={{ color: '#aaa', fontSize: '0.9rem', marginRight: '0.5rem' }}>LLM:</span>\r\n                        <select\r\n                            value={selectedLLM}\r\n                            onChange={(e) => setSelectedLLM(e.target.value)}\r\n                            style={{\r\n                                padding: '0.3rem 0.5rem', borderRadius: '4px', border: '1px solid #444',\r\n                                backgroundColor: '#333', color: '#fff', fontSize: '0.9rem',\r\n                                cursor: 'pointer'\r\n                            }}\r\n                        >\r\n                            {['Gemini', 'Grok', 'NotebookLM', 'DeepSeek', 'Brainstorm', 'NotebookLM MCP'].map(opt => (\r\n                                <option key={opt} value={opt}>\r\n                                    {opt}\r\n                                </option>\r\n                            ))}\r\n                        </select>\r\n                    </div>\r\n\r\n                    <button onClick={onClose} style={{ background: 'none', border: 'none', color: '#fff', fontSize: '1.5rem', cursor: 'pointer', marginLeft: '1rem' }}>├ù</button>\r\n                </div>\r\n\r\n                {/* VNC Overlay */}\r\n                {authRequired && (\r\n                    <div style={{\r\n                        position: 'absolute', top: 0, left: 0, width: '100%', height: '100%',\r\n                        backgroundColor: 'rgba(0,0,0,0.9)', zIndex: 10,\r\n                        display: 'flex', flexDirection: 'column', justifyContent: 'center', alignItems: 'center',\r\n                        color: '#fff', textAlign: 'center', padding: '2rem'\r\n                    }}>\r\n                        <h2 style={{ color: '#f87171', fontSize: '2rem', marginBottom: '1rem' }}>ÔÜá´©Å Authentication Required</h2>\r\n                        <p style={{ fontSize: '1.2rem', maxWidth: '600px', marginBottom: '2rem' }}>\r\n                            The automated browser is stuck on the Google Sign-in page.\r\n                            <br />\r\n                            Please log in manually to continue.\r\n                        </p>\r\n\r\n                        <div style={{ backgroundColor: '#333', padding: '1.5rem', borderRadius: '8px', marginBottom: '2rem', border: '1px solid #555' }}>\r\n                            <p style={{ margin: '0 0 1rem 0', color: '#aaa' }}>1. Click the link below to open the VNC Viewer:</p>\r\n                            <a\r\n                                href={`http://${import.meta.env.VITE_VNC_PUBLIC_IP || 'localhost'}:7900`}\r\n                                target=\"_blank\"\r\n                                rel=\"noreferrer\"\r\n                                style={{\r\n                                    display: 'inline-block', padding: '0.8rem 1.5rem',\r\n                                    backgroundColor: '#3b82f6', color: '#fff',\r\n                                    textDecoration: 'none', borderRadius: '6px', fontWeight: 'bold',\r\n                                    fontSize: '1.1rem'\r\n                                }}\r\n                            >\r\n                                Open VNC Viewer ­ƒûÑ´©Å\r\n                            </a>\r\n\r\n                            <div style={{ marginTop: '1.5rem', textAlign: 'left' }}>\r\n                                <p style={{ margin: '0.5rem 0', color: '#aaa' }}>2. Use this password:</p>\r\n                                <code style={{\r\n                                    display: 'block', padding: '0.8rem', backgroundColor: '#000',\r\n                                    color: '#4ade80', borderRadius: '4px', fontSize: '1.2rem', letterSpacing: '2px',\r\n                                    border: '1px dashed #555'\r\n                                }}>\r\n                                    secret\r\n                                </code>\r\n                            </div>\r\n\r\n                            <p style={{ marginTop: '1.5rem', marginBottom: 0, color: '#aaa' }}>3. Sign in to Google inside the opened window.</p>\r\n                        </div>\r\n\r\n                        <button\r\n                            onClick={() => setAuthRequired(false)}\r\n                            style={{\r\n                                padding: '0.8rem 2rem', backgroundColor: 'transparent',\r\n                                color: '#ccc', border: '1px solid #555', borderRadius: '6px',\r\n                                cursor: 'pointer', fontSize: '1rem'\r\n                            }}\r\n                        >\r\n                            I have logged in (Close Overlay)\r\n                        </button>\r\n                    </div>\r\n                )}\r\n\r\n\r\n                {/* Body */}\r\n                <div style={{ display: 'flex', flex: 1, overflow: 'hidden' }}>\r\n                    {/* Main AI UI Wrapper */}\r\n                    <div style={{ display: 'flex', flex: 1, overflow: 'hidden', width: isVNCVisible ? '50%' : '100%' }}>\r\n\r\n                        {/* Left Panel: Query Input */}\r\n                        <div style={{\r\n                            flex: 1, padding: '1rem', display: 'flex', flexDirection: 'column',\r\n                            borderRight: '1px solid #333'\r\n                        }}>\r\n                            <label style={{ color: '#ccc', marginBottom: '0.5rem' }}>Query Input Area</label>\r\n                            <textarea\r\n                                value={promptText}\r\n                                onChange={(e) => setPromptText(e.target.value)}\r\n                                style={{\r\n                                    flex: 1, resize: 'none', padding: '1rem',\r\n                                    backgroundColor: '#1e1e1e', color: '#fff',\r\n                                    border: '1px solid #444', borderRadius: '8px',\r\n                                    fontSize: '1rem', lineHeight: '1.5',\r\n                                    fontFamily: 'inherit'\r\n                                }}\r\n                            />\r\n\r\n                            <div style={{ flex: 1, display: 'flex', flexDirection: 'column', padding: '1rem' }}>\r\n                                <label style={{ color: '#4ade80', marginBottom: '0.5rem' }}>Generated Response</label>\r\n                                <textarea\r\n                                    value={generatedResponse || (isExecuting ? \"Generating query - this may take a little time, please wait.....\\n\\nNote: Queries will automatically terminate after 2 minutes if not completed.\" : \"\")}\r\n                                    readOnly\r\n                                    placeholder=\"Response will appear here...\"\r\n                                    style={{\r\n                                        flex: 1, resize: 'none', padding: '1rem',\r\n                                        backgroundColor: '#111', color: '#eee',\r\n                                        border: '1px solid #444', borderRadius: '8px',\r\n                                        fontSize: '0.95rem', lineHeight: '1.5',\r\n                                        opacity: generatedResponse ? 1 : 0.5\r\n                                    }}\r\n                                />\r\n                            </div>\r\n\r\n                        </div> {/* End Left Panel */}\r\n\r\n                        {/* Right Panel: Parameters */}\r\n                        <div className=\"custom-scrollbar\" style={{\r\n                            width: '400px', padding: '1rem', overflowY: 'auto',\r\n                            backgroundColor: '#252526',\r\n                            overscrollBehavior: 'contain'\r\n                        }}>\r\n\r\n                            {!showAdvancedOptions ? (\r\n                                <>\r\n                                    {/* API Key Management - Hidden for NotebookLM */}\r\n                                    {selectedLLM !== 'NotebookLM' && (\r\n                                        <div style={{ marginBottom: '1.5rem', padding: '1rem', backgroundColor: '#2d2d2d', borderRadius: '8px', border: '1px solid #444' }}>\r\n                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>\r\n                                                <label style={{ color: '#fff', fontSize: '0.9rem', margin: 0 }}>\r\n                                                    {selectedLLM} API Key\r\n                                                </label>\r\n                                                {(selectedLLM === 'Gemini' && apiKey) || (selectedLLM === 'Grok' && grokApiKey) || (selectedLLM === 'DeepSeek' && deepSeekApiKey) ? (\r\n                                                    <button\r\n                                                        onClick={async () => {\r\n                                                            if (!userId) return;\r\n\r\n                                                            try {\r\n                                                                if (selectedLLM === 'Gemini') {\r\n                                                                    await ApiKeyService.deleteApiKey(userId, 'gemini');\r\n                                                                    setApiKey('');\r\n                                                                }\r\n                                                                if (selectedLLM === 'Grok') {\r\n                                                                    await ApiKeyService.deleteApiKey(userId, 'grok');\r\n                                                                    setGrokApiKey('');\r\n                                                                }\r\n                                                                if (selectedLLM === 'DeepSeek') {\r\n                                                                    await ApiKeyService.deleteApiKey(userId, 'deepseek');\r\n                                                                    setDeepSeekApiKey('');\r\n                                                                }\r\n                                                                setShowApiKeyInput(true);\r\n                                                            } catch (error) {\r\n                                                                console.error(\"Failed to delete API key:\", error);\r\n                                                            }\r\n                                                        }}\r\n                                                        style={{\r\n                                                            background: 'none', border: 'none', color: '#3b82f6',\r\n                                                            cursor: 'pointer', fontSize: '0.8rem', textDecoration: 'underline'\r\n                                                        }}\r\n                                                    >\r\n                                                        Change Key\r\n                                                    </button>\r\n                                                ) : null}\r\n                                            </div>\r\n\r\n                                            {(showApiKeyInput || (selectedLLM === 'Gemini' && !apiKey) || (selectedLLM === 'Grok' && !grokApiKey) || (selectedLLM === 'DeepSeek' && !deepSeekApiKey)) && (\r\n                                                <input\r\n                                                    type=\"password\"\r\n                                                    value={selectedLLM === 'Gemini' ? apiKey : selectedLLM === 'Grok' ? grokApiKey : deepSeekApiKey}\r\n                                                    onChange={(e) => handleSaveApiKey(e.target.value)}\r\n                                                    placeholder={`Enter ${selectedLLM} API Key...`}\r\n                                                    style={{ width: '100%', padding: '0.5rem', borderRadius: '4px', border: 'none', backgroundColor: '#1e1e1e', color: '#fff' }}\r\n                                                />\r\n                                            )}\r\n\r\n                                            {/* Status Indicator */}\r\n                                            {((selectedLLM === 'Gemini' && apiKey) || (selectedLLM === 'Grok' && grokApiKey) || (selectedLLM === 'DeepSeek' && deepSeekApiKey)) && !showApiKeyInput && (\r\n                                                <div style={{ fontSize: '0.8rem', color: '#4ade80' }}>\r\n                                                    Ô£ô Key loaded\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* NotebookLM Management */}\r\n                                    {(selectedLLM === 'NotebookLM') && (\r\n                                        <div style={{ marginBottom: '1.5rem', padding: '1rem', backgroundColor: '#2d2d2d', borderRadius: '8px', border: '1px solid #444' }}>\r\n                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>\r\n                                                <h3 style={{ color: '#fff', fontSize: '0.9rem', margin: 0 }}>Select Notebook</h3>\r\n                                                <button\r\n                                                    onClick={() => setShowNotebookMaintenance(!showNotebookMaintenance)}\r\n                                                    style={{\r\n                                                        background: 'none', border: 'none', color: '#3b82f6',\r\n                                                        cursor: 'pointer', fontSize: '0.8rem', textDecoration: 'underline'\r\n                                                    }}\r\n                                                >\r\n                                                    {showNotebookMaintenance ? 'Hide Maintenance' : 'Maintain Notebooks'}\r\n                                                </button>\r\n                                            </div>\r\n                                            <select\r\n                                                value={selectedNotebookId}\r\n                                                onChange={(e) => setSelectedNotebookId(e.target.value)}\r\n                                                style={{\r\n                                                    width: '100%', padding: '0.5rem', borderRadius: '4px', border: '1px solid #444',\r\n                                                    backgroundColor: '#1e1e1e', color: '#fff', marginBottom: '0.5rem'\r\n                                                }}\r\n                                            >\r\n                                                <option value=\"\">-- Select a Notebook --</option>\r\n                                                {notebooks.map(nb => (\r\n                                                    <option key={nb.id} value={nb.id}>{nb.notebook_desc || nb.notebook_nm} ({nb.notebook_id})</option>\r\n                                                ))}\r\n                                            </select>\r\n\r\n                                            {/* Development Mode Toggle */}\r\n                                            <label style={{\r\n                                                display: 'flex',\r\n                                                alignItems: 'center',\r\n                                                gap: '0.5rem',\r\n                                                color: '#9ca3af',\r\n                                                fontSize: '0.85rem',\r\n                                                marginTop: '0.5rem',\r\n                                                cursor: 'pointer'\r\n                                            }}>\r\n                                                <input\r\n                                                    type=\"checkbox\"\r\n                                                    checked={devMode}\r\n                                                    onChange={(e) => setDevMode(e.target.checked)}\r\n                                                    style={{ cursor: 'pointer' }}\r\n                                                />\r\n                                                <span style={{ color: devMode ? '#10b981' : '#9ca3af' }}>\r\n                                                    Development Mode\r\n                                                    {devMode && ' (Browser stays open)'}\r\n                                                </span>\r\n                                            </label>\r\n                                            {devMode && (\r\n                                                <div style={{\r\n                                                    fontSize: '0.75rem',\r\n                                                    color: '#6b7280',\r\n                                                    marginTop: '0.3rem',\r\n                                                    marginLeft: '1.7rem',\r\n                                                    fontStyle: 'italic'\r\n                                                }}>\r\n                                                    Browser will persist between queries. Use \"Close Browser\" button in VNC panel to close.\r\n                                                </div>\r\n                                            )}\r\n\r\n\r\n                                            {showNotebookMaintenance && (\r\n                                                <div style={{ marginTop: '1rem', borderTop: '1px solid #444', paddingTop: '1rem' }}>\r\n                                                    <h3 style={{ color: '#fff', fontSize: '0.9rem', marginBottom: '0.5rem' }}>Manage Notebooks</h3>\r\n                                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>\r\n                                                        <input\r\n                                                            type=\"text\"\r\n                                                            placeholder=\"Description (e.g. My Research)\"\r\n                                                            value={newNotebookDesc}\r\n                                                            onChange={(e) => setNewNotebookDesc(e.target.value)}\r\n                                                            style={{ padding: '0.4rem', borderRadius: '4px', border: '1px solid #444', backgroundColor: '#1e1e1e', color: '#fff' }}\r\n                                                        />\r\n                                                        <input\r\n                                                            type=\"text\"\r\n                                                            placeholder=\"Notebook ID\"\r\n                                                            value={newNotebookId}\r\n                                                            onChange={(e) => setNewNotebookId(e.target.value)}\r\n                                                            style={{ padding: '0.4rem', borderRadius: '4px', border: '1px solid #444', backgroundColor: '#1e1e1e', color: '#fff' }}\r\n                                                        />\r\n                                                        <button\r\n                                                            onClick={handleAddNotebook}\r\n                                                            style={{\r\n                                                                padding: '0.4rem', backgroundColor: '#3b82f6', color: '#fff', border: 'none', borderRadius: '4px', cursor: 'pointer'\r\n                                                            }}\r\n                                                        >\r\n                                                            Add Notebook\r\n                                                        </button>\r\n                                                    </div>\r\n                                                    {notebooks.length > 0 && (\r\n                                                        <div style={{ marginTop: '1rem' }}>\r\n                                                            <label style={{ color: '#aaa', fontSize: '0.8rem' }}>Saved Notebooks:</label>\r\n                                                            <ul style={{ listStyle: 'none', padding: 0, margin: '0.5rem 0 0 0' }}>\r\n                                                                {notebooks.map(nb => (\r\n                                                                    <li key={nb.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.3rem', fontSize: '0.85rem', color: '#ddd' }}>\r\n                                                                        <span>{nb.notebook_desc || nb.notebook_nm}</span>\r\n                                                                        <button\r\n                                                                            onClick={() => handleDeleteNotebook(nb.id)}\r\n                                                                            style={{ background: 'none', border: 'none', color: '#ef4444', cursor: 'pointer', fontSize: '0.8rem' }}\r\n                                                                        >\r\n                                                                            Delete\r\n                                                                        </button>\r\n                                                                    </li>\r\n                                                                ))}\r\n                                                            </ul>\r\n                                                        </div>\r\n                                                    )}\r\n                                                </div>\r\n                                            )}\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* NotebookLM MCP Management */}\r\n                                    {(selectedLLM === 'NotebookLM MCP') && (\r\n                                        <div style={{ marginBottom: '1.5rem', padding: '1rem', backgroundColor: '#2d2d2d', borderRadius: '8px', border: '1px solid #444' }}>\r\n                                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>\r\n                                                <h3 style={{ color: '#fff', fontSize: '0.9rem', margin: 0 }}>Select MCP Notebook</h3>\r\n                                                <small style={{ color: '#aaa' }}>{mcpNotebooks.length} available</small>\r\n                                            </div>\r\n                                            <select\r\n                                                value={selectedMcpNotebookId}\r\n                                                onChange={(e) => setSelectedMcpNotebookId(e.target.value)}\r\n                                                style={{\r\n                                                    width: '100%', padding: '0.5rem', borderRadius: '4px', border: '1px solid #444',\r\n                                                    backgroundColor: '#1e1e1e', color: '#fff', marginBottom: '0.5rem'\r\n                                                }}\r\n                                            >\r\n                                                <option value=\"\">-- Select a Notebook --</option>\r\n                                                {mcpNotebooks.map(nb => (\r\n                                                    <option key={nb.id} value={nb.id}>{nb.title} ({nb.source_count} sources)</option>\r\n                                                ))}\r\n                                            </select>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    {/* Quick Actions - Hidden for NotebookLM */}\r\n                                    {selectedLLM !== 'NotebookLM' && (\r\n                                        <div style={{ marginBottom: '1.5rem' }}>\r\n                                            <h3 style={{ color: '#fff', fontSize: '1rem', marginBottom: '1rem', borderBottom: '1px solid #444', paddingBottom: '0.5rem' }}>Quick Actions</h3>\r\n                                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem' }}>\r\n                                                {['Clarify', 'Proofread', 'Summarise', 'Rewrite'].map(action => (\r\n                                                    <button\r\n                                                        key={action}\r\n                                                        onClick={() => {\r\n                                                            const newAction = selectedAction === action ? '' : action;\r\n                                                            setSelectedAction(newAction);\r\n                                                            // If selecting a new action (not deselecting), trigger execution immediately\r\n                                                            if (newAction) {\r\n                                                                handleExecute(newAction);\r\n                                                            }\r\n                                                        }}\r\n                                                        disabled={isExecuting || isGenerating}\r\n                                                        style={{\r\n                                                            padding: '0.5rem',\r\n                                                            borderRadius: '6px',\r\n                                                            border: '1px solid',\r\n                                                            borderColor: selectedAction === action ? '#3b82f6' : '#444',\r\n                                                            backgroundColor: selectedAction === action ? 'rgba(59, 130, 246, 0.2)' : '#333',\r\n                                                            color: selectedAction === action ? '#3b82f6' : '#ccc',\r\n                                                            cursor: (isExecuting || isGenerating) ? 'not-allowed' : 'pointer',\r\n                                                            fontSize: '0.9rem',\r\n                                                            transition: 'all 0.2s',\r\n                                                            opacity: (isExecuting || isGenerating) ? 0.6 : 1\r\n                                                        }}\r\n                                                    >\r\n                                                        {action}\r\n                                                    </button>\r\n                                                ))}\r\n                                            </div>\r\n                                        </div>\r\n                                    )}\r\n\r\n                                    <h3 style={{ color: '#fff', fontSize: '1rem', marginBottom: '1rem', borderBottom: '1px solid #444', paddingBottom: '0.5rem' }}>Core Query Parameters</h3>\r\n                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}>\r\n                                        <ParamDropdown label=\"Style\" value={style} onChange={setStyle} options={['RFP response', 'Professional', 'Casual', '3rd Person', 'Personal']} />\r\n\r\n                                        {/* Bullet List Toggle */}\r\n                                        <div style={{ display: 'flex', flexDirection: 'column' }}>\r\n                                            <label style={{ fontSize: '0.8rem', color: '#aaa', marginBottom: '0.2rem' }}>Structure</label>\r\n                                            <div\r\n                                                onClick={() => setUseBulletList(!useBulletList)}\r\n                                                style={{\r\n                                                    padding: '0.4rem', borderRadius: '4px', border: '1px solid #444',\r\n                                                    backgroundColor: useBulletList ? '#3b82f6' : '#333',\r\n                                                    color: '#fff', fontSize: '0.9rem',\r\n                                                    cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center',\r\n                                                    userSelect: 'none', transition: 'background-color 0.2s'\r\n                                                }}\r\n                                            >\r\n                                                {useBulletList ? 'Ô£ô Bullet List' : 'Standard Text'}\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        {/* Custom Length UI */}\r\n                                        <div style={{ display: 'flex', flexDirection: 'column' }}>\r\n                                            <label style={{ fontSize: '0.8rem', color: '#aaa', marginBottom: '0.2rem' }}>Length</label>\r\n                                            <div style={{ display: 'flex', gap: '0.5rem' }}>\r\n                                                <select\r\n                                                    value={length === 'Similar' ? 'Similar' : 'Custom'}\r\n                                                    onChange={(e) => {\r\n                                                        const val = e.target.value;\r\n                                                        if (val === 'Similar') {\r\n                                                            setLength('Similar');\r\n                                                        } else {\r\n                                                            setLength(`${customLengthValue} words`);\r\n                                                        }\r\n                                                    }}\r\n                                                    style={{\r\n                                                        padding: '0.4rem', borderRadius: '4px', border: '1px solid #444',\r\n                                                        backgroundColor: '#333', color: '#fff', fontSize: '0.9rem',\r\n                                                        flex: 1\r\n                                                    }}\r\n                                                >\r\n                                                    <option value=\"Similar\">Similar</option>\r\n                                                    <option value=\"Custom\">Custom</option>\r\n                                                </select>\r\n                                                {length !== 'Similar' && (\r\n                                                    <input\r\n                                                        type=\"number\"\r\n                                                        value={customLengthValue}\r\n                                                        onChange={(e) => {\r\n                                                            setCustomLengthValue(e.target.value);\r\n                                                            setLength(`${e.target.value} words`);\r\n                                                        }}\r\n                                                        placeholder=\"#\"\r\n                                                        style={{\r\n                                                            width: '60px', padding: '0.4rem', borderRadius: '4px',\r\n                                                            border: '1px solid #444', backgroundColor: '#333', color: '#fff',\r\n                                                            fontSize: '0.9rem'\r\n                                                        }}\r\n                                                    />\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        <ParamDropdown label=\"Sources\" value={sources} onChange={setSources} options={['No reference', 'References']} />\r\n                                        <ParamDropdown label=\"Format\" value={format} onChange={setFormat} options={['Plain written text', 'Markdown']} />\r\n                                        <ParamDropdown label=\"Language\" value={language} onChange={setLanguage} options={['English', 'German', 'Japanese', 'Spanish', 'French', 'Russian']} />\r\n                                        <ParamDropdown label=\"Suitability\" value={suitability} onChange={setSuitability} options={['Executive', 'Casual', 'Technical']} />\r\n                                    </div>\r\n\r\n                                    {/* More Options Toggle - Hidden for NotebookLM */}\r\n                                    {selectedLLM !== 'NotebookLM' && (\r\n                                        <div\r\n                                            onClick={() => setShowAdvancedOptions(true)}\r\n                                            style={{\r\n                                                display: 'flex', alignItems: 'center', gap: '0.5rem',\r\n                                                marginTop: '1rem', cursor: 'pointer', color: '#3b82f6',\r\n                                                fontSize: '0.9rem', userSelect: 'none', justifyContent: 'flex-end'\r\n                                            }}\r\n                                        >\r\n                                            <span>More Options &gt;</span>\r\n                                        </div>\r\n                                    )}\r\n                                </>\r\n                            ) : (\r\n                                <div style={{ animation: 'fadeIn 0.3s ease-in-out' }}>\r\n                                    <div\r\n                                        onClick={() => setShowAdvancedOptions(false)}\r\n                                        style={{\r\n                                            display: 'flex', alignItems: 'center', gap: '0.5rem',\r\n                                            marginBottom: '1rem', cursor: 'pointer', color: '#3b82f6',\r\n                                            fontSize: '0.9rem', userSelect: 'none'\r\n                                        }}\r\n                                    >\r\n                                        <span>&lt; Back to Basic Options</span>\r\n                                    </div>\r\n\r\n                                    {/* Boosters */}\r\n                                    <div style={{ marginBottom: '1.5rem' }}>\r\n                                        <h3 style={{ color: '#fff', fontSize: '0.95rem', marginBottom: '0.8rem', fontWeight: '600' }}>Proven Booster Toggles</h3>\r\n                                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.8rem 1rem' }}>\r\n                                            <BoosterToggle label=\"Step-by-step thinking\" checked={boosters.stepByStep} onChange={() => toggleBooster('stepByStep')} />\r\n                                            <BoosterToggle label=\"Critique reasoning\" checked={boosters.critique} onChange={() => toggleBooster('critique')} />\r\n                                            <BoosterToggle label=\"Multiple approaches\" checked={boosters.multipleApproaches} onChange={() => toggleBooster('multipleApproaches')} />\r\n                                            <BoosterToggle label=\"Expert persona\" checked={boosters.expert} onChange={() => toggleBooster('expert')} />\r\n                                            <BoosterToggle label=\"Ethical filter\" checked={boosters.unethical} onChange={() => toggleBooster('unethical')} />\r\n                                            <BoosterToggle label=\"Delimit inputs\" checked={boosters.delimiters} onChange={() => toggleBooster('delimiters')} />\r\n                                        </div>\r\n                                    </div>\r\n\r\n                                    {/* Advanced */}\r\n                                    <div>\r\n                                        <h3 style={{ color: '#fff', fontSize: '0.95rem', marginBottom: '0.8rem', fontWeight: '600' }}>Advanced Options</h3>\r\n\r\n                                        <div style={{ marginBottom: '1.2rem' }}>\r\n                                            <label style={{ color: '#aaa', fontSize: '0.85rem', display: 'block', marginBottom: '0.5rem' }}>Reasoning Style</label>\r\n                                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>\r\n                                                {['Chain-of-Thought', 'Tree-of-Thought', 'Step-by-step', 'Self-Consistency'].map(opt => (\r\n                                                    <CheckButton key={opt} label={opt} checked={reasoningStyles.includes(opt)} onChange={() => toggleReasoning(opt)} />\r\n                                                ))}\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        <div style={{ marginBottom: '1.2rem' }}>\r\n                                            <label style={{ color: '#aaa', fontSize: '0.85rem', display: 'block', marginBottom: '0.5rem' }}>Output Format</label>\r\n                                            <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>\r\n                                                {['Plain text', 'JSON', 'YAML', 'Markdown', 'Table', 'XML'].map(opt => (\r\n                                                    <CheckButton key={opt} label={opt} checked={outputFormats.includes(opt)} onChange={() => toggleOutputFormat(opt)} />\r\n                                                ))}\r\n                                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>\r\n                                                    <CheckButton label=\"Code block\" checked={outputFormats.includes('Code block')} onChange={() => toggleOutputFormat('Code block')} />\r\n                                                    {outputFormats.includes('Code block') && (\r\n                                                        <input\r\n                                                            type=\"text\" placeholder=\"lang\" value={codeLanguage} onChange={e => setCodeLanguage(e.target.value)}\r\n                                                            style={{ width: '60px', padding: '0.2rem', borderRadius: '4px', border: 'none', backgroundColor: '#333', color: '#fff', fontSize: '0.8rem' }}\r\n                                                        />\r\n                                                    )}\r\n                                                </div>\r\n                                            </div>\r\n                                        </div>\r\n\r\n                                        <div style={{ display: 'flex', flexDirection: 'column', gap: '0.8rem', backgroundColor: '#2d2d2d', padding: '0.8rem', borderRadius: '6px' }}>\r\n                                            <ConstraintRow label=\"Max length\" active={constraints.maxLength.active} value={constraints.maxLength.value}\r\n                                                onToggle={v => handleConstraintChange('maxLength', 'active', v)}\r\n                                                onChange={v => handleConstraintChange('maxLength', 'value', v)} placeholder=\"e.g. 500 words\" />\r\n                                            <ConstraintRow label=\"Forbidden words\" active={constraints.forbidden.active} value={constraints.forbidden.value}\r\n                                                onToggle={v => handleConstraintChange('forbidden', 'active', v)}\r\n                                                onChange={v => handleConstraintChange('forbidden', 'value', v)} placeholder=\"e.g. confidential\" />\r\n                                            <ConstraintRow label=\"Keywords\" active={constraints.keywords.active} value={constraints.keywords.value}\r\n                                                onToggle={v => handleConstraintChange('keywords', 'active', v)}\r\n                                                onChange={v => handleConstraintChange('keywords', 'value', v)} placeholder=\"Must include...\" />\r\n                                            <ConstraintRow label=\"Tone\" active={constraints.tone.active} value={constraints.tone.value}\r\n                                                onToggle={v => handleConstraintChange('tone', 'active', v)}\r\n                                                onChange={v => handleConstraintChange('tone', 'value', v)} placeholder=\"e.g. Sarcastic\" />\r\n                                        </div>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </div> {/* End Main Wrapper */}\r\n\r\n                    {isVNCVisible && (\r\n                        <div style={{\r\n                            width: '50%',\r\n                            display: 'flex',\r\n                            flexDirection: 'column',\r\n                            borderLeft: '1px solid #333',\r\n                            backgroundColor: '#000'\r\n                        }}>\r\n                            <VNCPanel />\r\n                        </div>\r\n                    )}\r\n                </div> {/* End Body */}\r\n\r\n\r\n\r\n            </div>\r\n\r\n            {/* JSON Viewer Modal */}\r\n            {showJsonViewer && brainstormJsonData && (\r\n                <JsonViewerModal\r\n                    isOpen={showJsonViewer}\r\n                    onClose={() => setShowJsonViewer(false)}\r\n                    jsonData={brainstormJsonData}\r\n                    title=\"­ƒÄ¿ Brainstorm Results\"\r\n                />\r\n            )}\r\n        </div>\r\n    );\r\n\r\n    return ReactDOM.createPortal(modalContent, document.body);\r\n};\r\n\r\n// --- Helper Components ---\r\n\r\ninterface ParamDropdownProps {\r\n    label: string;\r\n    value: string;\r\n    onChange: (value: string) => void;\r\n    options: string[];\r\n    disabledOptions?: string[];\r\n}\r\n\r\nconst ParamDropdown: React.FC<ParamDropdownProps> = ({ label, value, onChange, options, disabledOptions = [] }) => (\r\n    <div style={{ display: 'flex', flexDirection: 'column' }}>\r\n        <label style={{ fontSize: '0.8rem', color: '#aaa', marginBottom: '0.2rem' }}>{label}</label>\r\n        <select\r\n            value={value}\r\n            onChange={(e) => onChange(e.target.value)}\r\n            style={{\r\n                padding: '0.4rem', borderRadius: '4px', border: '1px solid #444',\r\n                backgroundColor: '#333', color: '#fff', fontSize: '0.9rem'\r\n            }}\r\n        >\r\n            {options.map((opt) => (\r\n                <option key={opt} value={opt} disabled={disabledOptions.includes(opt)}>\r\n                    {opt}\r\n                </option>\r\n            ))}\r\n        </select>\r\n    </div>\r\n);\r\n\r\ninterface BoosterToggleProps {\r\n    label: string;\r\n    checked: boolean;\r\n    onChange: () => void;\r\n}\r\n\r\nconst BoosterToggle: React.FC<BoosterToggleProps> = ({ label, checked, onChange }) => (\r\n    <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '0.3rem 0' }}>\r\n        <span style={{ color: '#ddd', fontSize: '0.9rem' }}>{label}</span>\r\n        <label className=\"switch\" style={{ position: 'relative', display: 'inline-block', width: '40px', height: '20px' }}>\r\n            <input type=\"checkbox\" checked={checked} onChange={onChange} style={{ opacity: 0, width: 0, height: 0 }} />\r\n            <span style={{\r\n                position: 'absolute', cursor: 'pointer', top: 0, left: 0, right: 0, bottom: 0,\r\n                backgroundColor: checked ? '#3b82f6' : '#555', transition: '.4s', borderRadius: '20px'\r\n            }}>\r\n                <span style={{\r\n                    position: 'absolute', content: '\"\"', height: '16px', width: '16px', left: '2px', bottom: '2px',\r\n                    backgroundColor: 'white', transition: '.4s', borderRadius: '50%',\r\n                    transform: checked ? 'translateX(20px)' : 'translateX(0)'\r\n                }} />\r\n            </span>\r\n        </label>\r\n    </div>\r\n);\r\n\r\ninterface CheckButtonProps {\r\n    label: string;\r\n    checked: boolean;\r\n    onChange: () => void;\r\n}\r\n\r\nconst CheckButton: React.FC<CheckButtonProps> = ({ label, checked, onChange }) => (\r\n    <button\r\n        onClick={onChange}\r\n        style={{\r\n            padding: '0.3rem 0.8rem', borderRadius: '15px', border: '1px solid',\r\n            borderColor: checked ? '#3b82f6' : '#444',\r\n            backgroundColor: checked ? 'rgba(59, 130, 246, 0.2)' : 'transparent',\r\n            color: checked ? '#3b82f6' : '#aaa',\r\n            fontSize: '0.8rem', cursor: 'pointer', transition: 'all 0.2s'\r\n        }}\r\n    >\r\n        {label}\r\n    </button>\r\n);\r\n\r\ninterface ConstraintRowProps {\r\n    label: string;\r\n    active: boolean;\r\n    value: string;\r\n    onToggle: (checked: boolean) => void;\r\n    onChange: (value: string) => void;\r\n    placeholder: string;\r\n}\r\n\r\nconst ConstraintRow: React.FC<ConstraintRowProps> = ({ label, active, value, onToggle, onChange, placeholder }) => (\r\n    <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>\r\n        <input type=\"checkbox\" checked={active} onChange={(e) => onToggle(e.target.checked)} />\r\n        <span style={{ fontSize: '0.85rem', color: '#ccc', width: '100px' }}>{label}</span>\r\n        <input\r\n            type=\"text\"\r\n            value={value}\r\n            onChange={(e) => onChange(e.target.value)}\r\n            disabled={!active}\r\n            placeholder={placeholder}\r\n            style={{\r\n                flex: 1, padding: '0.3rem', borderRadius: '4px', border: '1px solid #444',\r\n                backgroundColor: active ? '#333' : '#222', color: '#fff', fontSize: '0.85rem',\r\n                opacity: active ? 1 : 0.5\r\n            }}\r\n        />\r\n    </div>\r\n);\r\n\r\nexport default React.memo(AIQueryRefinementModal);\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\AdminModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":58,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":58,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2148,2151],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2148,2151],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":72,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":72,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2662,2665],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2662,2665],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":121,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4675,4678],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4675,4678],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":149,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":149,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5661,5664],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5661,5664],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport ReactDOM from 'react-dom';\r\nimport { AuthService } from '../services/AuthService';\r\nimport { NodeService } from '../services/NodeService';\r\nimport type { UserProfile, DocumentNode, AccessLevel } from '../types';\r\n\r\ninterface AdminModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n}\r\n\r\nexport const AdminModal: React.FC<AdminModalProps> = ({ isOpen, onClose }) => {\r\n    const [users, setUsers] = useState<UserProfile[]>([]);\r\n    const [selectedUser, setSelectedUser] = useState<string>('');\r\n    const [permissions, setPermissions] = useState<Map<number, AccessLevel>>(new Map());\r\n    const [nodes, setNodes] = useState<DocumentNode[]>([]);\r\n    const [expandedNodes, setExpandedNodes] = useState<Set<number>>(new Set());\r\n    const [activeTab, setActiveTab] = useState<'approvals' | 'permissions'>('approvals');\r\n\r\n    const [loading, setLoading] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [successMessage, setSuccessMessage] = useState<string | null>(null);\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            loadInitialData();\r\n        }\r\n    }, [isOpen]);\r\n\r\n    useEffect(() => {\r\n        if (selectedUser) {\r\n            loadUserPermissions(selectedUser);\r\n        } else {\r\n            setPermissions(new Map());\r\n        }\r\n    }, [selectedUser]);\r\n\r\n    const loadInitialData = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const [usersData, nodesData] = await Promise.all([\r\n                AuthService.getAllUsers(),\r\n                NodeService.fetchNodes() // We need all nodes to assign permissions\r\n            ]);\r\n            setUsers(usersData);\r\n            setUsers(usersData);\r\n            setNodes(nodesData);\r\n\r\n            // Initialize expanded nodes (Level 0 and 1)\r\n            const initialExpanded = new Set<number>();\r\n            nodesData.forEach(node => {\r\n                if (node.level < 2) {\r\n                    initialExpanded.add(node.nodeID);\r\n                }\r\n            });\r\n            setExpandedNodes(initialExpanded);\r\n\r\n        } catch (err: any) {\r\n            setError('Failed to load data: ' + err.message);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const loadUserPermissions = async (userId: string) => {\r\n        setLoading(true);\r\n        try {\r\n            const perms = await AuthService.getUserPermissions(userId);\r\n            const permMap = new Map<number, AccessLevel>();\r\n            perms.forEach(p => permMap.set(p.node_id, p.access_level));\r\n            setPermissions(permMap);\r\n        } catch (err: any) {\r\n            setError('Failed to load permissions: ' + err.message);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    // Helper to get all descendants recursively\r\n    const getAllDescendants = (nodeId: number, allNodes: DocumentNode[]): DocumentNode[] => {\r\n        const children = allNodes.filter(n => n.parentNodeID === nodeId);\r\n        let descendants = [...children];\r\n        children.forEach(child => {\r\n            descendants = [...descendants, ...getAllDescendants(child.nodeID, allNodes)];\r\n        });\r\n        return descendants;\r\n    };\r\n\r\n    const handlePermissionChange = async (targetNodeId: number, level: AccessLevel | 'none') => {\r\n        if (!selectedUser) return;\r\n\r\n        // Find target node and all descendants\r\n        const targetNode = nodes.find(n => n.nodeID === targetNodeId);\r\n        if (!targetNode) return;\r\n\r\n        const descendants = getAllDescendants(targetNodeId, nodes);\r\n        const affectedNodes = [targetNode, ...descendants];\r\n        const affectedNodeIds = affectedNodes.map(n => n.nodeID);\r\n\r\n        try {\r\n            if (level === 'none') {\r\n                await AuthService.bulkRemovePermissions(selectedUser, affectedNodeIds);\r\n                setPermissions(prev => {\r\n                    const next = new Map(prev);\r\n                    affectedNodeIds.forEach(id => next.delete(id));\r\n                    return next;\r\n                });\r\n            } else {\r\n                const permsToAssign = affectedNodes.map(n => ({\r\n                    nodeId: n.nodeID,\r\n                    docid: n.docid,\r\n                    accessLevel: level\r\n                }));\r\n                await AuthService.bulkAssignPermissions(selectedUser, permsToAssign);\r\n                setPermissions(prev => {\r\n                    const next = new Map(prev);\r\n                    affectedNodes.forEach(n => next.set(n.nodeID, level));\r\n                    return next;\r\n                });\r\n            }\r\n        } catch (err: any) {\r\n            setError('Failed to update permissions: ' + err.message);\r\n        }\r\n    };\r\n\r\n    const toggleExpand = (nodeId: number) => {\r\n        setExpandedNodes(prev => {\r\n            const next = new Set(prev);\r\n            if (next.has(nodeId)) {\r\n                next.delete(nodeId);\r\n            } else {\r\n                next.add(nodeId);\r\n            }\r\n            return next;\r\n        });\r\n    };\r\n\r\n    const handleApproveUser = async (userId: string, approve: boolean) => {\r\n        setLoading(true);\r\n        setError(null);\r\n        setSuccessMessage(null);\r\n        try {\r\n            await AuthService.approveUser(userId, approve);\r\n            setSuccessMessage(`User ${approve ? 'approved' : 'unapproved'} successfully!`);\r\n            // Reload users to reflect the change\r\n            const usersData = await AuthService.getAllUsers();\r\n            setUsers(usersData);\r\n            setTimeout(() => setSuccessMessage(null), 3000);\r\n        } catch (err: any) {\r\n            setError('Failed to update user approval: ' + err.message);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n\r\n    // Recursive tree renderer\r\n    const renderTree = (parentId: number | null = null, depth = 0) => {\r\n        const children = nodes\r\n            .filter(n => (n.parentNodeID) === parentId || (parentId === null && (!n.parentNodeID || n.parentNodeID === 0 || n.parentNodeID === -1)))\r\n            .sort((a, b) => a.order - b.order);\r\n\r\n        return children.map(node => (\r\n            <div key={node.nodeID} style={{ marginLeft: depth > 0 ? '20px' : '0' }}>\r\n                <div style={{\r\n                    display: 'flex',\r\n                    alignItems: 'center',\r\n                    padding: '8px',\r\n                    borderBottom: '1px solid #333',\r\n                    backgroundColor: depth % 2 === 0 ? 'rgba(255,255,255,0.02)' : 'transparent'\r\n                }}>\r\n                    <div style={{ width: '24px', display: 'flex', justifyContent: 'center' }}>\r\n                        {node.children && (\r\n                            <button\r\n                                onClick={() => toggleExpand(node.nodeID)}\r\n                                style={{\r\n                                    background: 'none',\r\n                                    border: 'none',\r\n                                    color: '#ccc',\r\n                                    cursor: 'pointer',\r\n                                    fontSize: '12px',\r\n                                    padding: '0',\r\n                                    width: '100%',\r\n                                    textAlign: 'center'\r\n                                }}\r\n                            >\r\n                                {expandedNodes.has(node.nodeID) ? 'Ôû╝' : 'ÔûÂ'}\r\n                            </button>\r\n                        )}\r\n                    </div>\r\n\r\n                    <span style={{ marginRight: '8px', opacity: node.children ? 1 : 0.5 }}>\r\n                        {node.children ? '­ƒôü' : '­ƒôä'}\r\n                    </span>\r\n                    <span style={{ flex: 1, overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>\r\n                        {node.title}\r\n                    </span>\r\n\r\n                    <select\r\n                        value={permissions.get(node.nodeID) || 'none'}\r\n                        onChange={(e) => handlePermissionChange(node.nodeID, e.target.value as AccessLevel | 'none')}\r\n                        disabled={!selectedUser}\r\n                        style={{\r\n                            backgroundColor: '#252526',\r\n                            color: '#fff',\r\n                            border: '1px solid #444',\r\n                            borderRadius: '4px',\r\n                            padding: '4px 8px'\r\n                        }}\r\n                    >\r\n                        <option value=\"none\">None (Hidden)</option>\r\n                        <option value=\"read_only\">Read Only</option>\r\n                        <option value=\"full_access\">Full Access</option>\r\n                    </select>\r\n                </div>\r\n                {expandedNodes.has(node.nodeID) && renderTree(node.nodeID, depth + 1)}\r\n            </div>\r\n        ));\r\n    };\r\n\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return ReactDOM.createPortal(\r\n        <div style={{\r\n            position: 'fixed',\r\n            top: 0,\r\n            left: 0,\r\n            width: '100vw',\r\n            height: '100vh',\r\n            backgroundColor: 'rgba(0,0,0,0.85)',\r\n            zIndex: 2000,\r\n            display: 'flex',\r\n            justifyContent: 'center',\r\n            alignItems: 'center'\r\n        }}>\r\n            <div style={{\r\n                width: '800px',\r\n                height: '80vh',\r\n                backgroundColor: '#1e1e1e',\r\n                borderRadius: '8px',\r\n                display: 'flex',\r\n                flexDirection: 'column',\r\n                boxShadow: '0 4px 20px rgba(0,0,0,0.5)',\r\n                border: '1px solid #333'\r\n            }}>\r\n                <div style={{\r\n                    padding: '16px',\r\n                    borderBottom: '1px solid #333',\r\n                    display: 'flex',\r\n                    justifyContent: 'space-between',\r\n                    alignItems: 'center'\r\n                }}>\r\n                    <h2 style={{ margin: 0, color: '#fff' }}>­ƒøí´©Å Access Control Admin</h2>\r\n                    <button\r\n                        onClick={onClose}\r\n                        style={{ background: 'none', border: 'none', color: '#fff', cursor: 'pointer', fontSize: '1.2rem' }}\r\n                    >\r\n                        Ô£ò\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Tab Navigation */}\r\n                <div style={{ display: 'flex', borderBottom: '1px solid #333', backgroundColor: '#252526' }}>\r\n                    <button\r\n                        onClick={() => setActiveTab('approvals')}\r\n                        style={{\r\n                            flex: 1,\r\n                            padding: '12px',\r\n                            backgroundColor: activeTab === 'approvals' ? '#1e1e1e' : 'transparent',\r\n                            border: 'none',\r\n                            borderBottom: activeTab === 'approvals' ? '2px solid #007acc' : '2px solid transparent',\r\n                            color: activeTab === 'approvals' ? '#fff' : '#888',\r\n                            cursor: 'pointer',\r\n                            fontSize: '0.95rem',\r\n                            fontWeight: activeTab === 'approvals' ? 600 : 400\r\n                        }}\r\n                    >\r\n                        ­ƒæÑ User Approvals\r\n                    </button>\r\n                    <button\r\n                        onClick={() => setActiveTab('permissions')}\r\n                        style={{\r\n                            flex: 1,\r\n                            padding: '12px',\r\n                            backgroundColor: activeTab === 'permissions' ? '#1e1e1e' : 'transparent',\r\n                            border: 'none',\r\n                            borderBottom: activeTab === 'permissions' ? '2px solid #007acc' : '2px solid transparent',\r\n                            color: activeTab === 'permissions' ? '#fff' : '#888',\r\n                            cursor: 'pointer',\r\n                            fontSize: '0.95rem',\r\n                            fontWeight: activeTab === 'permissions' ? 600 : 400\r\n                        }}\r\n                    >\r\n                        ­ƒöÉ Permissions\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Success/Error Messages */}\r\n                {(successMessage || error) && (\r\n                    <div style={{\r\n                        padding: '12px 16px',\r\n                        backgroundColor: successMessage ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',\r\n                        borderBottom: '1px solid #333',\r\n                        color: successMessage ? '#10b981' : '#ef4444',\r\n                        fontSize: '0.9rem'\r\n                    }}>\r\n                        {successMessage || error}\r\n                    </div>\r\n                )}\r\n\r\n                {/* Tab Content */}\r\n                {activeTab === 'approvals' ? (\r\n                    <div style={{ flex: 1, overflowY: 'auto', padding: '16px' }}>\r\n                        {loading ? (\r\n                            <div style={{ color: '#ccc', textAlign: 'center', marginTop: '2rem' }}>Loading...</div>\r\n                        ) : (\r\n                            <>\r\n                                <h3 style={{ color: '#fff', marginTop: 0, marginBottom: '1rem' }}>Pending Approvals</h3>\r\n                                {users.filter(u => !u.approved).length === 0 ? (\r\n                                    <div style={{ color: '#888', textAlign: 'center', marginTop: '2rem', fontStyle: 'italic' }}>\r\n                                        No pending user approvals\r\n                                    </div>\r\n                                ) : (\r\n                                    <div style={{ marginBottom: '2rem' }}>\r\n                                        {users.filter(u => !u.approved).map(user => (\r\n                                            <div key={user.id} style={{\r\n                                                display: 'flex',\r\n                                                alignItems: 'center',\r\n                                                justifyContent: 'space-between',\r\n                                                padding: '12px',\r\n                                                backgroundColor: '#252526',\r\n                                                borderRadius: '4px',\r\n                                                marginBottom: '8px',\r\n                                                border: '1px solid #444'\r\n                                            }}>\r\n                                                <div style={{ flex: 1 }}>\r\n                                                    <div style={{ color: '#fff', fontWeight: 500 }}>{user.email}</div>\r\n                                                    <div style={{ color: '#888', fontSize: '0.85rem', marginTop: '4px' }}>\r\n                                                        Registered: {user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Unknown'}\r\n                                                    </div>\r\n                                                </div>\r\n                                                <button\r\n                                                    onClick={() => handleApproveUser(user.id, true)}\r\n                                                    disabled={loading}\r\n                                                    style={{\r\n                                                        padding: '8px 16px',\r\n                                                        backgroundColor: '#10b981',\r\n                                                        color: '#fff',\r\n                                                        border: 'none',\r\n                                                        borderRadius: '4px',\r\n                                                        cursor: loading ? 'not-allowed' : 'pointer',\r\n                                                        fontWeight: 600,\r\n                                                        opacity: loading ? 0.6 : 1\r\n                                                    }}\r\n                                                >\r\n                                                    Ô£ô Approve\r\n                                                </button>\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                )}\r\n\r\n                                <h3 style={{ color: '#fff', marginTop: '2rem', marginBottom: '1rem' }}>Approved Users</h3>\r\n                                {users.filter(u => u.approved).length === 0 ? (\r\n                                    <div style={{ color: '#888', textAlign: 'center', marginTop: '2rem', fontStyle: 'italic' }}>\r\n                                        No approved users\r\n                                    </div>\r\n                                ) : (\r\n                                    <div>\r\n                                        {users.filter(u => u.approved).map(user => (\r\n                                            <div key={user.id} style={{\r\n                                                display: 'flex',\r\n                                                alignItems: 'center',\r\n                                                justifyContent: 'space-between',\r\n                                                padding: '12px',\r\n                                                backgroundColor: 'rgba(16, 185, 129, 0.05)',\r\n                                                borderRadius: '4px',\r\n                                                marginBottom: '8px',\r\n                                                border: '1px solid rgba(16, 185, 129, 0.2)'\r\n                                            }}>\r\n                                                <div style={{ flex: 1 }}>\r\n                                                    <div style={{ color: '#fff', fontWeight: 500 }}>\r\n                                                        {user.email}\r\n                                                        {user.role === 'admin' && (\r\n                                                            <span style={{\r\n                                                                marginLeft: '8px',\r\n                                                                padding: '2px 8px',\r\n                                                                backgroundColor: '#007acc',\r\n                                                                borderRadius: '4px',\r\n                                                                fontSize: '0.75rem',\r\n                                                                fontWeight: 600\r\n                                                            }}>\r\n                                                                ADMIN\r\n                                                            </span>\r\n                                                        )}\r\n                                                    </div>\r\n                                                    <div style={{ color: '#888', fontSize: '0.85rem', marginTop: '4px' }}>\r\n                                                        Registered: {user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Unknown'}\r\n                                                    </div>\r\n                                                </div>\r\n                                                {user.role !== 'admin' && (\r\n                                                    <button\r\n                                                        onClick={() => handleApproveUser(user.id, false)}\r\n                                                        disabled={loading}\r\n                                                        style={{\r\n                                                            padding: '8px 16px',\r\n                                                            backgroundColor: '#ef4444',\r\n                                                            color: '#fff',\r\n                                                            border: 'none',\r\n                                                            borderRadius: '4px',\r\n                                                            cursor: loading ? 'not-allowed' : 'pointer',\r\n                                                            fontWeight: 600,\r\n                                                            opacity: loading ? 0.6 : 1\r\n                                                        }}\r\n                                                    >\r\n                                                        Ô£ò Revoke\r\n                                                    </button>\r\n                                                )}\r\n                                            </div>\r\n                                        ))}\r\n                                    </div>\r\n                                )}\r\n                            </>\r\n                        )}\r\n                    </div>\r\n                ) : (\r\n                    <>\r\n                        <div style={{ padding: '16px', borderBottom: '1px solid #333', backgroundColor: '#252526' }}>\r\n                            <label style={{ marginRight: '10px', color: '#ccc' }}>Select User:</label>\r\n                            <select\r\n                                value={selectedUser}\r\n                                onChange={(e) => setSelectedUser(e.target.value)}\r\n                                style={{\r\n                                    padding: '8px',\r\n                                    borderRadius: '4px',\r\n                                    backgroundColor: '#333',\r\n                                    color: '#fff',\r\n                                    border: '1px solid #555',\r\n                                    minWidth: '250px'\r\n                                }}\r\n                            >\r\n                                <option value=\"\">-- Select a User --</option>\r\n                                {users.filter(u => u.approved).map(u => (\r\n                                    <option key={u.id} value={u.id}>{u.email}</option>\r\n                                ))}\r\n                            </select>\r\n                        </div>\r\n\r\n                        <div style={{ flex: 1, overflowY: 'auto', padding: '16px' }}>\r\n                            {loading ? (\r\n                                <div style={{ color: '#ccc', textAlign: 'center', marginTop: '2rem' }}>Loading...</div>\r\n                            ) : (\r\n                                <div style={{ color: '#ccc' }}>\r\n                                    {selectedUser ? (\r\n                                        <>\r\n                                            <div style={{ marginBottom: '1rem', fontStyle: 'italic', fontSize: '0.9rem', color: '#888' }}>\r\n                                                Assign permissions to individual nodes. \"None\" means the user cannot see the node.\r\n                                            </div>\r\n                                            {renderTree()}\r\n                                        </>\r\n                                    ) : (\r\n                                        <div style={{ textAlign: 'center', marginTop: '4rem', color: '#666' }}>\r\n                                            Please select an approved user to manage permissions\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    </>\r\n                )}\r\n            </div>\r\n        </div>,\r\n        document.body\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\Auth.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":73,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2768,2771],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2768,2771],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { supabase } from '../lib/supabase';\r\nimport tulkahLogo from '../assets/tulkah-logo.png';\r\n\r\nexport const Auth: React.FC = () => {\r\n    const [loading, setLoading] = useState(false);\r\n    const [email, setEmail] = useState('');\r\n    const [password, setPassword] = useState('');\r\n    const [isSignUp, setIsSignUp] = useState(false);\r\n    const [message, setMessage] = useState<{ type: 'success' | 'error' | 'warning', text: string } | null>(null);\r\n\r\n    const handleSubmit = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        setLoading(true);\r\n        setMessage(null);\r\n\r\n        try {\r\n            if (isSignUp) {\r\n                // Sign up with email verification\r\n                const { error } = await supabase.auth.signUp({\r\n                    email,\r\n                    password,\r\n                    options: {\r\n                        emailRedirectTo: window.location.origin,\r\n                    },\r\n                });\r\n\r\n                if (error) throw error;\r\n\r\n                setMessage({\r\n                    type: 'success',\r\n                    text: 'Registration successful! Please check your email to verify your account, then wait for admin approval.'\r\n                });\r\n                setEmail('');\r\n                setPassword('');\r\n            } else {\r\n                // Sign in\r\n                const { data, error } = await supabase.auth.signInWithPassword({\r\n                    email,\r\n                    password,\r\n                });\r\n\r\n                if (error) throw error;\r\n\r\n                // Check if user is approved\r\n                const { data: roleData, error: roleError } = await supabase\r\n                    .from('user_roles')\r\n                    .select('approved')\r\n                    .eq('user_id', data.user.id)\r\n                    .single();\r\n\r\n                if (roleError) {\r\n                    // If no role exists yet, they're not approved\r\n                    await supabase.auth.signOut();\r\n                    setMessage({\r\n                        type: 'warning',\r\n                        text: 'Your account is pending admin approval. Please contact an administrator.'\r\n                    });\r\n                    return;\r\n                }\r\n\r\n                if (!roleData.approved) {\r\n                    await supabase.auth.signOut();\r\n                    setMessage({\r\n                        type: 'warning',\r\n                        text: 'Your account is pending admin approval. Please contact an administrator.'\r\n                    });\r\n                    return;\r\n                }\r\n\r\n                // If approved, login succeeds and App.tsx will handle the session\r\n            }\r\n        } catch (error: any) {\r\n            setMessage({\r\n                type: 'error',\r\n                text: error.error_description || error.message\r\n            });\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    return (\r\n        <div style={{\r\n            display: 'flex',\r\n            flexDirection: 'column',\r\n            alignItems: 'center',\r\n            justifyContent: 'center',\r\n            height: '100vh',\r\n            backgroundColor: 'var(--color-bg-primary)',\r\n            color: 'var(--color-text-primary)',\r\n            padding: '20px'\r\n        }}>\r\n            <div style={{\r\n                maxWidth: '400px',\r\n                width: '100%',\r\n                padding: '2rem',\r\n                backgroundColor: 'var(--color-bg-secondary)',\r\n                borderRadius: '8px',\r\n                boxShadow: '0 4px 6px rgba(0, 0, 0, 0.1)',\r\n                textAlign: 'center'\r\n            }}>\r\n                <img\r\n                    src={tulkahLogo}\r\n                    alt=\"Tulkah AI\"\r\n                    style={{\r\n                        height: '100px',\r\n                        marginBottom: '2rem',\r\n                        borderRadius: '8px'\r\n                    }}\r\n                />\r\n                <h1 style={{ marginBottom: '1.5rem', fontSize: '1.5rem' }}>\r\n                    {isSignUp ? 'Create Account' : 'Welcome Back'}\r\n                </h1>\r\n                <p style={{ marginBottom: '2rem', color: '#9ca3af' }}>\r\n                    {isSignUp \r\n                        ? 'Register for an account. You will need admin approval to access the system.' \r\n                        : 'Sign in with your email and password'}\r\n                </p>\r\n\r\n                <form onSubmit={handleSubmit} style={{ display: 'flex', flexDirection: 'column', gap: '1rem' }}>\r\n                    <input\r\n                        type=\"email\"\r\n                        placeholder=\"Your email address\"\r\n                        value={email}\r\n                        onChange={(e) => setEmail(e.target.value)}\r\n                        required\r\n                        style={{\r\n                            padding: '0.75rem',\r\n                            borderRadius: '4px',\r\n                            border: '1px solid var(--color-border)',\r\n                            backgroundColor: 'var(--color-bg-primary)',\r\n                            color: 'var(--color-text-primary)',\r\n                            fontSize: '1rem'\r\n                        }}\r\n                    />\r\n                    <input\r\n                        type=\"password\"\r\n                        placeholder=\"Your password\"\r\n                        value={password}\r\n                        onChange={(e) => setPassword(e.target.value)}\r\n                        required\r\n                        minLength={6}\r\n                        style={{\r\n                            padding: '0.75rem',\r\n                            borderRadius: '4px',\r\n                            border: '1px solid var(--color-border)',\r\n                            backgroundColor: 'var(--color-bg-primary)',\r\n                            color: 'var(--color-text-primary)',\r\n                            fontSize: '1rem'\r\n                        }}\r\n                    />\r\n                    <button\r\n                        type=\"submit\"\r\n                        disabled={loading}\r\n                        style={{\r\n                            padding: '0.75rem',\r\n                            borderRadius: '4px',\r\n                            border: 'none',\r\n                            backgroundColor: 'var(--color-primary)',\r\n                            color: '#fff',\r\n                            fontSize: '1rem',\r\n                            cursor: loading ? 'not-allowed' : 'pointer',\r\n                            opacity: loading ? 0.7 : 1,\r\n                            fontWeight: 600\r\n                        }}\r\n                    >\r\n                        {loading ? (isSignUp ? 'Creating account...' : 'Signing in...') : (isSignUp ? 'Sign Up' : 'Sign In')}\r\n                    </button>\r\n                </form>\r\n\r\n                <button\r\n                    onClick={() => {\r\n                        setIsSignUp(!isSignUp);\r\n                        setMessage(null);\r\n                        setEmail('');\r\n                        setPassword('');\r\n                    }}\r\n                    style={{\r\n                        marginTop: '1rem',\r\n                        padding: '0.5rem',\r\n                        background: 'none',\r\n                        border: 'none',\r\n                        color: 'var(--color-primary)',\r\n                        cursor: 'pointer',\r\n                        fontSize: '0.9rem',\r\n                        textDecoration: 'underline'\r\n                    }}\r\n                >\r\n                    {isSignUp ? 'Already have an account? Sign In' : 'Need an account? Sign Up'}\r\n                </button>\r\n\r\n                {message && (\r\n                    <div style={{\r\n                        marginTop: '1.5rem',\r\n                        padding: '0.75rem',\r\n                        borderRadius: '4px',\r\n                        backgroundColor: message.type === 'success' \r\n                            ? 'rgba(16, 185, 129, 0.1)' \r\n                            : message.type === 'warning'\r\n                            ? 'rgba(245, 158, 11, 0.1)'\r\n                            : 'rgba(239, 68, 68, 0.1)',\r\n                        color: message.type === 'success' \r\n                            ? '#10b981' \r\n                            : message.type === 'warning'\r\n                            ? '#f59e0b'\r\n                            : '#ef4444',\r\n                        border: `1px solid ${message.type === 'success' \r\n                            ? '#10b981' \r\n                            : message.type === 'warning'\r\n                            ? '#f59e0b'\r\n                            : '#ef4444'}`\r\n                    }}>\r\n                        {message.text}\r\n                    </div>\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\ClassificationModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":116,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":116,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4566,4569],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4566,4569],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":167,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":167,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6437,6440],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6437,6440],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'expandedTagIds.size'. Either include it or remove the dependency array.","line":212,"column":8,"nodeType":"ArrayExpression","endLine":212,"endColumn":14,"suggestions":[{"desc":"Update the dependencies array to be: [expandedTagIds.size, tags]","fix":{"range":[7799,7805],"text":"[expandedTagIds.size, tags]"}}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport type { TagTreeNode } from '../types/tags';\r\nimport type { DocumentNode } from '../types';\r\nimport { TagService } from '../services/TagService';\r\nimport { NodeService } from '../services/NodeService';\r\nimport { StorageService } from '../services/StorageService';\r\n\r\ninterface BlobFile {\r\n    name: string;\r\n    path: string;\r\n    referencingNodes: DocumentNode[];\r\n}\r\n\r\ninterface ClassificationModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n}\r\n\r\nexport const ClassificationModal: React.FC<ClassificationModalProps> = ({ isOpen, onClose }) => {\r\n    const [files, setFiles] = useState<BlobFile[]>([]);\r\n    const [tags, setTags] = useState<TagTreeNode[]>([]);\r\n    const [loading, setLoading] = useState(false);\r\n    const [saving, setSaving] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [successMessage, setSuccessMessage] = useState<string | null>(null);\r\n\r\n    // Map of filePath -> Set of tagIds\r\n    const [fileTagMap, setFileTagMap] = useState<Map<string, Set<number>>>(new Map());\r\n    const [originalFileTagMap, setOriginalFileTagMap] = useState<Map<string, Set<number>>>(new Map());\r\n\r\n    // Filter/search\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [selectedFilePath, setSelectedFilePath] = useState<string | null>(null);\r\n    const [expandedTagIds, setExpandedTagIds] = useState<Set<number>>(new Set());\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            loadData();\r\n        }\r\n    }, [isOpen]);\r\n\r\n    const loadData = async () => {\r\n        setLoading(true);\r\n        setError(null);\r\n        try {\r\n            // Fetch nodes, tags, and BlobStore files in parallel\r\n            const [allNodes, fetchedTags, blobFiles] = await Promise.all([\r\n                NodeService.fetchNodes(),\r\n                TagService.fetchTagTree(),\r\n                StorageService.listFiles('BlobStore')\r\n            ]);\r\n\r\n            console.log('ClassificationModal: Loaded', blobFiles.length, 'files,', allNodes.length, 'nodes,', fetchedTags.length, 'tags');\r\n\r\n            setTags(fetchedTags);\r\n\r\n            // Build file list with referencing nodes\r\n            const fileMap = new Map<string, BlobFile>();\r\n\r\n            // Initialize files from BlobStore\r\n            for (const file of blobFiles) {\r\n                fileMap.set(file.name, {\r\n                    name: file.name,\r\n                    path: file.name, // Full path in storage\r\n                    referencingNodes: []\r\n                });\r\n            }\r\n\r\n            // Associate nodes with files\r\n            for (const node of allNodes) {\r\n                if (node.url) {\r\n                    // Extract filename from URL\r\n                    const urlPath = node.url.split('/').pop() || node.url;\r\n\r\n                    if (fileMap.has(urlPath)) {\r\n                        fileMap.get(urlPath)!.referencingNodes.push(node);\r\n                    }\r\n                }\r\n            }\r\n\r\n            const filesArray = Array.from(fileMap.values());\r\n            setFiles(filesArray);\r\n\r\n            // Load existing tag assignments for files\r\n            const tagMap = new Map<string, Set<number>>();\r\n\r\n            // Initialize all files with empty sets first\r\n            for (const file of filesArray) {\r\n                tagMap.set(file.path, new Set());\r\n            }\r\n            setFileTagMap(new Map(tagMap));\r\n            setOriginalFileTagMap(new Map(tagMap.entries()));\r\n\r\n            // Now load actual tags in background\r\n            Promise.all(\r\n                filesArray.map(async (file) => {\r\n                    try {\r\n                        const tagIds = await TagService.getTagsForFile(file.path);\r\n                        if (tagIds.length > 0) {\r\n                            setFileTagMap(prev => {\r\n                                const next = new Map(prev);\r\n                                next.set(file.path, new Set(tagIds));\r\n                                return next;\r\n                            });\r\n                            setOriginalFileTagMap(prev => {\r\n                                const next = new Map(prev);\r\n                                next.set(file.path, new Set(tagIds));\r\n                                return next;\r\n                            });\r\n                        }\r\n                    } catch (err) {\r\n                        console.log('Note: Could not load tags for file', file.path);\r\n                    }\r\n                })\r\n            );\r\n        } catch (err: any) {\r\n            console.error('ClassificationModal load error:', err);\r\n            setError(err.message);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleTagToggle = (filePath: string, tagId: number) => {\r\n        setFileTagMap(prev => {\r\n            const next = new Map(prev);\r\n            const fileTags = new Set(next.get(filePath) || []);\r\n            if (fileTags.has(tagId)) {\r\n                fileTags.delete(tagId);\r\n            } else {\r\n                fileTags.add(tagId);\r\n            }\r\n            next.set(filePath, fileTags);\r\n            return next;\r\n        });\r\n    };\r\n\r\n    const hasChanges = () => {\r\n        for (const [filePath, tagIds] of fileTagMap) {\r\n            const original = originalFileTagMap.get(filePath) || new Set();\r\n            if (tagIds.size !== original.size) return true;\r\n            for (const id of tagIds) {\r\n                if (!original.has(id)) return true;\r\n            }\r\n        }\r\n        return false;\r\n    };\r\n\r\n    const handleSaveAll = async () => {\r\n        setSaving(true);\r\n        setError(null);\r\n        setSuccessMessage(null);\r\n        try {\r\n            let changedCount = 0;\r\n            for (const [filePath, tagIds] of fileTagMap) {\r\n                const original = originalFileTagMap.get(filePath) || new Set();\r\n                const changed = tagIds.size !== original.size ||\r\n                    [...tagIds].some(id => !original.has(id));\r\n                if (changed) {\r\n                    await TagService.assignTagsToFile(filePath, Array.from(tagIds));\r\n                    changedCount++;\r\n                }\r\n            }\r\n            setOriginalFileTagMap(new Map(fileTagMap));\r\n            setSuccessMessage(`Saved tags for ${changedCount} file(s).`);\r\n            setTimeout(() => setSuccessMessage(null), 3000);\r\n        } catch (err: any) {\r\n            setError(err.message);\r\n        } finally {\r\n            setSaving(false);\r\n        }\r\n    };\r\n\r\n    const filteredFiles = files.filter(file =>\r\n        file.name.toLowerCase().includes(searchTerm.toLowerCase())\r\n    );\r\n\r\n    const toggleTagExpand = (tagId: number) => {\r\n        setExpandedTagIds(prev => {\r\n            const next = new Set(prev);\r\n            if (next.has(tagId)) {\r\n                next.delete(tagId);\r\n            } else {\r\n                next.add(tagId);\r\n            }\r\n            return next;\r\n        });\r\n    };\r\n\r\n    // Initialize expanded state with Level 0 and Level 1 tags expanded\r\n    useEffect(() => {\r\n        if (tags.length > 0 && expandedTagIds.size === 0) {\r\n            const expandIds: number[] = [];\r\n\r\n            // Add Level 0 tags\r\n            tags.forEach(t => {\r\n                if (t.level === 0) {\r\n                    expandIds.push(t.id);\r\n                    // Add Level 1 children\r\n                    if (t.childNodes) {\r\n                        t.childNodes.forEach(child => {\r\n                            if (child.level === 1) {\r\n                                expandIds.push(child.id);\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            });\r\n\r\n            setExpandedTagIds(new Set(expandIds));\r\n        }\r\n    }, [tags]);\r\n\r\n    // Recursive render function for tag tree\r\n    const renderTagTree = (tagNodes: TagTreeNode[]): React.ReactNode => {\r\n        return tagNodes.map(tag => {\r\n            const hasChildren = tag.childNodes && tag.childNodes.length > 0;\r\n            const isExpanded = expandedTagIds.has(tag.id);\r\n            const isChecked = selectedFilePath ? (fileTagMap.get(selectedFilePath)?.has(tag.id) || false) : false;\r\n\r\n            return (\r\n                <div key={tag.id}>\r\n                    <div style={{\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        marginLeft: `${tag.level * 20}px`,\r\n                        marginBottom: '4px'\r\n                    }}>\r\n                        {/* Expand/Collapse toggle */}\r\n                        {hasChildren ? (\r\n                            <button\r\n                                onClick={() => toggleTagExpand(tag.id)}\r\n                                style={{\r\n                                    background: 'none',\r\n                                    border: 'none',\r\n                                    cursor: 'pointer',\r\n                                    color: '#888',\r\n                                    padding: '4px',\r\n                                    fontSize: '0.8rem',\r\n                                    width: '20px'\r\n                                }}\r\n                            >\r\n                                {isExpanded ? 'Ôû╝' : 'ÔûÂ'}\r\n                            </button>\r\n                        ) : (\r\n                            <span style={{ width: '20px', display: 'inline-block' }}></span>\r\n                        )}\r\n\r\n                        {/* Tag checkbox */}\r\n                        <label style={{\r\n                            display: 'flex',\r\n                            alignItems: 'center',\r\n                            gap: '0.5rem',\r\n                            flex: 1,\r\n                            padding: '0.4rem 0.75rem',\r\n                            backgroundColor: isChecked ? 'rgba(124, 58, 237, 0.3)' : 'transparent',\r\n                            borderRadius: '4px',\r\n                            cursor: 'pointer',\r\n                            borderLeft: isChecked ? '3px solid #8b5cf6' : '3px solid transparent'\r\n                        }}>\r\n                            <input\r\n                                type=\"checkbox\"\r\n                                checked={isChecked}\r\n                                onChange={() => selectedFilePath && handleTagToggle(selectedFilePath, tag.id)}\r\n                                style={{\r\n                                    width: '16px',\r\n                                    height: '16px',\r\n                                    accentColor: '#8b5cf6'\r\n                                }}\r\n                            />\r\n                            <span style={{\r\n                                color: isChecked ? '#c4b5fd' : '#ccc',\r\n                                fontWeight: isChecked ? 'bold' : 'normal'\r\n                            }}>\r\n                                {tag.name}\r\n                            </span>\r\n                        </label>\r\n                    </div>\r\n\r\n                    {/* Children (if expanded) */}\r\n                    {hasChildren && isExpanded && renderTagTree(tag.childNodes)}\r\n                </div>\r\n            );\r\n        });\r\n    };\r\n\r\n    const getSelectedTagNames = (): string[] => {\r\n        if (!selectedFilePath) return [];\r\n        const selectedIds = fileTagMap.get(selectedFilePath) || new Set();\r\n        const names: string[] = [];\r\n\r\n        const traverse = (nodes: TagTreeNode[]) => {\r\n            nodes.forEach(node => {\r\n                if (selectedIds.has(node.id)) {\r\n                    names.push(node.name);\r\n                }\r\n                if (node.childNodes && node.childNodes.length > 0) {\r\n                    traverse(node.childNodes);\r\n                }\r\n            });\r\n        };\r\n\r\n        traverse(tags);\r\n        return names;\r\n    };\r\n\r\n    const selectedTagNames = getSelectedTagNames();\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return (\r\n        <div style={{\r\n            position: 'fixed',\r\n            top: 0,\r\n            left: 0,\r\n            right: 0,\r\n            bottom: 0,\r\n            backgroundColor: 'rgba(0,0,0,0.8)',\r\n            display: 'flex',\r\n            justifyContent: 'center',\r\n            alignItems: 'center',\r\n            zIndex: 1000\r\n        }}>\r\n            <div style={{\r\n                backgroundColor: '#1a1a2e',\r\n                color: '#fff',\r\n                borderRadius: '12px',\r\n                width: '90%',\r\n                maxWidth: '1200px',\r\n                height: '85vh',\r\n                display: 'flex',\r\n                flexDirection: 'column',\r\n                boxShadow: '0 8px 32px rgba(0,0,0,0.5)',\r\n                overflow: 'hidden'\r\n            }}>\r\n                {/* Header */}\r\n                <div style={{\r\n                    padding: '1.5rem',\r\n                    borderBottom: '1px solid #333',\r\n                    display: 'flex',\r\n                    justifyContent: 'space-between',\r\n                    alignItems: 'center',\r\n                    background: 'linear-gradient(135deg, #16213e 0%, #1a1a2e 100%)'\r\n                }}>\r\n                    <h2 style={{ margin: 0, fontSize: '1.4rem' }}>­ƒôü Classification</h2>\r\n                    <div style={{ display: 'flex', gap: '1rem', alignItems: 'center' }}>\r\n                        {hasChanges() && (\r\n                            <button\r\n                                onClick={handleSaveAll}\r\n                                disabled={saving}\r\n                                style={{\r\n                                    padding: '0.6rem 1.2rem',\r\n                                    backgroundColor: '#10b981',\r\n                                    color: 'white',\r\n                                    border: 'none',\r\n                                    borderRadius: '6px',\r\n                                    cursor: 'pointer',\r\n                                    fontWeight: 'bold'\r\n                                }}\r\n                            >\r\n                                {saving ? 'Saving...' : '­ƒÆ¥ Save All Changes'}\r\n                            </button>\r\n                        )}\r\n                        <button\r\n                            onClick={onClose}\r\n                            style={{\r\n                                background: 'none',\r\n                                border: 'none',\r\n                                color: '#888',\r\n                                fontSize: '1.5rem',\r\n                                cursor: 'pointer'\r\n                            }}\r\n                        >\r\n                            Ô£ò\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Messages */}\r\n                {error && (\r\n                    <div style={{ backgroundColor: 'rgba(239, 68, 68, 0.2)', color: '#f87171', padding: '0.75rem 1.5rem' }}>\r\n                        {error}\r\n                    </div>\r\n                )}\r\n                {successMessage && (\r\n                    <div style={{ backgroundColor: 'rgba(16, 185, 129, 0.2)', color: '#34d399', padding: '0.75rem 1.5rem' }}>\r\n                        {successMessage}\r\n                    </div>\r\n                )}\r\n\r\n                {/* Main Content */}\r\n                <div style={{ flex: 1, display: 'flex', overflow: 'hidden' }}>\r\n                    {/* Left Panel - Objects List */}\r\n                    <div style={{\r\n                        width: '350px',\r\n                        borderRight: '1px solid #333',\r\n                        display: 'flex',\r\n                        flexDirection: 'column',\r\n                        backgroundColor: '#0f0f1a'\r\n                    }}>\r\n                        <div style={{ padding: '1rem' }}>\r\n                            <input\r\n                                type=\"text\"\r\n                                placeholder=\"­ƒöì Search objects...\"\r\n                                value={searchTerm}\r\n                                onChange={(e) => setSearchTerm(e.target.value)}\r\n                                style={{\r\n                                    width: '100%',\r\n                                    padding: '0.6rem 1rem',\r\n                                    borderRadius: '6px',\r\n                                    border: '1px solid #333',\r\n                                    backgroundColor: '#1a1a2e',\r\n                                    color: '#fff'\r\n                                }}\r\n                            />\r\n                        </div>\r\n                        <div style={{ flex: 1, overflowY: 'auto', padding: '0 1rem 1rem' }}>\r\n                            {loading ? (\r\n                                <div style={{ textAlign: 'center', padding: '2rem', color: '#666' }}>Loading...</div>\r\n                            ) : filteredFiles.length === 0 ? (\r\n                                <div style={{ textAlign: 'center', padding: '2rem', color: '#666' }}>No objects found</div>\r\n                            ) : (\r\n                                filteredFiles.map(file => {\r\n                                    const fileTags = fileTagMap.get(file.path) || new Set();\r\n                                    const tagCount = fileTags.size;\r\n                                    const isSelected = selectedFilePath === file.path;\r\n\r\n                                    return (\r\n                                        <div\r\n                                            key={file.path}\r\n                                            onClick={() => setSelectedFilePath(file.path)}\r\n                                            style={{\r\n                                                padding: '0.75rem 1rem',\r\n                                                marginBottom: '0.5rem',\r\n                                                backgroundColor: isSelected ? '#3b82f6' : '#1e1e3f',\r\n                                                borderRadius: '8px',\r\n                                                cursor: 'pointer',\r\n                                                transition: 'all 0.2s',\r\n                                                border: isSelected ? '2px solid #60a5fa' : '2px solid transparent'\r\n                                            }}\r\n                                        >\r\n                                            <div style={{ fontWeight: 'bold', marginBottom: '0.25rem' }}>\r\n                                                {file.name}\r\n                                            </div>\r\n                                            <div style={{ fontSize: '0.8rem', color: '#888' }}>\r\n                                                {tagCount > 0 ? (\r\n                                                    <span style={{ color: '#a78bfa' }}>­ƒÅÀ´©Å {tagCount} tag(s)</span>\r\n                                                ) : (\r\n                                                    <span>No tags</span>\r\n                                                )}\r\n                                            </div>\r\n                                        </div>\r\n                                    );\r\n                                })\r\n                            )}\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Right Panel - Tag Assignment */}\r\n                    <div style={{ flex: 1, display: 'flex', flexDirection: 'column', backgroundColor: '#16213e' }}>\r\n                        {selectedFilePath ? (\r\n                            <>\r\n                                <div style={{ padding: '1.5rem', borderBottom: '1px solid #333' }}>\r\n                                    <h3 style={{ margin: 0, color: '#60a5fa' }}>\r\n                                        {files.find(f => f.path === selectedFilePath)?.name}\r\n                                    </h3>\r\n                                    <p style={{ margin: '0.5rem 0 0', color: '#888', fontSize: '0.9rem' }}>\r\n                                        {selectedTagNames.length > 0 ? (\r\n                                            <span style={{ color: '#a78bfa' }}>\r\n                                                {selectedTagNames.join(', ')}\r\n                                            </span>\r\n                                        ) : (\r\n                                            'Select tags to assign to this object'\r\n                                        )}\r\n                                    </p>\r\n                                </div>\r\n                                <div style={{ flex: 1, overflowY: 'auto', padding: '1.5rem' }}>\r\n                                    {renderTagTree(tags)}\r\n                                </div>\r\n                            </>\r\n                        ) : (\r\n                            <div style={{\r\n                                flex: 1,\r\n                                display: 'flex',\r\n                                alignItems: 'center',\r\n                                justifyContent: 'center',\r\n                                color: '#666',\r\n                                flexDirection: 'column',\r\n                                gap: '1rem'\r\n                            }}>\r\n                                <span style={{ fontSize: '3rem' }}>­ƒæê</span>\r\n                                <span style={{ textAlign: 'center' }}>Select a file from the left<br />to assign tags</span>\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\CurationModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":31,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":31,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1610,1613],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1610,1613],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":85,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":85,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3976,3979],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3976,3979],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":100,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":100,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4524,4527],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4524,4527],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":120,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5040,5043],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5040,5043],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":145,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6021,6024],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6021,6024],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":193,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":193,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7920,7923],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7920,7923],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":226,"column":38,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":226,"endColumn":41,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9541,9544],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9541,9544],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":250,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":250,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10536,10539],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10536,10539],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":549,"column":85,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":549,"endColumn":88,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[29044,29047],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[29044,29047],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":9,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useMemo, useRef } from 'react';\r\nimport { McpService } from '../services/McpService';\r\nimport { NotebookLMService } from '../services/NotebookLMService';\r\nimport type { NotebookLMNotebook } from '../services/NotebookLMService';\r\nimport { NodeService } from '../services/NodeService';\r\nimport { TagService } from '../services/TagService';\r\nimport { StorageService } from '../services/StorageService';\r\nimport type { TagTreeNode } from '../types/tags';\r\nimport type { DocumentNode } from '../types';\r\n\r\ninterface CurationModalProps {\r\n    node: DocumentNode;\r\n    onClose: () => void;\r\n    onArtifactSaved: () => void;\r\n}\r\n\r\nexport const CurationModal: React.FC<CurationModalProps> = ({ node, onClose, onArtifactSaved }) => {\r\n    const [notebooks, setNotebooks] = useState<NotebookLMNotebook[]>([]);\r\n    const [selectedNotebookId, setSelectedNotebookId] = useState('');\r\n    const [deliverable, setDeliverable] = useState<'infographic' | 'video' | 'audio' | 'slides'>('infographic');\r\n    const [language, setLanguage] = useState('en');\r\n    const [searchTerm, setSearchTerm] = useState('');\r\n    const [promptText, setPromptText] = useState('');\r\n\r\n    // Video specific\r\n    const [videoFormat, setVideoFormat] = useState(1); // 1: Explainer, 2: Brief\r\n    const [videoStyle, setVideoStyle] = useState(2); // 1: Classic, 2: Whiteboard, 3: Anime, 4: Retro, 5: Heritage, 6: Paper-craft\r\n\r\n    const [isExecuting, setIsExecuting] = useState(false);\r\n    const [statusMessage, setStatusMessage] = useState('');\r\n    const [generatedArtifact, setGeneratedArtifact] = useState<any>(null);\r\n    const [isPolling, setIsPolling] = useState(false);\r\n\r\n    // Save state\r\n    const [showSaveFields, setShowSaveFields] = useState(false);\r\n    const [artifactName, setArtifactName] = useState('Generated Artifact');\r\n    const [availableTags, setAvailableTags] = useState<TagTreeNode[]>([]);\r\n    const [selectedTagIds, setSelectedTagIds] = useState<Set<number>>(new Set());\r\n\r\n    // UI state\r\n    const [isDropdownOpen, setIsDropdownOpen] = useState(false);\r\n    const [isLoadingNotebooks, setIsLoadingNotebooks] = useState(true);\r\n    const [isRefreshing, setIsRefreshing] = useState(false);\r\n    const [isUpdatingCookies, setIsUpdatingCookies] = useState(false);\r\n    const dropdownRef = useRef<HTMLDivElement>(null);\r\n\r\n    useEffect(() => {\r\n        const loadInitialData = async () => {\r\n            try {\r\n                setIsLoadingNotebooks(true);\r\n                const [nbList, tags] = await Promise.all([\r\n                    NotebookLMService.fetchNotebooks(),\r\n                    TagService.fetchTagTree()\r\n                ]);\r\n                setNotebooks(nbList);\r\n                setAvailableTags(tags);\r\n            } catch (err) {\r\n                console.error('Failed to load curation data:', err);\r\n                setStatusMessage('Failed to load notebooks. Try refreshing.');\r\n            } finally {\r\n                setIsLoadingNotebooks(false);\r\n            }\r\n        };\r\n        loadInitialData();\r\n\r\n        // Close dropdown on click outside\r\n        const handleClickOutside = (event: MouseEvent) => {\r\n            if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {\r\n                setIsDropdownOpen(false);\r\n            }\r\n        };\r\n        document.addEventListener('mousedown', handleClickOutside);\r\n        return () => document.removeEventListener('mousedown', handleClickOutside);\r\n    }, []);\r\n\r\n    const handleRefreshNotebooks = async () => {\r\n        setIsRefreshing(true);\r\n        setStatusMessage('Refreshing notebooks from NotebookLM...');\r\n        try {\r\n            await NotebookLMService.refreshNotebooks();\r\n            const nbList = await NotebookLMService.fetchNotebooks();\r\n            setNotebooks(nbList);\r\n            setStatusMessage('Notebooks refreshed successfully!');\r\n            setTimeout(() => setStatusMessage(''), 3000);\r\n        } catch (err: any) {\r\n            setStatusMessage('');\r\n            alert('Failed to refresh notebooks: ' + err.message);\r\n        } finally {\r\n            setIsRefreshing(false);\r\n        }\r\n    };\r\n\r\n    const handleUpdateCookies = async () => {\r\n        setIsUpdatingCookies(true);\r\n        setStatusMessage('Updating NotebookLM cookies...');\r\n        try {\r\n            await NotebookLMService.updateCookies();\r\n            setStatusMessage('Cookies updated successfully!');\r\n            setTimeout(() => setStatusMessage(''), 3000);\r\n        } catch (err: any) {\r\n            setStatusMessage('');\r\n            alert('Failed to update cookies: ' + err.message);\r\n        } finally {\r\n            setIsUpdatingCookies(false);\r\n        }\r\n    };\r\n\r\n\r\n    const handleExecute = async () => {\r\n        if (!selectedNotebookId) {\r\n            alert('Please select a notebook');\r\n            return;\r\n        }\r\n\r\n        setIsExecuting(true);\r\n        setStatusMessage('Starting generation...');\r\n        setGeneratedArtifact(null);\r\n\r\n        try {\r\n            const params: any = {\r\n                notebook_id: selectedNotebookId,\r\n                artifact_type: deliverable,\r\n                language: language,\r\n                prompt: promptText\r\n            };\r\n\r\n            if (deliverable === 'video') {\r\n                params.format_code = videoFormat;\r\n                params.style_code = videoStyle;\r\n            } else if (deliverable === 'infographic') {\r\n                params.orientation = 1; // Default landscape\r\n                params.detail_level = 2; // Default standard\r\n            }\r\n            // Add more as needed\r\n\r\n            const result = await McpService.createArtifact(params);\r\n\r\n            // Check if result has a status or error\r\n            if (result && result.status === 'error') {\r\n                throw new Error(result.error || 'Failed to trigger generation');\r\n            }\r\n\r\n            setStatusMessage('Generation requested. Polling for status...');\r\n            startPolling();\r\n        } catch (err: any) {\r\n            setStatusMessage('');\r\n            alert('Execution failed: ' + (err.response?.data?.error || err.message));\r\n            setIsExecuting(false);\r\n        }\r\n    };\r\n\r\n    const startPolling = () => {\r\n        setIsPolling(true);\r\n        const pollInterval = setInterval(async () => {\r\n            try {\r\n                const artifacts = await McpService.getStatus(selectedNotebookId);\r\n                // Find our artifact. Statuses: 'completed', 'processing', 'failed', 'pending'\r\n                // For simplicity, we'll look for the latest one of the requested type\r\n                // In a real app, we'd use an ID returned by createArtifact\r\n                const latest = artifacts[0]; // Assuming newest is first\r\n\r\n                if (latest && latest.status === 'completed') {\r\n                    clearInterval(pollInterval);\r\n                    setIsPolling(false);\r\n                    setIsExecuting(false);\r\n                    setStatusMessage('Notebook artifact generated');\r\n                    setGeneratedArtifact(latest);\r\n                } else if (latest && latest.status === 'failed') {\r\n                    clearInterval(pollInterval);\r\n                    setIsPolling(false);\r\n                    setIsExecuting(false);\r\n                    setStatusMessage('Generation failed');\r\n                }\r\n            } catch (err) {\r\n                console.error('Polling error:', err);\r\n            }\r\n        }, 5000);\r\n    };\r\n\r\n    const handleSaveArtifact = async () => {\r\n        if (!generatedArtifact) return;\r\n\r\n        try {\r\n            setIsExecuting(true);\r\n            setStatusMessage('Saving artifact...');\r\n\r\n            const newNode = await NodeService.createNodeWithRPC(\r\n                artifactName,\r\n                node.nodeID,\r\n                'Generated Artifact'\r\n            );\r\n\r\n            const urltypeMap: Record<string, any> = {\r\n                'infographic': 'InfoGraphic',\r\n                'video': 'Video',\r\n                'audio': 'Audio',\r\n                'slides': 'Url' // Map slides to Url matching existing frontend patterns\r\n            };\r\n\r\n            const urlType = urltypeMap[deliverable] || 'Url';\r\n            // Start with proxy URL as the primary fallback, as it handles authentication\r\n            let finalUrl = McpService.getProxyUrl(generatedArtifact.url);\r\n\r\n            // Internalize to Supabase Storage\r\n            try {\r\n                setStatusMessage('Internalizing artifact to BlobStore...');\r\n                const blob = await McpService.fetchBlob(generatedArtifact.url);\r\n\r\n                // Determine extension\r\n                const extMap: Record<string, string> = {\r\n                    'infographic': '.png',\r\n                    'video': '.mp4',\r\n                    'audio': '.mp3',\r\n                    'slides': '.pdf'\r\n                };\r\n                const extension = extMap[deliverable] || '.bin';\r\n                const fileName = `${deliverable}_${Date.now()}${extension}`;\r\n\r\n                // Convert Blob to File (needed by StorageService if it expects File, \r\n                // but usually Blob works for upload)\r\n                const file = new File([blob], fileName, { type: blob.type });\r\n\r\n                const uploadResult = await StorageService.uploadFile(file, fileName);\r\n                finalUrl = StorageService.getPublicUrl('BlobStore', uploadResult.path);\r\n                console.log('Artifact internalized to:', finalUrl);\r\n            } catch (internalizeErr: any) {\r\n                console.error('Failed to internalize artifact:', internalizeErr);\r\n                const isAuthError = internalizeErr.message?.includes('Authentication') ||\r\n                    internalizeErr.message?.includes('Login');\r\n\r\n                if (isAuthError) {\r\n                    setStatusMessage('Save warning: Failed to internalize (Auth Expired). Using external link.');\r\n                } else {\r\n                    setStatusMessage('Save warning: Failed to internalize. Using external link.');\r\n                }\r\n                // Fallback to original URL is already set\r\n            }\r\n\r\n            await NodeService.updateNode(newNode.nodeID, {\r\n                url: finalUrl,\r\n                urltype: urlType\r\n            });\r\n\r\n            if (selectedTagIds.size > 0) {\r\n                await TagService.assignTags(newNode.nodeID, Array.from(selectedTagIds));\r\n            }\r\n\r\n            onArtifactSaved();\r\n            onClose();\r\n        } catch (err: any) {\r\n            alert('Failed to save artifact: ' + err.message);\r\n            setIsExecuting(false);\r\n            setStatusMessage('');\r\n        }\r\n    };\r\n\r\n    const groupedNotebooks = useMemo(() => {\r\n        const filtered = notebooks.filter(nb =>\r\n            nb.notebook_nm.toLowerCase().includes(searchTerm.toLowerCase())\r\n        );\r\n\r\n        const groups: Record<string, NotebookLMNotebook[]> = {};\r\n\r\n        filtered.forEach(nb => {\r\n            const group = nb.notebook_grp;\r\n            if (!groups[group]) groups[group] = [];\r\n            groups[group].push(nb);\r\n        });\r\n\r\n        // Sort groups in preferred order\r\n        const groupOrder = ['Antigravity', 'Tulkah AI', 'Client', 'MDM', 'Process Mining', 'AI Developments', 'Other'];\r\n        return groupOrder\r\n            .filter(group => groups[group] && groups[group].length > 0)\r\n            .map(group => ({\r\n                name: group,\r\n                notebooks: groups[group]\r\n            }));\r\n    }, [notebooks, searchTerm]);\r\n\r\n    const selectedNotebookTitle = useMemo(() => {\r\n        const selected = notebooks.find(nb => nb.notebook_id === selectedNotebookId);\r\n        if (!selected) return '-- Select a Notebook --';\r\n        return `${selected.notebook_nm} (ID: ${selected.notebook_id})`;\r\n    }, [notebooks, selectedNotebookId]);\r\n\r\n    const renderTagCheckboxes = (nodes: TagTreeNode[]): React.ReactNode => {\r\n        return (\r\n            <ul style={{ listStyle: 'none', paddingLeft: nodes[0]?.level > 0 ? '15px' : '0', margin: 0 }}>\r\n                {nodes.map(nb => (\r\n                    <li key={nb.id} style={{ marginBottom: '4px' }}>\r\n                        <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>\r\n                            <input\r\n                                type=\"checkbox\"\r\n                                checked={selectedTagIds.has(nb.id)}\r\n                                onChange={() => {\r\n                                    const next = new Set(selectedTagIds);\r\n                                    if (next.has(nb.id)) next.delete(nb.id);\r\n                                    else next.add(nb.id);\r\n                                    setSelectedTagIds(next);\r\n                                }}\r\n                            />\r\n                            <span>{nb.name}</span>\r\n                        </label>\r\n                        {nb.childNodes && nb.childNodes.length > 0 && renderTagCheckboxes(nb.childNodes)}\r\n                    </li>\r\n                ))}\r\n            </ul>\r\n        );\r\n    };\r\n\r\n    return (\r\n        <div className=\"modal-overlay\" onClick={onClose}>\r\n            <style>{`\r\n                @keyframes slideDown {\r\n                    from { opacity: 0; transform: translateY(-10px); }\r\n                    to { opacity: 1; transform: translateY(0); }\r\n                }\r\n                @keyframes fadeIn {\r\n                    from { opacity: 0; }\r\n                    to { opacity: 1; }\r\n                }\r\n                @keyframes spin {\r\n                    0% { transform: rotate(0deg); }\r\n                    100% { transform: rotate(360deg); }\r\n                }\r\n                .loader {\r\n                    display: inline-block;\r\n                    animation: spin 1s linear infinite;\r\n                }\r\n                .custom-select:hover {\r\n                    border-color: #4b5563 !important;\r\n                    background-color: #2d3748 !important;\r\n                }\r\n                .custom-select.open {\r\n                    border-color: #3b82f6 !important;\r\n                    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2) !important;\r\n                }\r\n            `}</style>\r\n            <div className=\"modal-content curation-modal\" onClick={e => e.stopPropagation()} style={{ width: '600px' }}>\r\n                <div className=\"modal-header\">\r\n                    <h2>Curation: {node.title}</h2>\r\n                    <button className=\"icon-btn\" onClick={onClose}>Ô£ò</button>\r\n                </div>\r\n\r\n                <div className=\"modal-body\" style={{ padding: '1.5rem' }}>\r\n                    {!showSaveFields ? (\r\n                        <>\r\n                            <div style={{ marginBottom: '1.5rem', position: 'relative' }} ref={dropdownRef}>\r\n                                <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.9rem', color: '#94a3b8' }}>Select Notebook:</label>\r\n\r\n                                <div\r\n                                    className={`custom-select ${isDropdownOpen ? 'open' : ''}`}\r\n                                    onClick={() => !isLoadingNotebooks && setIsDropdownOpen(!isDropdownOpen)}\r\n                                    style={{\r\n                                        padding: '0.75rem 1rem',\r\n                                        backgroundColor: '#1e293b',\r\n                                        border: '1px solid #334155',\r\n                                        borderRadius: '8px',\r\n                                        cursor: isLoadingNotebooks ? 'not-allowed' : 'pointer',\r\n                                        display: 'flex',\r\n                                        justifyContent: 'space-between',\r\n                                        alignItems: 'center',\r\n                                        transition: 'all 0.2s ease',\r\n                                        boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',\r\n                                        color: selectedNotebookId ? '#f8fafc' : '#64748b'\r\n                                    }}\r\n                                >\r\n                                    <span style={{ whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>\r\n                                        {isLoadingNotebooks ? 'Loading notebooks...' : selectedNotebookTitle}\r\n                                    </span>\r\n                                    <span style={{ transition: 'transform 0.2s', transform: isDropdownOpen ? 'rotate(180deg)' : 'none' }}>Ôû╝</span>\r\n                                </div>\r\n\r\n                                {isDropdownOpen && (\r\n                                    <div style={{\r\n                                        position: 'absolute',\r\n                                        top: '100%',\r\n                                        left: 0,\r\n                                        right: 0,\r\n                                        marginTop: '0.5rem',\r\n                                        backgroundColor: '#1e293b',\r\n                                        border: '1px solid #334155',\r\n                                        borderRadius: '12px',\r\n                                        boxShadow: '0 10px 25px -5px rgba(0, 0, 0, 0.3)',\r\n                                        zIndex: 1000,\r\n                                        overflow: 'hidden',\r\n                                        animation: 'slideDown 0.2s ease-out'\r\n                                    }}>\r\n                                        <div style={{ padding: '0.75rem', borderBottom: '1px solid #334155' }}>\r\n                                            <input\r\n                                                type=\"text\"\r\n                                                placeholder=\"type to search...\"\r\n                                                autoFocus\r\n                                                value={searchTerm}\r\n                                                onClick={e => e.stopPropagation()}\r\n                                                onChange={e => setSearchTerm(e.target.value)}\r\n                                                style={{\r\n                                                    width: '100%',\r\n                                                    padding: '0.6rem 0.75rem',\r\n                                                    fontSize: '0.9rem',\r\n                                                    borderRadius: '6px',\r\n                                                    border: '1px solid #475569',\r\n                                                    backgroundColor: '#0f172a',\r\n                                                    color: '#fff',\r\n                                                    outline: 'none'\r\n                                                }}\r\n                                            />\r\n                                        </div>\r\n                                        <div style={{ maxHeight: '250px', overflowY: 'auto', padding: '0.25rem' }}>\r\n                                            {groupedNotebooks.length === 0 ? (\r\n                                                <div style={{ padding: '2rem', textAlign: 'center', color: '#64748b' }}>\r\n                                                    No notebooks found\r\n                                                </div>\r\n                                            ) : (\r\n                                                groupedNotebooks.map(group => (\r\n                                                    <div key={group.name}>\r\n                                                        <div style={{\r\n                                                            padding: '0.75rem 1rem',\r\n                                                            fontSize: '0.8rem',\r\n                                                            fontWeight: '600',\r\n                                                            color: '#e0e7ff',\r\n                                                            textTransform: 'uppercase',\r\n                                                            letterSpacing: '0.1em',\r\n                                                            background: 'linear-gradient(90deg, rgba(59, 130, 246, 0.15) 0%, rgba(99, 102, 241, 0.05) 100%)',\r\n                                                            borderLeft: '3px solid #3b82f6',\r\n                                                            marginTop: '0.5rem',\r\n                                                            marginBottom: '0.25rem',\r\n                                                            borderRadius: '4px',\r\n                                                            display: 'flex',\r\n                                                            alignItems: 'center',\r\n                                                            gap: '0.5rem'\r\n                                                        }}>\r\n                                                            <span style={{ fontSize: '1rem' }}>­ƒôü</span>\r\n                                                            {group.name}\r\n                                                        </div>\r\n                                                        {group.notebooks.map(nb => (\r\n                                                            <div\r\n                                                                key={nb.notebook_id}\r\n                                                                onClick={(e) => {\r\n                                                                    e.stopPropagation();\r\n                                                                    setSelectedNotebookId(nb.notebook_id);\r\n                                                                    setIsDropdownOpen(false);\r\n                                                                }}\r\n                                                                style={{\r\n                                                                    padding: '0.6rem 1rem',\r\n                                                                    paddingLeft: '1.5rem',\r\n                                                                    cursor: 'pointer',\r\n                                                                    fontSize: '0.9rem',\r\n                                                                    color: selectedNotebookId === nb.notebook_id ? '#3b82f6' : '#cbd5e1',\r\n                                                                    backgroundColor: selectedNotebookId === nb.notebook_id ? '#1e293b' : 'transparent',\r\n                                                                    transition: 'all 0.15s ease',\r\n                                                                    borderRadius: '4px',\r\n                                                                    margin: '0.1rem 0.25rem',\r\n                                                                    textAlign: 'left'\r\n                                                                }}\r\n                                                                onMouseEnter={(e) => {\r\n                                                                    if (selectedNotebookId !== nb.notebook_id) e.currentTarget.style.backgroundColor = '#1e293b';\r\n                                                                }}\r\n                                                                onMouseLeave={(e) => {\r\n                                                                    if (selectedNotebookId !== nb.notebook_id) e.currentTarget.style.backgroundColor = 'transparent';\r\n                                                                }}\r\n                                                            >\r\n                                                                {nb.notebook_nm}\r\n                                                            </div>\r\n                                                        ))}\r\n                                                    </div>\r\n                                                ))\r\n                                            )}\r\n                                        </div>\r\n                                    </div>\r\n                                )}\r\n                            </div>\r\n\r\n                            {/* Show NotebookLM URL when selected */}\r\n                            {selectedNotebookId && (\r\n                                <div style={{\r\n                                    marginBottom: '1.5rem',\r\n                                    padding: '0.75rem',\r\n                                    backgroundColor: '#1e293b',\r\n                                    borderRadius: '6px',\r\n                                    border: '1px solid #334155'\r\n                                }}>\r\n                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.8rem', color: '#94a3b8' }}>\r\n                                        NotebookLM URL:\r\n                                    </label>\r\n                                    <a\r\n                                        href={`https://notebooklm.google.com/notebook/${selectedNotebookId}`}\r\n                                        target=\"_blank\"\r\n                                        rel=\"noopener noreferrer\"\r\n                                        style={{\r\n                                            color: '#3b82f6',\r\n                                            textDecoration: 'none',\r\n                                            fontSize: '0.85rem',\r\n                                            wordBreak: 'break-all',\r\n                                            display: 'block'\r\n                                        }}\r\n                                    >\r\n                                        https://notebooklm.google.com/notebook/{selectedNotebookId}\r\n                                    </a>\r\n                                </div>\r\n                            )}\r\n\r\n                            {/* Refresh and Cookie Update Buttons */}\r\n                            <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '1.5rem' }}>\r\n                                <button\r\n                                    onClick={handleRefreshNotebooks}\r\n                                    disabled={isRefreshing || isLoadingNotebooks}\r\n                                    style={{\r\n                                        flex: 1,\r\n                                        padding: '0.5rem 1rem',\r\n                                        fontSize: '0.85rem',\r\n                                        backgroundColor: isRefreshing ? '#64748b' : '#10b981',\r\n                                        color: '#fff',\r\n                                        border: 'none',\r\n                                        borderRadius: '6px',\r\n                                        cursor: isRefreshing || isLoadingNotebooks ? 'not-allowed' : 'pointer',\r\n                                        fontWeight: 500,\r\n                                        opacity: isRefreshing || isLoadingNotebooks ? 0.6 : 1,\r\n                                        transition: 'all 0.2s ease'\r\n                                    }}\r\n                                >\r\n                                    {isRefreshing ? '­ƒöä Refreshing...' : '­ƒöä Refresh Notebooks'}\r\n                                </button>\r\n                                <button\r\n                                    onClick={handleUpdateCookies}\r\n                                    disabled={isUpdatingCookies}\r\n                                    style={{\r\n                                        flex: 1,\r\n                                        padding: '0.5rem 1rem',\r\n                                        fontSize: '0.85rem',\r\n                                        backgroundColor: isUpdatingCookies ? '#64748b' : '#f59e0b',\r\n                                        color: '#fff',\r\n                                        border: 'none',\r\n                                        borderRadius: '6px',\r\n                                        cursor: isUpdatingCookies ? 'not-allowed' : 'pointer',\r\n                                        fontWeight: 500,\r\n                                        opacity: isUpdatingCookies ? 0.6 : 1,\r\n                                        transition: 'all 0.2s ease'\r\n                                    }}\r\n                                >\r\n                                    {isUpdatingCookies ? '­ƒì¬ Updating...' : '­ƒì¬ Update Cookies'}\r\n                                </button>\r\n                            </div>\r\n\r\n                            <div style={{ marginBottom: '1.5rem' }}>\r\n                                <label style={{ display: 'block', marginBottom: '0.5rem' }}>Deliverable:</label>\r\n                                <select\r\n                                    value={deliverable}\r\n                                    onChange={e => setDeliverable(e.target.value as any)}\r\n                                    style={{ width: '100%', padding: '0.5rem' }}\r\n                                >\r\n                                    <option value=\"infographic\">Infographic</option>\r\n                                    <option value=\"video\">Video</option>\r\n                                    <option value=\"audio\">Audio</option>\r\n                                    <option value=\"slides\">Presentation</option>\r\n                                </select>\r\n                            </div>\r\n\r\n                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>\r\n                                <div>\r\n                                    <label style={{ display: 'block', marginBottom: '0.5rem' }}>Language:</label>\r\n                                    <select\r\n                                        value={language}\r\n                                        onChange={e => setLanguage(e.target.value)}\r\n                                        style={{ width: '100%', padding: '0.5rem' }}\r\n                                    >\r\n                                        <option value=\"en\">English (Default)</option>\r\n                                        <option value=\"es\">Spanish</option>\r\n                                        <option value=\"fr\">French</option>\r\n                                        <option value=\"de\">German</option>\r\n                                        <option value=\"ru\">Russian</option>\r\n                                    </select>\r\n                                </div>\r\n\r\n                                {deliverable === 'video' && (\r\n                                    <>\r\n                                        <div>\r\n                                            <label style={{ display: 'block', marginBottom: '0.5rem' }}>Format:</label>\r\n                                            <select\r\n                                                value={videoFormat}\r\n                                                onChange={e => setVideoFormat(Number(e.target.value))}\r\n                                                style={{ width: '100%', padding: '0.5rem' }}\r\n                                            >\r\n                                                <option value={1}>Explainer</option>\r\n                                                <option value={2}>Brief</option>\r\n                                            </select>\r\n                                        </div>\r\n                                        <div>\r\n                                            <label style={{ display: 'block', marginBottom: '0.5rem' }}>Style:</label>\r\n                                            <select\r\n                                                value={videoStyle}\r\n                                                onChange={e => setVideoStyle(Number(e.target.value))}\r\n                                                style={{ width: '100%', padding: '0.5rem' }}\r\n                                            >\r\n                                                <option value={1}>Classic</option>\r\n                                                <option value={2}>Whiteboard (Default)</option>\r\n                                                <option value={3}>Anime</option>\r\n                                                <option value={4}>Retro Print</option>\r\n                                                <option value={5}>Heritage</option>\r\n                                                <option value={6}>Paper-Craft</option>\r\n                                            </select>\r\n                                        </div>\r\n                                    </>\r\n                                )}\r\n                            </div>\r\n\r\n                            <div style={{ marginBottom: '1.5rem' }}>\r\n                                <label style={{ display: 'block', marginBottom: '0.5rem' }}>Prompt:</label>\r\n                                <textarea\r\n                                    placeholder=\"please type a prompt....\"\r\n                                    value={promptText}\r\n                                    onChange={e => setPromptText(e.target.value)}\r\n                                    style={{ width: '100%', height: '80px', padding: '0.5rem', borderRadius: '4px' }}\r\n                                />\r\n                            </div>\r\n\r\n                            <div style={{ display: 'flex', justifyContent: 'center', marginBottom: '1rem' }}>\r\n                                <button\r\n                                    onClick={handleExecute}\r\n                                    disabled={isExecuting || !selectedNotebookId}\r\n                                    style={{ padding: '0.75rem 2rem', fontSize: '1.1rem' }}\r\n                                >\r\n                                    {isExecuting ? 'Executing...' : 'Execute'}\r\n                                </button>\r\n                            </div>\r\n\r\n                            {statusMessage && (\r\n                                <div style={{\r\n                                    textAlign: 'center',\r\n                                    padding: '1rem',\r\n                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',\r\n                                    borderRadius: '8px',\r\n                                    color: '#3B82F6',\r\n                                    fontWeight: '500'\r\n                                }}>\r\n                                    {statusMessage}\r\n                                    {isPolling && <span className=\"loader\" style={{ marginLeft: '10px' }}>ÔÅ│</span>}\r\n                                </div>\r\n                            )}\r\n\r\n                            {generatedArtifact && (\r\n                                <div style={{ marginTop: '1.5rem', borderTop: '1px solid #333', paddingTop: '1.5rem' }}>\r\n                                    <h3 style={{ marginBottom: '1rem' }}>Preview Generated Artifact</h3>\r\n                                    <div style={{\r\n                                        backgroundColor: '#000',\r\n                                        borderRadius: '8px',\r\n                                        padding: '1rem',\r\n                                        display: 'flex',\r\n                                        flexDirection: 'column',\r\n                                        alignItems: 'center',\r\n                                        gap: '1rem'\r\n                                    }}>\r\n                                        {deliverable === 'infographic' && (\r\n                                            <img src={McpService.getProxyUrl(generatedArtifact.url)} style={{ maxWidth: '100%', borderRadius: '4px' }} alt=\"Preview\" />\r\n                                        )}\r\n                                        {(deliverable === 'video' || deliverable === 'audio') && (\r\n                                            <a href={McpService.getProxyUrl(generatedArtifact.url)} target=\"_blank\" rel=\"noreferrer\" style={{ color: '#3B82F6' }}>\r\n                                                {deliverable === 'video' ? '­ƒô¢´©Å View Video' : '­ƒÄÁ Listen to Audio'}\r\n                                            </a>\r\n                                        )}\r\n                                        {deliverable === 'slides' && (\r\n                                            <a href={McpService.getProxyUrl(generatedArtifact.url)} target=\"_blank\" rel=\"noreferrer\" style={{ color: '#3B82F6' }}>\r\n                                                ­ƒôè View Presentation\r\n                                            </a>\r\n                                        )}\r\n\r\n                                        <button\r\n                                            onClick={() => setShowSaveFields(true)}\r\n                                            style={{ backgroundColor: '#4ade80', color: '#000', fontWeight: 'bold' }}\r\n                                        >\r\n                                            Save curated artifact\r\n                                        </button>\r\n                                    </div>\r\n                                </div>\r\n                            )}\r\n                        </>\r\n                    ) : (\r\n                        <div style={{ animation: 'fadeIn 0.3s ease-out' }}>\r\n                            <h3 style={{ marginBottom: '1.5rem' }}>Save & Classify</h3>\r\n\r\n                            <div style={{ marginBottom: '1.5rem' }}>\r\n                                <label style={{ display: 'block', marginBottom: '0.5rem' }}>Name:</label>\r\n                                <input\r\n                                    type=\"text\"\r\n                                    value={artifactName}\r\n                                    onChange={e => setArtifactName(e.target.value)}\r\n                                    style={{ width: '100%', padding: '0.5rem' }}\r\n                                />\r\n                            </div>\r\n\r\n                            <div style={{ marginBottom: '1.5rem' }}>\r\n                                <label style={{ display: 'block', marginBottom: '0.5rem' }}>Classify with Tags:</label>\r\n                                <div style={{\r\n                                    maxHeight: '200px',\r\n                                    overflowY: 'auto',\r\n                                    backgroundColor: '#222',\r\n                                    padding: '1rem',\r\n                                    borderRadius: '4px'\r\n                                }}>\r\n                                    {renderTagCheckboxes(availableTags)}\r\n                                </div>\r\n                            </div>\r\n\r\n                            {/* Show NotebookLM URL when selected */}\r\n                            {selectedNotebookId && (\r\n                                <div style={{\r\n                                    marginBottom: '1.5rem',\r\n                                    padding: '0.75rem',\r\n                                    backgroundColor: '#1e293b',\r\n                                    borderRadius: '6px',\r\n                                    border: '1px solid #334155'\r\n                                }}>\r\n                                    <label style={{ display: 'block', marginBottom: '0.5rem', fontSize: '0.8rem', color: '#94a3b8' }}>\r\n                                        NotebookLM URL:\r\n                                    </label>\r\n                                    <a\r\n                                        href={`https://notebooklm.google.com/notebook/${selectedNotebookId}`}\r\n                                        target=\"_blank\"\r\n                                        rel=\"noopener noreferrer\"\r\n                                        style={{\r\n                                            color: '#3b82f6',\r\n                                            textDecoration: 'none',\r\n                                            fontSize: '0.85rem',\r\n                                            wordBreak: 'break-all',\r\n                                            display: 'block'\r\n                                        }}\r\n                                    >\r\n                                        https://notebooklm.google.com/notebook/{selectedNotebookId}\r\n                                    </a>\r\n                                </div>\r\n                            )}\r\n\r\n                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '1rem' }}>\r\n                                <button onClick={() => setShowSaveFields(false)} className=\"secondary\">Back</button>\r\n                                <button onClick={handleSaveArtifact} disabled={isExecuting}>\r\n                                    {isExecuting ? 'Saving...' : 'Confirm Save'}\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\HierarchyCreationModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":40,"column":27,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":40,"endColumn":30,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1605,1608],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1605,1608],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":112,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":112,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4258,4261],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4258,4261],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":126,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4707,4710],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4707,4710],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport ReactDOM from 'react-dom';\r\nimport type { HierarchyData, HierarchyNode } from '../services/HierarchyService';\r\nimport { HierarchyService } from '../services/HierarchyService';\r\n\r\ninterface HierarchyCreationModalProps {\r\n    parentNodeId: number | null;\r\n    onClose: () => void;\r\n    onHierarchyCreated: () => void;\r\n    geminiApiKey: string;\r\n}\r\n\r\nexport const HierarchyCreationModal: React.FC<HierarchyCreationModalProps> = ({\r\n    parentNodeId,\r\n    onClose,\r\n    onHierarchyCreated,\r\n    geminiApiKey\r\n}) => {\r\n    const [step, setStep] = useState<'upload' | 'edit-titles' | 'generating-descriptions' | 'creating'>('upload');\r\n    const [hierarchyTitles, setHierarchyTitles] = useState<HierarchyData | null>(null);\r\n    const [isProcessing, setIsProcessing] = useState(false);\r\n    const [error, setError] = useState<string>('');\r\n    const [generationProgress, setGenerationProgress] = useState<string>('');\r\n\r\n    const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        const file = e.target.files?.[0];\r\n        if (file) {\r\n            if (!file.type.startsWith('image/')) {\r\n                setError('Please select an image file');\r\n                return;\r\n            }\r\n            setError('');\r\n\r\n            // Automatically process the image\r\n            setIsProcessing(true);\r\n            try {\r\n                const hierarchy = await HierarchyService.imageToTitlesOnly(file, geminiApiKey);\r\n                setHierarchyTitles(hierarchy);\r\n                setStep('edit-titles');\r\n            } catch (err: any) {\r\n                setError(err.message || 'Failed to process image');\r\n            } finally {\r\n                setIsProcessing(false);\r\n            }\r\n        }\r\n    };\r\n\r\n    const handleTitleChange = (path: number[], newTitle: string) => {\r\n        if (!hierarchyTitles) return;\r\n\r\n        const updateNode = (node: HierarchyData | HierarchyNode, currentPath: number[]): HierarchyData | HierarchyNode => {\r\n            if (currentPath.length === 0) {\r\n                return { ...node, name: newTitle };\r\n            }\r\n\r\n            const [index, ...rest] = currentPath;\r\n            if (!node.children) return node;\r\n\r\n            const newChildren = [...node.children];\r\n            newChildren[index] = updateNode(newChildren[index], rest) as HierarchyNode;\r\n\r\n            return { ...node, children: newChildren };\r\n        };\r\n\r\n        setHierarchyTitles(updateNode(hierarchyTitles, path) as HierarchyData);\r\n    };\r\n\r\n    const handleDeleteNode = (path: number[]) => {\r\n        if (!hierarchyTitles || path.length === 0) return;\r\n\r\n        const deleteNode = (node: HierarchyData | HierarchyNode, currentPath: number[]): HierarchyData | HierarchyNode | null => {\r\n            if (currentPath.length === 1) {\r\n                if (!node.children) return node;\r\n                const newChildren = node.children.filter((_, i) => i !== currentPath[0]);\r\n                return { ...node, children: newChildren };\r\n            }\r\n\r\n            const [index, ...rest] = currentPath;\r\n            if (!node.children) return node;\r\n\r\n            const newChildren = [...node.children];\r\n            const updated = deleteNode(newChildren[index], rest);\r\n            if (updated === null) {\r\n                newChildren.splice(index, 1);\r\n            } else {\r\n                newChildren[index] = updated as HierarchyNode;\r\n            }\r\n\r\n            return { ...node, children: newChildren };\r\n        };\r\n\r\n        const result = deleteNode(hierarchyTitles, path);\r\n        if (result) {\r\n            setHierarchyTitles(result as HierarchyData);\r\n        }\r\n    };\r\n\r\n    const handleGenerateDescriptions = async () => {\r\n        if (!hierarchyTitles || !geminiApiKey) return;\r\n\r\n        setStep('generating-descriptions');\r\n        setError('');\r\n        setGenerationProgress('Generating descriptions...');\r\n\r\n        try {\r\n            const hierarchyWithDescs = await HierarchyService.generateDescriptions(\r\n                hierarchyTitles,\r\n                geminiApiKey,\r\n                (progress) => setGenerationProgress(progress)\r\n            );\r\n            await handleCreateHierarchy(hierarchyWithDescs);\r\n        } catch (err: any) {\r\n            setError(err.message || 'Failed to generate descriptions');\r\n            setStep('edit-titles');\r\n        }\r\n    };\r\n\r\n    const handleCreateHierarchy = async (hierarchy: HierarchyData) => {\r\n        setStep('creating');\r\n        setError('');\r\n\r\n        try {\r\n            await HierarchyService.createHierarchyFromJson(hierarchy, parentNodeId);\r\n            onHierarchyCreated();\r\n            onClose();\r\n        } catch (err: any) {\r\n            setError(err.message || 'Failed to create hierarchy');\r\n            setStep('edit-titles');\r\n        }\r\n    };\r\n\r\n    const renderNodeEditor = (node: HierarchyNode | HierarchyData, path: number[] = [], depth: number = 0) => {\r\n        const isRoot = path.length === 0;\r\n\r\n        return (\r\n            <div key={path.join('-')} style={{ marginLeft: depth > 0 ? '2rem' : '0', marginBottom: '0.5rem' }}>\r\n                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.25rem' }}>\r\n                    <input\r\n                        type=\"text\"\r\n                        value={node.name}\r\n                        onChange={(e) => handleTitleChange(path, e.target.value)}\r\n                        style={{\r\n                            flex: 1,\r\n                            padding: '0.5rem',\r\n                            backgroundColor: '#252526',\r\n                            color: '#fff',\r\n                            border: '1px solid #444',\r\n                            borderRadius: '4px',\r\n                            fontSize: '0.9rem'\r\n                        }}\r\n                    />\r\n                    {!isRoot && (\r\n                        <button\r\n                            onClick={() => handleDeleteNode(path)}\r\n                            style={{\r\n                                padding: '0.5rem',\r\n                                backgroundColor: '#ff4444',\r\n                                color: '#fff',\r\n                                border: 'none',\r\n                                borderRadius: '4px',\r\n                                cursor: 'pointer',\r\n                                fontSize: '0.9rem'\r\n                            }}\r\n                            title=\"Delete node\"\r\n                        >\r\n                            ­ƒùæ\r\n                        </button>\r\n                    )}\r\n                </div>\r\n                {node.children && node.children.map((child, index) =>\r\n                    renderNodeEditor(child, [...path, index], depth + 1)\r\n                )}\r\n            </div>\r\n        );\r\n    };\r\n\r\n    const modalContent = (\r\n        <div\r\n            style={{\r\n                position: 'fixed',\r\n                top: 0,\r\n                left: 0,\r\n                width: '100vw',\r\n                height: '100vh',\r\n                backgroundColor: 'rgba(0,0,0,0.85)',\r\n                zIndex: 3000,\r\n                display: 'flex',\r\n                justifyContent: 'center',\r\n                alignItems: 'center'\r\n            }}\r\n            onClick={onClose}\r\n        >\r\n            <div\r\n                style={{\r\n                    width: '90%',\r\n                    maxWidth: '900px',\r\n                    maxHeight: '85vh',\r\n                    backgroundColor: '#1e1e1e',\r\n                    borderRadius: '12px',\r\n                    display: 'flex',\r\n                    flexDirection: 'column',\r\n                    overflow: 'hidden',\r\n                    border: '1px solid #333'\r\n                }}\r\n                onClick={(e) => e.stopPropagation()}\r\n            >\r\n                {/* Header */}\r\n                <div\r\n                    style={{\r\n                        padding: '1.5rem',\r\n                        borderBottom: '1px solid #333',\r\n                        display: 'flex',\r\n                        justifyContent: 'space-between',\r\n                        alignItems: 'center'\r\n                    }}\r\n                >\r\n                    <h2 style={{ margin: 0, color: '#fff', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>\r\n                        <span style={{\r\n                            width: '32px',\r\n                            height: '32px',\r\n                            borderRadius: '50%',\r\n                            backgroundColor: '#000',\r\n                            display: 'flex',\r\n                            alignItems: 'center',\r\n                            justifyContent: 'center',\r\n                            fontSize: '18px'\r\n                        }}>\r\n                            ­ƒî│\r\n                        </span>\r\n                        Create Hierarchy from Mind Map\r\n                    </h2>\r\n                    <button\r\n                        onClick={onClose}\r\n                        style={{\r\n                            background: 'none',\r\n                            border: 'none',\r\n                            color: '#fff',\r\n                            fontSize: '1.5rem',\r\n                            cursor: 'pointer',\r\n                            padding: '0.5rem'\r\n                        }}\r\n                    >\r\n                        Ô£ò\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Body */}\r\n                <div style={{ flex: 1, overflow: 'auto', padding: '1.5rem' }}>\r\n                    {error && (\r\n                        <div\r\n                            style={{\r\n                                padding: '1rem',\r\n                                backgroundColor: '#ff000020',\r\n                                border: '1px solid #ff0000',\r\n                                borderRadius: '4px',\r\n                                color: '#ff6b6b',\r\n                                marginBottom: '1rem'\r\n                            }}\r\n                        >\r\n                            {error}\r\n                        </div>\r\n                    )}\r\n\r\n                    {step === 'upload' && (\r\n                        <div style={{ textAlign: 'center' }}>\r\n                            <p style={{ color: '#ccc', marginBottom: '2rem' }}>\r\n                                Upload a mind map image from NotebookLM. The AI will automatically extract the titles for you to review and edit.\r\n                            </p>\r\n\r\n                            {!isProcessing ? (\r\n                                <div\r\n                                    style={{\r\n                                        border: '2px dashed #444',\r\n                                        borderRadius: '8px',\r\n                                        padding: '3rem',\r\n                                        marginBottom: '2rem',\r\n                                        backgroundColor: '#252526'\r\n                                    }}\r\n                                >\r\n                                    <input\r\n                                        type=\"file\"\r\n                                        accept=\"image/*\"\r\n                                        onChange={handleFileSelect}\r\n                                        style={{ display: 'none' }}\r\n                                        id=\"hierarchy-image-upload\"\r\n                                    />\r\n                                    <label\r\n                                        htmlFor=\"hierarchy-image-upload\"\r\n                                        style={{\r\n                                            display: 'inline-block',\r\n                                            padding: '1rem 2rem',\r\n                                            backgroundColor: '#3b82f6',\r\n                                            color: '#fff',\r\n                                            borderRadius: '4px',\r\n                                            cursor: 'pointer',\r\n                                            fontSize: '1rem'\r\n                                        }}\r\n                                    >\r\n                                        Choose Mind Map Image\r\n                                    </label>\r\n                                </div>\r\n                            ) : (\r\n                                <div style={{ textAlign: 'center', padding: '3rem' }}>\r\n                                    <div\r\n                                        style={{\r\n                                            width: '60px',\r\n                                            height: '60px',\r\n                                            border: '4px solid #444',\r\n                                            borderTop: '4px solid #4ade80',\r\n                                            borderRadius: '50%',\r\n                                            animation: 'spin 1s linear infinite',\r\n                                            margin: '0 auto 2rem'\r\n                                        }}\r\n                                    />\r\n                                    <p style={{ color: '#ccc', fontSize: '1.2rem' }}>\r\n                                        Extracting titles from mind map...\r\n                                    </p>\r\n                                </div>\r\n                            )}\r\n                        </div>\r\n                    )}\r\n\r\n                    {step === 'edit-titles' && hierarchyTitles && (\r\n                        <div>\r\n                            <p style={{ color: '#ccc', marginBottom: '1rem' }}>\r\n                                Review and edit the extracted titles. Add or remove nodes as needed:\r\n                            </p>\r\n                            <div style={{\r\n                                backgroundColor: '#252526',\r\n                                padding: '1rem',\r\n                                borderRadius: '4px',\r\n                                border: '1px solid #444',\r\n                                maxHeight: '400px',\r\n                                overflow: 'auto',\r\n                                marginBottom: '1rem'\r\n                            }}>\r\n                                {renderNodeEditor(hierarchyTitles)}\r\n                            </div>\r\n                            <div style={{ display: 'flex', gap: '1rem' }}>\r\n                                <button\r\n                                    onClick={() => setStep('upload')}\r\n                                    style={{\r\n                                        padding: '0.75rem 1.5rem',\r\n                                        backgroundColor: '#444',\r\n                                        color: '#fff',\r\n                                        border: 'none',\r\n                                        borderRadius: '4px',\r\n                                        cursor: 'pointer'\r\n                                    }}\r\n                                >\r\n                                    ÔåÉ Back\r\n                                </button>\r\n                                <button\r\n                                    onClick={handleGenerateDescriptions}\r\n                                    style={{\r\n                                        flex: 1,\r\n                                        padding: '0.75rem 1.5rem',\r\n                                        backgroundColor: '#4ade80',\r\n                                        color: '#000',\r\n                                        border: 'none',\r\n                                        borderRadius: '4px',\r\n                                        cursor: 'pointer',\r\n                                        fontWeight: 'bold'\r\n                                    }}\r\n                                >\r\n                                    Generate Descriptions & Create Hierarchy\r\n                                </button>\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {(step === 'generating-descriptions' || step === 'creating') && (\r\n                        <div style={{ textAlign: 'center', padding: '3rem' }}>\r\n                            <div\r\n                                style={{\r\n                                    width: '60px',\r\n                                    height: '60px',\r\n                                    border: '4px solid #444',\r\n                                    borderTop: '4px solid #4ade80',\r\n                                    borderRadius: '50%',\r\n                                    animation: 'spin 1s linear infinite',\r\n                                    margin: '0 auto 2rem'\r\n                                }}\r\n                            />\r\n                            <p style={{ color: '#ccc', fontSize: '1.2rem' }}>\r\n                                {step === 'generating-descriptions' ? generationProgress : 'Creating hierarchy in database...'}\r\n                            </p>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n\r\n            <style>{`\r\n                @keyframes spin {\r\n                    0% { transform: rotate(0deg); }\r\n                    100% { transform: rotate(360deg); }\r\n                }\r\n            `}</style>\r\n        </div>\r\n    );\r\n\r\n    return ReactDOM.createPortal(modalContent, document.body);\r\n};\r\n\r\nexport default HierarchyCreationModal;\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\JsonViewerModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":7,"column":15,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":7,"endColumn":18,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[167,170],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[167,170],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React from 'react';\r\nimport '../styles/JsonViewerModal.css';\r\n\r\ninterface JsonViewerModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    jsonData: any;\r\n    title?: string;\r\n}\r\n\r\nexport const JsonViewerModal: React.FC<JsonViewerModalProps> = ({ isOpen, onClose, jsonData, title = \"JSON Viewer\" }) => {\r\n    if (!isOpen) return null;\r\n\r\n    const copyToClipboard = () => {\r\n        const jsonString = JSON.stringify(jsonData, null, 2);\r\n        navigator.clipboard.writeText(jsonString);\r\n        alert('JSON copied to clipboard!');\r\n    };\r\n\r\n    const downloadJson = () => {\r\n        const jsonString = JSON.stringify(jsonData, null, 2);\r\n        const blob = new Blob([jsonString], { type: 'application/json' });\r\n        const url = URL.createObjectURL(blob);\r\n        const a = document.createElement('a');\r\n        a.href = url;\r\n        a.download = `brainstorm_${new Date().getTime()}.json`;\r\n        document.body.appendChild(a);\r\n        a.click();\r\n        document.body.removeChild(a);\r\n        URL.revokeObjectURL(url);\r\n    };\r\n\r\n    return (\r\n        <div className=\"json-viewer-overlay\" onClick={onClose}>\r\n            <div className=\"json-viewer-modal\" onClick={(e) => e.stopPropagation()}>\r\n                <div className=\"json-viewer-header\">\r\n                    <h2>{title}</h2>\r\n                    <div className=\"json-viewer-actions\">\r\n                        <button onClick={copyToClipboard} className=\"json-action-btn\">\r\n                            ­ƒôï Copy\r\n                        </button>\r\n                        <button onClick={downloadJson} className=\"json-action-btn\">\r\n                            ­ƒÆ¥ Download\r\n                        </button>\r\n                        <button onClick={onClose} className=\"json-close-btn\">\r\n                            Ô£ò\r\n                        </button>\r\n                    </div>\r\n                </div>\r\n                <div className=\"json-viewer-content\">\r\n                    <pre>{JSON.stringify(jsonData, null, 2)}</pre>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\NodeDetailsModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":204,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":204,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8187,8190],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8187,8190],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect, useRef, useCallback } from 'react';\r\nimport ReactDOM from 'react-dom';\r\nimport type { DocumentNode } from '../types';\r\nimport ReactMarkdown from 'react-markdown';\r\nimport remarkGfm from 'remark-gfm';\r\nimport tulkahLogo from '../assets/tulkah-logo.png';\r\nimport { NodeService } from '../services/NodeService';\r\nimport { StorageService } from '../services/StorageService';\r\nimport { TagService } from '../services/TagService';\r\nimport type { TagTreeNode } from '../types/tags';\r\nimport { openMarkdownWindow } from '../utils/markdownUtils';\r\nimport AIQueryRefinementModal from './AIQueryRefinementModal';\r\nimport { CurationModal } from './CurationModal';\r\n\r\ninterface NodeDetailsModalProps {\r\n    node: DocumentNode;\r\n    onClose: () => void;\r\n    onUpdate?: () => void;\r\n}\r\n\r\nexport const NodeDetailsModal: React.FC<NodeDetailsModalProps> = ({ node, onClose, onUpdate }) => {\r\n    const [currentNode, setCurrentNode] = useState(node);\r\n\r\n    useEffect(() => {\r\n        console.log(`[NodeDetailsModal] Mount for node ${node.nodeID}`);\r\n        return () => console.log(`[NodeDetailsModal] Unmount for node ${node.nodeID}`);\r\n    }, [node.nodeID]);\r\n\r\n    const [isEditing, setIsEditing] = useState(false);\r\n    const [editedText, setEditedText] = useState(node.text || '');\r\n    const [editedUrl, setEditedUrl] = useState(node.url || '');\r\n    const [editedUrlType, setEditedUrlType] = useState<'Video' | 'Audio' | 'Image' | 'Markdown' | 'PDF' | 'PNG' | 'Url' | 'Loop' | 'InfoGraphic' | 'Specification' | null>(node.urltype || null);\r\n    const [isSaving, setIsSaving] = useState(false);\r\n    const [showPlayer, setShowPlayer] = useState(false);\r\n    const [blobStoreFiles, setBlobStoreFiles] = useState<string[]>([]);\r\n\r\n    // AI Query Refinement state\r\n    const [showRefinementModal, setShowRefinementModal] = useState(false);\r\n    const [showCurationModal, setShowCurationModal] = useState(false);\r\n    const [selectedText, setSelectedText] = useState('');\r\n    const [selectionRange, setSelectionRange] = useState<{ start: number; end: number } | null>(null);\r\n    const textareaRef = useRef<HTMLTextAreaElement>(null);\r\n\r\n    // Tag state\r\n    const [availableTags, setAvailableTags] = useState<TagTreeNode[]>([]);\r\n    const [selectedTagIds, setSelectedTagIds] = useState<Set<number>>(new Set());\r\n    const [originalTagIds, setOriginalTagIds] = useState<Set<number>>(new Set());\r\n\r\n    // Fetch fresh node data from Supabase when modal opens\r\n    useEffect(() => {\r\n        const fetchNodeData = async () => {\r\n            try {\r\n                const freshNode = await NodeService.getNodeById(node.nodeID);\r\n                setCurrentNode(freshNode);\r\n                setEditedText(freshNode.text || '');\r\n                setEditedUrl(freshNode.url || '');\r\n                setEditedUrlType(freshNode.urltype || null);\r\n            } catch (err) {\r\n                console.error('Failed to fetch node data:', err);\r\n            }\r\n        };\r\n        fetchNodeData();\r\n    }, [node.nodeID]);\r\n\r\n    // Load available tags and current node's tags\r\n    useEffect(() => {\r\n        const loadTagData = async () => {\r\n            try {\r\n                const [tree, nodeTagIds] = await Promise.all([\r\n                    TagService.fetchTagTree(),\r\n                    TagService.getTagsForNode(node.nodeID)\r\n                ]);\r\n                setAvailableTags(tree);\r\n                setSelectedTagIds(new Set(nodeTagIds));\r\n                setOriginalTagIds(new Set(nodeTagIds));\r\n            } catch (err) {\r\n                console.error('Failed to load tags:', err);\r\n            }\r\n        };\r\n        loadTagData();\r\n    }, [node.nodeID]);\r\n\r\n    // Fetch files from BlobStore bucket\r\n    useEffect(() => {\r\n        const fetchFiles = async () => {\r\n            try {\r\n                // Try 'BlobStore' first\r\n                let files = await StorageService.listFiles('BlobStore');\r\n\r\n                // If empty or error, try 'blobstore' (lowercase)\r\n                if (!files || files.length === 0) {\r\n                    console.log(\"BlobStore empty, trying 'blobstore'...\");\r\n                    try {\r\n                        const lowerFiles = await StorageService.listFiles('blobstore');\r\n                        if (lowerFiles && lowerFiles.length > 0) {\r\n                            files = lowerFiles;\r\n                        }\r\n                    } catch (e) {\r\n                        console.log(\"Failed to fetch from 'blobstore' as well.\");\r\n                    }\r\n                }\r\n\r\n                const fileNames = files.map((file: { name: string }) => file.name).filter((name: string) => name); // Filter out empty names\r\n                setBlobStoreFiles(fileNames);\r\n            } catch (err) {\r\n                console.error('Failed to fetch BlobStore files:', err);\r\n            }\r\n        };\r\n        fetchFiles();\r\n    }, []);\r\n\r\n    // Check if tags have changed\r\n    const tagsChanged = (() => {\r\n        if (selectedTagIds.size !== originalTagIds.size) return true;\r\n        for (const id of selectedTagIds) {\r\n            if (!originalTagIds.has(id)) return true;\r\n        }\r\n        return false;\r\n    })();\r\n\r\n    // Check if any fields have been modified\r\n    const hasChanges =\r\n        editedText !== (node.text || '') ||\r\n        editedUrl !== (node.url || '') ||\r\n        editedUrlType !== (node.urltype || null) ||\r\n        tagsChanged;\r\n\r\n    const handleTagToggle = (tagId: number) => {\r\n        setSelectedTagIds(prev => {\r\n            const next = new Set(prev);\r\n            if (next.has(tagId)) {\r\n                next.delete(tagId);\r\n            } else {\r\n                next.add(tagId);\r\n            }\r\n            return next;\r\n        });\r\n    };\r\n\r\n    // Render tag checkboxes recursively\r\n    const renderTagCheckboxes = (nodes: TagTreeNode[]): React.ReactNode => {\r\n        return (\r\n            <ul style={{ listStyle: 'none', paddingLeft: nodes[0]?.level > 0 ? '15px' : '0', margin: 0 }}>\r\n                {nodes.map(node => (\r\n                    <li key={node.id} style={{ marginBottom: '4px' }}>\r\n                        <label style={{ display: 'flex', alignItems: 'center', gap: '8px', cursor: 'pointer' }}>\r\n                            <input\r\n                                type=\"checkbox\"\r\n                                checked={selectedTagIds.has(node.id)}\r\n                                onChange={() => handleTagToggle(node.id)}\r\n                            />\r\n                            <span>{node.name}</span>\r\n                        </label>\r\n                        {node.childNodes && node.childNodes.length > 0 && renderTagCheckboxes(node.childNodes)}\r\n                    </li>\r\n                ))}\r\n            </ul>\r\n        );\r\n    };\r\n\r\n    // Get tag names from IDs for display\r\n    const getTagNames = (nodes: TagTreeNode[], ids: Set<number>): string[] => {\r\n        const names: string[] = [];\r\n        const findNames = (list: TagTreeNode[]) => {\r\n            for (const node of list) {\r\n                if (ids.has(node.id)) {\r\n                    names.push(node.name);\r\n                }\r\n                if (node.childNodes) {\r\n                    findNames(node.childNodes);\r\n                }\r\n            }\r\n        };\r\n        findNames(nodes);\r\n        return names;\r\n    };\r\n\r\n    const handleSave = async () => {\r\n        try {\r\n            setIsSaving(true);\r\n            await NodeService.updateNode(node.nodeID, {\r\n                text: editedText,\r\n                url: editedUrl,\r\n                urltype: editedUrlType\r\n            });\r\n\r\n            // Save tag assignments if changed\r\n            if (tagsChanged) {\r\n                await TagService.assignTags(node.nodeID, Array.from(selectedTagIds));\r\n                setOriginalTagIds(new Set(selectedTagIds));\r\n            }\r\n\r\n            // Update currentNode with the saved values\r\n            setCurrentNode({\r\n                ...currentNode,\r\n                text: editedText,\r\n                url: editedUrl,\r\n                urltype: editedUrlType\r\n            });\r\n\r\n            if (onUpdate) onUpdate();\r\n\r\n            setIsEditing(false);\r\n        } catch (err: any) {\r\n            alert('Failed to save: ' + err.message);\r\n        } finally {\r\n            setIsSaving(false);\r\n        }\r\n    };\r\n\r\n    const handleCancel = () => {\r\n        setEditedText(currentNode.text || '');\r\n        setEditedUrl(currentNode.url || '');\r\n        setEditedUrlType(currentNode.urltype || null);\r\n        setIsEditing(false);\r\n    };\r\n\r\n    const handlePasteRefinement = useCallback((text: string) => {\r\n        if (!text) return;\r\n\r\n        let newText = editedText;\r\n        if (selectionRange) {\r\n            // Replace selected text\r\n            const before = editedText.substring(0, selectionRange.start);\r\n            const after = editedText.substring(selectionRange.end);\r\n            newText = before + text + after;\r\n        } else {\r\n            // Insert at end if no selection (fallback)\r\n            newText = editedText + text;\r\n        }\r\n\r\n        setEditedText(newText);\r\n        setShowRefinementModal(false);\r\n        setSelectionRange(null);\r\n    }, [editedText, selectionRange]);\r\n\r\n    const handleCloseRefinement = useCallback(() => {\r\n        setShowRefinementModal(false);\r\n    }, []);\r\n\r\n    const handlePlayMedia = () => {\r\n        if (node.urltype === 'Video') {\r\n            const videoWindow = window.open('', '_blank', 'width=800,height=600');\r\n            if (videoWindow) {\r\n                videoWindow.document.write(`\r\n                    <!DOCTYPE html>\r\n                    <html>\r\n                    <head>\r\n                        <title>${node.title} - Video Player</title>\r\n                        <style>\r\n                            body {\r\n                                margin: 0;\r\n                                padding: 20px;\r\n                                background: #000;\r\n                                display: flex;\r\n                                flex-direction: column;\r\n                                align-items: center;\r\n                                justify-content: center;\r\n                                min-height: 100vh;\r\n                                font-family: Arial, sans-serif;\r\n                            }\r\n                            h1 {\r\n                                color: #fff;\r\n                                margin-bottom: 20px;\r\n                                font-size: 1.5rem;\r\n                            }\r\n                            video {\r\n                                max-width: 100%;\r\n                                max-height: 80vh;\r\n                                border-radius: 8px;\r\n                            }\r\n                        </style>\r\n                    </head>\r\n                    <body>\r\n                        <h1>${node.title}</h1>\r\n                        <video controls autoplay>\r\n                            <source src=\"${node.url}\" />\r\n                            Your browser does not support the video tag.\r\n                        </video>\r\n                    </body>\r\n                    </html>\r\n                `);\r\n                videoWindow.document.close();\r\n            }\r\n        } else if (node.urltype === 'Audio') {\r\n            setShowPlayer(true);\r\n        }\r\n    };\r\n\r\n    const handleDisplayMarkdown = async () => {\r\n        await openMarkdownWindow(currentNode.title, currentNode.url);\r\n    };\r\n\r\n    const handleDisplayPdf = () => {\r\n        const pdfWindow = window.open('', '_blank', 'width=1000,height=800');\r\n        if (pdfWindow) {\r\n            pdfWindow.document.write(`\r\n                <!DOCTYPE html>\r\n                <html>\r\n                <head>\r\n                    <title>${currentNode.title} - PDF</title>\r\n                    <style>\r\n                        body {\r\n                            margin: 0;\r\n                            padding: 0;\r\n                            height: 100vh;\r\n                            overflow: hidden;\r\n                        }\r\n                        iframe {\r\n                            width: 100%;\r\n                            height: 100%;\r\n                            border: none;\r\n                        }\r\n                    </style>\r\n                </head>\r\n                <body>\r\n                    <iframe src=\"${currentNode.url}\" type=\"application/pdf\"></iframe>\r\n                </body>\r\n                </html>\r\n            `);\r\n            pdfWindow.document.close();\r\n        }\r\n    };\r\n\r\n    const handleDisplayPng = () => {\r\n        const pngWindow = window.open('', '_blank', 'width=1000,height=800');\r\n        if (pngWindow) {\r\n            pngWindow.document.write(`\r\n                <!DOCTYPE html>\r\n                <html>\r\n                <head>\r\n                    <title>${currentNode.title} - PNG</title>\r\n                    <style>\r\n                        body {\r\n                            margin: 0;\r\n                            padding: 0;\r\n                            height: 100vh;\r\n                            display: flex;\r\n                            justify-content: center;\r\n                            align-items: center;\r\n                            background-color: #0d1117;\r\n                        }\r\n                        img {\r\n                            max-width: 100%;\r\n                            max-height: 100%;\r\n                            object-fit: contain;\r\n                        }\r\n                    </style>\r\n                </head>\r\n                <body>\r\n                    <img src=\"${currentNode.url}\" alt=\"${currentNode.title}\" />\r\n                </body>\r\n                </html>\r\n            `);\r\n            pngWindow.document.close();\r\n        }\r\n    };\r\n\r\n    const isValidUrl = (urlString: string): boolean => {\r\n        try {\r\n            const url = new URL(urlString);\r\n            return url.protocol === 'http:' || url.protocol === 'https:';\r\n        } catch {\r\n            return false;\r\n        }\r\n    };\r\n\r\n    const hasValidUrl = node.url && node.url.trim() !== '' && isValidUrl(node.url.trim());\r\n    const canPlayMedia = hasValidUrl && (node.urltype === 'Video' || node.urltype === 'Audio');\r\n\r\n    const canEdit = node.access_level !== 'read_only';\r\n\r\n    const modalContent = (\r\n        <div className=\"modal-overlay\"\r\n            onClick={() => {\r\n                onClose();\r\n            }}\r\n            style={{\r\n                visibility: showRefinementModal ? 'hidden' : 'visible'\r\n            }}\r\n        >\r\n            <div className=\"modal-content\" onClick={(e) => e.stopPropagation()}>\r\n                <div className=\"modal-header\" style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between', position: 'relative', padding: '1rem' }}>\r\n                    <img\r\n                        src={tulkahLogo}\r\n                        alt=\"Tulkah AI\"\r\n                        style={{\r\n                            height: '86px',\r\n                            width: '66px',\r\n                            borderRadius: '4px',\r\n                            flexShrink: 0\r\n                        }}\r\n                    />\r\n\r\n                    <div style={{\r\n                        flex: 1,\r\n                        textAlign: 'center',\r\n                        padding: '0 1rem'\r\n                    }}>\r\n                        <h2 style={{\r\n                            margin: '0 0 0.5rem 0',\r\n                            fontSize: '1.5em'\r\n                        }}>\r\n                            {node.title}\r\n                        </h2>\r\n                        <div style={{\r\n                            fontSize: '0.85rem',\r\n                            color: 'var(--color-text-secondary)',\r\n                            display: 'flex',\r\n                            gap: '1rem',\r\n                            justifyContent: 'center',\r\n                            flexWrap: 'wrap'\r\n                        }}>\r\n                            <span><strong>ID:</strong> {node.nodeID}</span>\r\n                            <span><strong>Parent:</strong> {node.parentNodeID ?? 'None'}</span>\r\n                            <span><strong>Level:</strong> {node.level ?? 0}</span>\r\n                            <span><strong>Order:</strong> {node.order ?? 0}</span>\r\n                        </div>\r\n                    </div>\r\n\r\n                    <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'center', flexShrink: 0 }}>\r\n                        {!isEditing ? (\r\n                            <>\r\n                                {canEdit && (\r\n                                    <button onClick={() => setIsEditing(true)} style={{ fontSize: '0.9rem', padding: '0.4rem 0.8rem' }}>\r\n                                        Ô£Å´©Å Edit\r\n                                    </button>\r\n                                )}\r\n                                <button\r\n                                    onClick={() => setShowCurationModal(true)}\r\n                                    style={{\r\n                                        fontSize: '0.85rem',\r\n                                        padding: '0.3rem 0.5rem',\r\n                                        backgroundColor: 'transparent',\r\n                                        border: 'none',\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        cursor: 'pointer',\r\n                                        borderRadius: '4px'\r\n                                    }}\r\n                                    title=\"Curation Function\"\r\n                                >\r\n                                    <div style={{\r\n                                        width: '26px',\r\n                                        height: '26px',\r\n                                        borderRadius: '6px',\r\n                                        background: '#0f172a',\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        justifyContent: 'center',\r\n                                        color: 'white',\r\n                                        boxShadow: '0 2px 4px rgba(0,0,0,0.3)',\r\n                                        border: '1px solid rgba(255,255,255,0.2)',\r\n                                        position: 'relative',\r\n                                        overflow: 'hidden'\r\n                                    }}>\r\n                                        <div style={{\r\n                                            position: 'absolute',\r\n                                            top: 0,\r\n                                            left: 0,\r\n                                            right: 0,\r\n                                            height: '2px',\r\n                                            background: 'linear-gradient(90deg, #4285f4, #a855f7, #f97316)'\r\n                                        }} />\r\n                                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" style={{ marginTop: '2px' }}>\r\n                                            <path d=\"M4 19.5A2.5 2.5 0 0 1 6.5 17H20\"></path>\r\n                                            <path d=\"M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z\"></path>\r\n                                        </svg>\r\n                                    </div>\r\n                                </button>\r\n                                <button className=\"icon-btn\" onClick={onClose}>Ô£ò</button>\r\n                            </>\r\n                        ) : (\r\n                            <>\r\n                                {hasChanges && (\r\n                                    <button onClick={handleSave} disabled={isSaving} style={{ fontSize: '0.9rem', padding: '0.4rem 0.8rem' }}>\r\n                                        {isSaving ? 'Saving...' : '­ƒÆ¥ Save'}\r\n                                    </button>\r\n                                )}\r\n                                <button onClick={handleCancel} disabled={isSaving} style={{ fontSize: '0.9rem', padding: '0.4rem 0.8rem' }}>\r\n                                    Cancel\r\n                                </button>\r\n                                <button\r\n                                    onClick={() => setShowCurationModal(true)}\r\n                                    style={{\r\n                                        fontSize: '0.85rem',\r\n                                        padding: '0.3rem 0.5rem',\r\n                                        backgroundColor: 'transparent',\r\n                                        border: 'none',\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        cursor: 'pointer',\r\n                                        borderRadius: '4px'\r\n                                    }}\r\n                                    title=\"Curation Function\"\r\n                                >\r\n                                    <div style={{\r\n                                        width: '26px',\r\n                                        height: '26px',\r\n                                        borderRadius: '6px',\r\n                                        background: '#0f172a',\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        justifyContent: 'center',\r\n                                        color: 'white',\r\n                                        boxShadow: '0 2px 4px rgba(0,0,0,0.3)',\r\n                                        border: '1px solid rgba(255,255,255,0.2)',\r\n                                        position: 'relative',\r\n                                        overflow: 'hidden'\r\n                                    }}>\r\n                                        <div style={{\r\n                                            position: 'absolute',\r\n                                            top: 0,\r\n                                            left: 0,\r\n                                            right: 0,\r\n                                            height: '2px',\r\n                                            background: 'linear-gradient(90deg, #4285f4, #a855f7, #f97316)'\r\n                                        }} />\r\n                                        <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" strokeWidth=\"2\" strokeLinecap=\"round\" strokeLinejoin=\"round\" style={{ marginTop: '2px' }}>\r\n                                            <path d=\"M4 19.5A2.5 2.5 0 0 1 6.5 17H20\"></path>\r\n                                            <path d=\"M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z\"></path>\r\n                                        </svg>\r\n                                    </div>\r\n                                </button>\r\n                                <button className=\"icon-btn\" onClick={onClose}>Ô£ò</button>\r\n                            </>\r\n                        )}\r\n                    </div>\r\n                </div>\r\n\r\n                <div className=\"modal-body\">\r\n\r\n                    <div className=\"detail-section\">\r\n                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>\r\n                            {/* Label removed as requested */}\r\n                            {isEditing && (\r\n                                <button\r\n                                    onClick={() => {\r\n                                        console.log(\"[NodeDetailsModal] Opening AI Refinement Modal\");\r\n                                        if (textareaRef.current) {\r\n                                            const start = textareaRef.current.selectionStart;\r\n                                            const end = textareaRef.current.selectionEnd;\r\n                                            if (start !== end) {\r\n                                                const selection = textareaRef.current.value.substring(start, end);\r\n                                                setSelectedText(selection);\r\n                                                setSelectionRange({ start, end });\r\n                                            } else {\r\n                                                setSelectedText('');\r\n                                                setSelectionRange(null);\r\n                                            }\r\n                                        }\r\n                                        setShowRefinementModal(true);\r\n                                    }}\r\n                                    style={{\r\n                                        fontSize: '0.85rem',\r\n                                        padding: '0.3rem 0.8rem',\r\n                                        backgroundColor: '#8b5cf6',\r\n                                        color: 'white',\r\n                                        border: 'none',\r\n                                        display: 'flex',\r\n                                        alignItems: 'center',\r\n                                        gap: '0.3rem',\r\n                                        cursor: 'pointer',\r\n                                        borderRadius: '4px',\r\n                                        transition: 'background-color 0.2s',\r\n                                        marginLeft: 'auto' // Push to right since label is gone\r\n                                    }}\r\n                                    onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#7c3aed'}\r\n                                    onMouseOut={(e) => e.currentTarget.style.backgroundColor = '#8b5cf6'}\r\n                                >\r\n                                    Ô£¿ AI Refine\r\n                                </button>\r\n                            )}\r\n                        </div>\r\n\r\n                        {isEditing ? (\r\n                            <div style={{ position: 'relative' }}>\r\n                                <textarea\r\n                                    ref={textareaRef}\r\n                                    value={editedText}\r\n                                    onChange={(e) => setEditedText(e.target.value)}\r\n                                    className=\"text-editor\"\r\n                                    placeholder=\"Type here...\"\r\n                                    rows={15}\r\n                                    style={{ width: '100%' }}\r\n                                />\r\n                            </div>\r\n                        ) : (\r\n                            <div className=\"rich-text-display markdown-content\" style={{ marginTop: '0.5rem' }}>\r\n                                {editedText ? (\r\n                                    <ReactMarkdown remarkPlugins={[remarkGfm]}>{editedText}</ReactMarkdown>\r\n                                ) : (\r\n                                    <span style={{ fontStyle: 'italic', color: '#9ca3af' }}>No content</span>\r\n                                )}\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    <div className=\"detail-row\" style={{ display: 'flex', gap: '2rem', alignItems: 'flex-start', marginTop: '1.5rem', borderTop: '1px solid var(--color-border)', paddingTop: '1rem' }}>\r\n                        <div style={{ flex: 1, display: 'flex', gap: '1rem' }}>\r\n                            <div style={{ flex: '0 0 auto' }}>\r\n                                <label style={{ display: 'block', marginBottom: '0.5rem' }}>URL Type:</label>\r\n                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>\r\n                                    {isEditing ? (\r\n                                        <select\r\n                                            value={editedUrlType || ''}\r\n                                            onChange={(e) => setEditedUrlType((e.target.value || null) as 'Video' | 'Audio' | 'Image' | 'Markdown' | 'PDF' | 'PNG' | 'Url' | 'Loop' | 'InfoGraphic' | 'Specification' | null)}\r\n                                            style={{\r\n                                                padding: '0.5rem',\r\n                                                borderRadius: '4px',\r\n                                                border: '1px solid var(--color-border)',\r\n                                                backgroundColor: 'var(--color-bg-primary)',\r\n                                                color: 'var(--color-text-primary)',\r\n                                                width: '100%'\r\n                                            }}\r\n                                        >\r\n                                            <option value=\"\">None</option>\r\n                                            <option value=\"Url\">Url</option>\r\n                                            <option value=\"Loop\">Loop</option>\r\n                                            <option value=\"Video\">Video</option>\r\n                                            <option value=\"Audio\">Audio</option>\r\n                                            <option value=\"Image\">Image</option>\r\n                                            <option value=\"Markdown\">Markdown</option>\r\n                                            <option value=\"PDF\">PDF</option>\r\n                                            <option value=\"PNG\">PNG</option>\r\n                                            <option value=\"InfoGraphic\">InfoGraphic</option>\r\n                                            <option value=\"Specification\">Specification</option>\r\n                                        </select>\r\n                                    ) : (\r\n                                        <>\r\n                                            <span style={{ marginRight: '0.5rem' }}>{currentNode.urltype || 'None'}</span>\r\n                                            {canPlayMedia && (\r\n                                                <button\r\n                                                    onClick={handlePlayMedia}\r\n                                                    style={{\r\n                                                        fontSize: '0.9rem',\r\n                                                        padding: '0.4rem 0.8rem',\r\n                                                        whiteSpace: 'nowrap'\r\n                                                    }}\r\n                                                >\r\n                                                    ­ƒôä Display\r\n                                                </button>\r\n                                            )}\r\n                                            {currentNode.urltype === 'PDF' && (\r\n                                                <button\r\n                                                    onClick={handleDisplayPdf}\r\n                                                    style={{\r\n                                                        fontSize: '0.9rem',\r\n                                                        padding: '0.4rem 0.8rem',\r\n                                                        whiteSpace: 'nowrap'\r\n                                                    }}\r\n                                                >\r\n                                                    ­ƒôæ Display\r\n                                                </button>\r\n                                            )}\r\n                                            {currentNode.urltype === 'PNG' && (\r\n                                                <button\r\n                                                    onClick={handleDisplayPng}\r\n                                                    style={{\r\n                                                        fontSize: '0.9rem',\r\n                                                        padding: '0.4rem 0.8rem',\r\n                                                        whiteSpace: 'nowrap'\r\n                                                    }}\r\n                                                >\r\n                                                    ­ƒû╝´©Å Display\r\n                                                </button>\r\n                                            )}\r\n                                        </>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n\r\n                            <div style={{ flex: 1, textAlign: 'left' }}>\r\n                                <label style={{ display: 'block', marginBottom: '0.5rem' }}>URL:</label>\r\n                                {isEditing ? (\r\n                                    <div style={{ display: 'flex', flexDirection: 'column', gap: '0.5rem' }}>\r\n                                        <select\r\n                                            value=\"\"\r\n                                            onChange={(e) => {\r\n                                                if (e.target.value) {\r\n                                                    const publicUrl = StorageService.getPublicUrl('BlobStore', e.target.value);\r\n                                                    setEditedUrl(publicUrl);\r\n                                                }\r\n                                            }}\r\n                                            style={{\r\n                                                padding: '0.5rem',\r\n                                                borderRadius: '4px',\r\n                                                border: '1px solid var(--color-border)',\r\n                                                backgroundColor: 'var(--color-bg-primary)',\r\n                                                color: 'var(--color-text-primary)',\r\n                                                width: '100%'\r\n                                            }}\r\n                                        >\r\n                                            <option value=\"\">-- Select from BlobStore --</option>\r\n                                            {blobStoreFiles.length > 0 ? (\r\n                                                blobStoreFiles.map(fileName => (\r\n                                                    <option key={fileName} value={fileName}>\r\n                                                        {fileName}\r\n                                                    </option>\r\n                                                ))\r\n                                            ) : (\r\n                                                <option value=\"\" disabled>No files found</option>\r\n                                            )}\r\n                                        </select>\r\n                                        <input\r\n                                            type=\"url\"\r\n                                            value={editedUrl}\r\n                                            onChange={(e) => setEditedUrl(e.target.value)}\r\n                                            placeholder=\"Or enter custom URL...\"\r\n                                            style={{\r\n                                                padding: '0.5rem',\r\n                                                borderRadius: '4px',\r\n                                                border: '1px solid var(--color-border)',\r\n                                                backgroundColor: 'var(--color-bg-primary)',\r\n                                                color: 'var(--color-text-primary)',\r\n                                                width: '100%'\r\n                                            }}\r\n                                        />\r\n                                    </div>\r\n                                ) : (\r\n                                    currentNode.url ? (\r\n                                        <a\r\n                                            href={currentNode.url}\r\n                                            target=\"_blank\"\r\n                                            rel=\"noopener noreferrer\"\r\n                                            style={{ wordBreak: 'break-all' }}\r\n                                            onClick={(e) => {\r\n                                                if (currentNode.urltype?.toLowerCase() === 'markdown') {\r\n                                                    e.preventDefault();\r\n                                                    handleDisplayMarkdown();\r\n                                                }\r\n                                            }}\r\n                                        >\r\n                                            {currentNode.url}\r\n                                        </a>\r\n                                    ) : (\r\n                                        <span style={{ fontStyle: 'italic', color: '#9ca3af' }}>No URL</span>\r\n                                    )\r\n                                )}\r\n                            </div>\r\n                        </div>\r\n                    </div>\r\n\r\n                    {/* Tags Section */}\r\n                    {isEditing && availableTags.length > 0 && (\r\n                        <div className=\"detail-section\" style={{ marginTop: '1.5rem', borderTop: '1px solid var(--color-border)', paddingTop: '1rem' }}>\r\n                            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>Tags:</label>\r\n                            <div style={{\r\n                                maxHeight: '150px',\r\n                                overflowY: 'auto',\r\n                                backgroundColor: 'var(--color-bg-secondary)',\r\n                                padding: '0.75rem',\r\n                                borderRadius: '4px',\r\n                                border: '1px solid var(--color-border)'\r\n                            }}>\r\n                                {renderTagCheckboxes(availableTags)}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {/* Display assigned tags when not editing */}\r\n                    {!isEditing && selectedTagIds.size > 0 && (\r\n                        <div className=\"detail-section\" style={{ marginTop: '1rem', borderTop: '1px solid var(--color-border)', paddingTop: '1rem' }}>\r\n                            <label style={{ display: 'block', marginBottom: '0.5rem' }}>Tags:</label>\r\n                            <div style={{ display: 'flex', gap: '0.5rem', flexWrap: 'wrap' }}>\r\n                                {getTagNames(availableTags, selectedTagIds).map((name, i) => (\r\n                                    <span key={i} style={{\r\n                                        backgroundColor: 'rgba(124, 58, 237, 0.3)',\r\n                                        color: '#c4b5fd',\r\n                                        padding: '0.25rem 0.5rem',\r\n                                        borderRadius: '4px',\r\n                                        fontSize: '0.85rem'\r\n                                    }}>{name}</span>\r\n                                ))}\r\n                            </div>\r\n                        </div>\r\n                    )}\r\n\r\n                    {showPlayer && canPlayMedia && node.urltype === 'Audio' && (\r\n                        <div className=\"detail-section\" style={{ marginTop: '1rem' }}>\r\n                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.5rem' }}>\r\n                                <label>Audio Player:</label>\r\n                                <button onClick={() => setShowPlayer(false)} style={{ fontSize: '0.9rem' }}>\r\n                                    Ô£ò Close Player\r\n                                </button>\r\n                            </div>\r\n                            <audio\r\n                                controls\r\n                                autoPlay\r\n                                style={{\r\n                                    width: '100%'\r\n                                }}\r\n                            >\r\n                                <source src={node.url} />\r\n                                Your browser does not support the audio tag.\r\n                            </audio>\r\n                        </div>\r\n                    )}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n\r\n    return (\r\n        <>\r\n            {ReactDOM.createPortal(modalContent, document.body)}\r\n            {showRefinementModal && (\r\n                <AIQueryRefinementModal\r\n                    initialText={selectedText || editedText}\r\n                    onClose={handleCloseRefinement}\r\n                    onPaste={handlePasteRefinement}\r\n                />\r\n            )}\r\n            {showCurationModal && (\r\n                <CurationModal\r\n                    node={currentNode}\r\n                    onClose={() => setShowCurationModal(false)}\r\n                    onArtifactSaved={() => {\r\n                        if (onUpdate) onUpdate();\r\n                    }}\r\n                />\r\n            )}\r\n        </>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\NodeItem.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\NodeTree.tsx","messages":[{"ruleId":"prefer-const","severity":2,"message":"'validParentId' is never reassigned. Use 'const' instead.","line":113,"column":17,"nodeType":"Identifier","messageId":"useConst","endLine":113,"endColumn":30,"fix":{"range":[3866,3895],"text":"const validParentId = parentId;"}},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":129,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":129,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4562,4565],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4562,4565],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":140,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":140,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5013,5016],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5013,5016],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":170,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":170,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6189,6192],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6189,6192],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":211,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":211,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7754,7757],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7754,7757],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":259,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":259,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9569,9572],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9569,9572],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":6,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":1,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport type { DocumentNode, NodeTreeItem } from '../types';\r\nimport { NodeService } from '../services/NodeService';\r\nimport { NodeItem } from './NodeItem';\r\nimport { NodeDetailsModal } from './NodeDetailsModal';\r\nimport { CurationModal } from './CurationModal';\r\nimport HierarchyCreationModal from './HierarchyCreationModal';\r\nimport { ApiKeyService } from '../services/ApiKeyService';\r\nimport { supabase } from '../lib/supabase';\r\n\r\nimport { ThemeToggle } from './ThemeToggle';\r\n\r\ninterface NodeTreeProps {\r\n    nodes: DocumentNode[];\r\n    expandedNodeIds: Set<number>;\r\n    loading: boolean;\r\n    error: string | null;\r\n    onToggle: (nodeId: number) => void;\r\n    onRefresh: () => void;\r\n    onNodeAdded: (newNode: DocumentNode) => void;\r\n    onNodeUpdated: (updatedNode: DocumentNode) => void;\r\n    onNodesUpdated: (updatedNodes: DocumentNode[]) => void;\r\n    onSave: () => void;\r\n    isSaving: boolean;\r\n    showSaveMessage: boolean;\r\n}\r\n\r\nexport const NodeTree: React.FC<NodeTreeProps> = ({\r\n    nodes,\r\n    expandedNodeIds,\r\n    loading,\r\n    error,\r\n    onToggle,\r\n    onRefresh,\r\n    onNodeAdded,\r\n    onNodeUpdated,\r\n    onNodesUpdated,\r\n    onSave,\r\n    isSaving,\r\n    showSaveMessage\r\n}) => {\r\n    const [selectedNode, setSelectedNode] = useState<DocumentNode | null>(null);\r\n    const [draggedNodeId, setDraggedNodeId] = useState<number | null>(null);\r\n    const [showHierarchyModal, setShowHierarchyModal] = useState(false);\r\n    const [hierarchyParentId, setHierarchyParentId] = useState<number | null>(null);\r\n    const [curatingNode, setCuratingNode] = useState<DocumentNode | null>(null);\r\n    const [geminiApiKey, setGeminiApiKey] = useState('');\r\n\r\n    const buildTree = (flatNodes: DocumentNode[]): NodeTreeItem[] => {\r\n        const nodeMap = new Map<number, NodeTreeItem>();\r\n        const roots: NodeTreeItem[] = [];\r\n\r\n        flatNodes.forEach(node => {\r\n            nodeMap.set(node.nodeID, { ...node, childNodes: [] });\r\n        });\r\n\r\n        flatNodes.forEach(node => {\r\n            const treeNode = nodeMap.get(node.nodeID)!;\r\n            if (node.parentNodeID === null || node.parentNodeID === 0 || node.parentNodeID === -1) {\r\n                roots.push(treeNode);\r\n            } else {\r\n                const parent = nodeMap.get(node.parentNodeID);\r\n                if (parent) {\r\n                    parent.childNodes!.push(treeNode);\r\n                } else {\r\n                    roots.push(treeNode);\r\n                }\r\n            }\r\n        });\r\n\r\n        const sortNodes = (nodes: NodeTreeItem[]) => {\r\n            nodes.sort((a, b) => (a.order || 0) - (b.order || 0));\r\n            nodes.forEach(node => {\r\n                if (node.childNodes && node.childNodes.length > 0) {\r\n                    sortNodes(node.childNodes);\r\n                }\r\n            });\r\n        };\r\n\r\n        sortNodes(roots);\r\n\r\n        return roots;\r\n    };\r\n\r\n    // Fetch Gemini API key on mount\r\n    React.useEffect(() => {\r\n        const fetchApiKey = async () => {\r\n            const { data: { user } } = await supabase.auth.getUser();\r\n            if (user) {\r\n                try {\r\n                    const apiKeys = await ApiKeyService.fetchApiKeys(user.id);\r\n                    if (apiKeys.gemini) {\r\n                        setGeminiApiKey(apiKeys.gemini);\r\n                    }\r\n                } catch (err) {\r\n                    console.error('Failed to fetch API key:', err);\r\n                }\r\n            }\r\n        };\r\n        fetchApiKey();\r\n    }, []);\r\n\r\n    const handleCreateHierarchy = (parentId: number) => {\r\n        setHierarchyParentId(parentId);\r\n        setShowHierarchyModal(true);\r\n    };\r\n\r\n    const handleAddNode = async (parentId: number | null) => {\r\n        const title = prompt('Enter node title:');\r\n        if (!title) return;\r\n\r\n        try {\r\n            let validParentId = parentId;\r\n\r\n            // Validate parent exists if parentId is provided\r\n            if (parentId) {\r\n                const parent = nodes.find(n => n.nodeID === parentId);\r\n                if (!parent) {\r\n                    alert('Parent node no longer exists. Please refresh and try again.');\r\n                    onRefresh();\r\n                    return;\r\n                }\r\n            }\r\n\r\n            // Use RPC function for proper ID generation\r\n            const createdNode = await NodeService.createNodeWithRPC(title, validParentId, '');\r\n            // Use optimistic update instead of full refresh\r\n            onNodeAdded(createdNode);\r\n        } catch (err: any) {\r\n            alert('Failed to create node: ' + err.message);\r\n        }\r\n    };\r\n\r\n    const handleEditNode = async (node: DocumentNode, newTitle: string) => {\r\n        if (node.title === newTitle) return;\r\n        try {\r\n            const updatedNode = await NodeService.updateNode(node.nodeID, { title: newTitle });\r\n            // Use optimistic update instead of full refresh\r\n            onNodeUpdated(updatedNode);\r\n        } catch (err: any) {\r\n            alert('Failed to update node: ' + err.message);\r\n        }\r\n    };\r\n\r\n    const handleDeleteNode = async (nodeId: number) => {\r\n        const nodeToDelete = nodes.find(n => n.nodeID === nodeId);\r\n        if (!nodeToDelete) return;\r\n\r\n        // Count children to warn user about cascade delete\r\n        const countDescendants = (parentId: number): number => {\r\n            const children = nodes.filter(n => n.parentNodeID === parentId);\r\n            return children.reduce((count, child) => {\r\n                return count + 1 + countDescendants(child.nodeID);\r\n            }, 0);\r\n        };\r\n\r\n        const descendantCount = countDescendants(nodeId);\r\n\r\n        let confirmMessage = `Are you sure you want to delete \"${nodeToDelete.title}\"?`;\r\n        if (descendantCount > 0) {\r\n            confirmMessage += `\\n\\nThis will also delete ${descendantCount} descendant node${descendantCount > 1 ? 's' : ''}.`;\r\n        }\r\n\r\n        if (!confirm(confirmMessage)) return;\r\n\r\n        try {\r\n            await NodeService.deleteNode(nodeId);\r\n            // Refresh to sync with cascade deletes from database\r\n            onRefresh();\r\n        } catch (err: any) {\r\n            alert('Failed to delete node: ' + err.message);\r\n        }\r\n    };\r\n\r\n    const handleMoveNodeUpDown = async (nodeId: number, direction: 'up' | 'down') => {\r\n        const node = nodes.find(n => n.nodeID === nodeId);\r\n        if (!node) return;\r\n\r\n        // Get all siblings (nodes with the same parent)\r\n        const siblings = nodes\r\n            .filter(n => n.parentNodeID === node.parentNodeID)\r\n            .sort((a, b) => (a.order || 0) - (b.order || 0));\r\n\r\n        const currentIndex = siblings.findIndex(n => n.nodeID === nodeId);\r\n\r\n        // Check if move is valid\r\n        if (currentIndex === -1) return;\r\n        if (direction === 'up' && currentIndex === 0) return;\r\n        if (direction === 'down' && currentIndex === siblings.length - 1) return;\r\n\r\n        // Swap positions\r\n        const swapIndex = direction === 'up' ? currentIndex - 1 : currentIndex + 1;\r\n        const temp = siblings[currentIndex];\r\n        siblings[currentIndex] = siblings[swapIndex];\r\n        siblings[swapIndex] = temp;\r\n\r\n        try {\r\n            // Update order for all affected siblings\r\n            const updates = siblings.map((sibling, index) => ({\r\n                nodeID: sibling.nodeID,\r\n                order: index\r\n            }));\r\n\r\n            // Update in database\r\n            const updatedNodes = await Promise.all(\r\n                updates.map(u => NodeService.updateNode(u.nodeID, { order: u.order }))\r\n            );\r\n\r\n            // Use optimistic update\r\n            onNodesUpdated(updatedNodes);\r\n        } catch (err: any) {\r\n            alert('Failed to reorder node: ' + err.message);\r\n            // On error, refresh to get correct state\r\n            onRefresh();\r\n        }\r\n    };\r\n\r\n    const handleDragStart = (nodeId: number) => {\r\n        setDraggedNodeId(nodeId);\r\n    };\r\n\r\n    const handleMoveNode = async (targetNodeId: number) => {\r\n        if (draggedNodeId === null || draggedNodeId === targetNodeId) return;\r\n\r\n        const draggedNode = nodes.find(n => n.nodeID === draggedNodeId);\r\n        const targetNode = nodes.find(n => n.nodeID === targetNodeId);\r\n\r\n        if (!draggedNode || !targetNode) return;\r\n\r\n        if (draggedNode.parentNodeID !== targetNode.parentNodeID) {\r\n            console.warn('Reparenting not yet supported via drag and drop');\r\n            return;\r\n        }\r\n\r\n        try {\r\n            const siblings = nodes.filter(n => n.parentNodeID === draggedNode.parentNodeID)\r\n                .sort((a, b) => (a.order || 0) - (b.order || 0));\r\n\r\n            const draggedIndex = siblings.findIndex(n => n.nodeID === draggedNodeId);\r\n            const targetIndex = siblings.findIndex(n => n.nodeID === targetNodeId);\r\n\r\n            if (draggedIndex === -1 || targetIndex === -1) return;\r\n\r\n            siblings.splice(draggedIndex, 1);\r\n            siblings.splice(targetIndex, 0, draggedNode);\r\n\r\n            const updates = siblings.map((node, index) => ({\r\n                nodeID: node.nodeID,\r\n                order: index\r\n            }));\r\n\r\n            // Update all affected nodes in the database\r\n            const updatedNodes = await Promise.all(\r\n                updates.map(u => NodeService.updateNode(u.nodeID, { order: u.order }))\r\n            );\r\n\r\n            // Use optimistic update instead of full refresh\r\n            onNodesUpdated(updatedNodes);\r\n        } catch (err: any) {\r\n            alert('Failed to move node: ' + err.message);\r\n            // On error, do a full refresh to get correct state\r\n            onRefresh();\r\n        }\r\n    };\r\n\r\n    const [showActions, setShowActions] = useState(false);\r\n\r\n    const treeData = buildTree(nodes);\r\n\r\n    // Removed early return for loading to prevent unmounting children (modals)\r\n    if (error) {\r\n        console.log(\"[NodeTree] Error:\", error);\r\n        return <div style={{ color: 'red' }}>Error: {error}</div>;\r\n    }\r\n\r\n    console.log(\"[NodeTree] Render. SelectedNode:\", selectedNode?.nodeID);\r\n\r\n    return (\r\n        <div className=\"tree-container\" style={{ position: 'relative' }}>\r\n            {loading && (\r\n                <div style={{\r\n                    position: 'absolute',\r\n                    top: 0,\r\n                    left: 0,\r\n                    right: 0,\r\n                    bottom: 0,\r\n                    backgroundColor: 'rgba(0,0,0,0.3)',\r\n                    zIndex: 10,\r\n                    display: 'flex',\r\n                    justifyContent: 'center',\r\n                    alignItems: 'center',\r\n                    color: 'white',\r\n                    fontSize: '1.2em',\r\n                    fontWeight: 'bold',\r\n                    backdropFilter: 'blur(2px)',\r\n                    borderRadius: '8px'\r\n                }}>\r\n                    Loading...\r\n                </div>\r\n            )}\r\n            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' }}>\r\n                <h2 style={{ margin: 0 }}>Expert quality assured Knowledge</h2>\r\n                <div style={{ display: 'flex', gap: '1rem', alignItems: 'center' }}>\r\n                    {showSaveMessage && <span style={{ color: '#4ade80', fontWeight: 'bold', animation: 'fadeIn 0.3s ease-in-out' }}>Hierarchy Saved</span>}\r\n                    <button onClick={onSave} disabled={isSaving || loading}>\r\n                        {isSaving ? 'Saving...' : 'Save View'}\r\n                    </button>\r\n                    <button\r\n                        onClick={onRefresh}\r\n                        disabled={loading}\r\n                        title=\"Reload from server (discards unsaved changes)\"\r\n                    >\r\n                        Refresh\r\n                    </button>\r\n                    <ThemeToggle />\r\n                    <button\r\n                        onClick={() => setShowActions(!showActions)}\r\n                        style={{\r\n                            background: 'none',\r\n                            border: 'none',\r\n                            cursor: 'pointer',\r\n                            fontSize: '1.2rem',\r\n                            padding: '0.5rem',\r\n                            borderRadius: '4px',\r\n                            color: 'var(--color-text-primary)'\r\n                        }}\r\n                        title={showActions ? \"Hide Actions\" : \"Show Actions\"}\r\n                    >\r\n                        ÔÜÖ´©Å\r\n                    </button>\r\n                </div>\r\n            </div>\r\n\r\n            {treeData.length === 0 ? (\r\n                <div style={{ color: '#6b7280', fontStyle: 'italic' }}>No nodes found.</div>\r\n            ) : (\r\n                treeData.map(node => (\r\n                    <NodeItem\r\n                        key={node.nodeID}\r\n                        node={node}\r\n                        isExpanded={expandedNodeIds.has(node.nodeID)}\r\n                        expandedNodeIds={expandedNodeIds}\r\n                        onAdd={handleAddNode}\r\n                        onEdit={handleEditNode}\r\n                        onDelete={handleDeleteNode}\r\n                        onClick={setSelectedNode}\r\n                        onDragStart={handleDragStart}\r\n                        onDrop={handleMoveNode}\r\n                        onToggle={onToggle}\r\n                        onMoveUpDown={handleMoveNodeUpDown}\r\n                        onCreateHierarchy={handleCreateHierarchy}\r\n                        onCurate={setCuratingNode}\r\n                        showActions={showActions}\r\n                    />\r\n                ))\r\n            )}\r\n\r\n            {selectedNode && (\r\n                <NodeDetailsModal\r\n                    node={selectedNode}\r\n                    onClose={() => {\r\n                        console.log(\"[NodeTree] Closing NodeDetailsModal (via onClose)\");\r\n                        setSelectedNode(null);\r\n                    }}\r\n                    onUpdate={onRefresh}\r\n                />\r\n            )}\r\n\r\n            {showHierarchyModal && geminiApiKey && (\r\n                <HierarchyCreationModal\r\n                    parentNodeId={hierarchyParentId}\r\n                    onClose={() => setShowHierarchyModal(false)}\r\n                    onHierarchyCreated={onRefresh}\r\n                    geminiApiKey={geminiApiKey}\r\n                />\r\n            )}\r\n\r\n            {curatingNode && (\r\n                <CurationModal\r\n                    node={curatingNode}\r\n                    onClose={() => setCuratingNode(null)}\r\n                    onArtifactSaved={onRefresh}\r\n                />\r\n            )}\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\TagFilterModal.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'selectedTagIds'. Either include it or remove the dependency array. If 'setTempSelectedIds' needs the current value of 'selectedTagIds', you can also switch to useReducer instead of useState and read 'selectedTagIds' in the reducer.","line":31,"column":8,"nodeType":"ArrayExpression","endLine":31,"endColumn":16,"suggestions":[{"desc":"Update the dependencies array to be: [isOpen, selectedTagIds]","fix":{"range":[1015,1023],"text":"[isOpen, selectedTagIds]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport type { TagTreeNode } from '../types/tags';\r\nimport { TagService } from '../services/TagService';\r\n\r\ninterface TagFilterModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onSelectTags: (tagIds: Set<number>) => void;\r\n    selectedTagIds: Set<number>;\r\n}\r\n\r\nexport const TagFilterModal: React.FC<TagFilterModalProps> = ({\r\n    isOpen,\r\n    onClose,\r\n    onSelectTags,\r\n    selectedTagIds\r\n}) => {\r\n    const [tags, setTags] = useState<TagTreeNode[]>([]);\r\n    const [expandedTagIds, setExpandedTagIds] = useState<Set<number>>(new Set());\r\n    const [loading, setLoading] = useState(false);\r\n\r\n    // Local selection state for multi-select\r\n    const [tempSelectedIds, setTempSelectedIds] = useState<Set<number>>(new Set());\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            loadTags();\r\n            // Initialize local state with currently active filters\r\n            setTempSelectedIds(new Set(selectedTagIds));\r\n        }\r\n    }, [isOpen]);\r\n\r\n    const loadTags = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const fetchedTags = await TagService.fetchTagTree();\r\n            setTags(fetchedTags);\r\n\r\n            // Auto-expand Level 0 and 1\r\n            const expandIds = new Set<number>();\r\n            fetchedTags.forEach(t => {\r\n                if (t.level === 0) {\r\n                    expandIds.add(t.id);\r\n                    if (t.childNodes) {\r\n                        t.childNodes.forEach(child => {\r\n                            if (child.level === 1) expandIds.add(child.id);\r\n                        });\r\n                    }\r\n                }\r\n            });\r\n            setExpandedTagIds(expandIds);\r\n        } catch (error) {\r\n            console.error('Failed to load tags:', error);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const toggleTagExpand = (tagId: number, e: React.MouseEvent) => {\r\n        e.stopPropagation();\r\n        setExpandedTagIds(prev => {\r\n            const next = new Set(prev);\r\n            if (next.has(tagId)) {\r\n                next.delete(tagId);\r\n            } else {\r\n                next.add(tagId);\r\n            }\r\n            return next;\r\n        });\r\n    };\r\n\r\n    const handleTagClick = (tagId: number) => {\r\n        setTempSelectedIds(prev => {\r\n            const next = new Set(prev);\r\n            if (next.has(tagId)) {\r\n                next.delete(tagId);\r\n            } else {\r\n                next.add(tagId);\r\n            }\r\n            return next;\r\n        });\r\n    };\r\n\r\n    const handleApply = () => {\r\n        onSelectTags(tempSelectedIds);\r\n        onClose();\r\n    };\r\n\r\n    const handleClearFilter = () => {\r\n        setTempSelectedIds(new Set());\r\n        // Do not update parent yet, user must click Apply? \r\n        // Or \"Clear\" usually means \"Reset immediately\"? \r\n        // Let's make Clear reset local, user can Apply. \r\n        // Or better: \"Clear & Apply\" behavior?\r\n        // Standard pattern: Clear clears selection. Apply commits it.\r\n    };\r\n\r\n    // Separated component to validly use hooks (useState for hover)\r\n    const TagItem: React.FC<{\r\n        tag: TagTreeNode;\r\n        expandedTagIds: Set<number>;\r\n        selectedIds: Set<number>;\r\n        onToggleExpand: (tagId: number, e: React.MouseEvent) => void;\r\n        onSelect: (tagId: number) => void;\r\n    }> = ({ tag, expandedTagIds, selectedIds, onToggleExpand, onSelect }) => {\r\n        const hasChildren = tag.childNodes && tag.childNodes.length > 0;\r\n        const isExpanded = expandedTagIds.has(tag.id);\r\n        const isSelected = selectedIds.has(tag.id);\r\n        const [isHovered, setIsHovered] = useState(false);\r\n\r\n        return (\r\n            <li style={{ marginBottom: '4px' }}>\r\n                <div\r\n                    onClick={() => onSelect(tag.id)}\r\n                    onMouseEnter={() => setIsHovered(true)}\r\n                    onMouseLeave={() => setIsHovered(false)}\r\n                    style={{\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        cursor: 'pointer',\r\n                        padding: '8px 12px',\r\n                        borderRadius: '6px',\r\n                        backgroundColor: isSelected\r\n                            ? 'rgba(124, 58, 237, 0.3)'\r\n                            : isHovered\r\n                                ? 'rgba(255, 255, 255, 0.05)'\r\n                                : 'transparent',\r\n                        border: isSelected ? '1px solid #8b5cf6' : '1px solid transparent',\r\n                        transition: 'all 0.2s ease',\r\n                        gap: '10px'\r\n                    }}\r\n                    className=\"tag-item\"\r\n                >\r\n                    {/* Expand/Collapse toggle */}\r\n                    <div style={{\r\n                        width: '24px',\r\n                        height: '24px',\r\n                        display: 'flex',\r\n                        justifyContent: 'center',\r\n                        alignItems: 'center',\r\n                        flexShrink: 0\r\n                    }}>\r\n                        {hasChildren ? (\r\n                            <button\r\n                                onClick={(e) => onToggleExpand(tag.id, e)}\r\n                                style={{\r\n                                    background: 'none',\r\n                                    border: 'none',\r\n                                    cursor: 'pointer',\r\n                                    color: isHovered ? '#fff' : '#888',\r\n                                    padding: '0',\r\n                                    fontSize: '0.8rem',\r\n                                    display: 'flex',\r\n                                    alignItems: 'center',\r\n                                    justifyContent: 'center',\r\n                                    width: '100%',\r\n                                    height: '100%',\r\n                                    transition: 'color 0.2s'\r\n                                }}\r\n                            >\r\n                                {isExpanded ? 'Ôû╝' : 'ÔûÂ'}\r\n                            </button>\r\n                        ) : (\r\n                            <span style={{ width: '20px' }}></span>\r\n                        )}\r\n                    </div>\r\n\r\n                    {/* Icon based on type */}\r\n                    <span style={{ fontSize: '1.2rem', opacity: isSelected ? 1 : 0.8 }}>\r\n                        {hasChildren ? (isExpanded ? '­ƒôé' : '­ƒôü') : '­ƒÅÀ´©Å'}\r\n                    </span>\r\n\r\n                    <span style={{\r\n                        color: isSelected ? '#fff' : '#ccc',\r\n                        fontWeight: isSelected ? '600' : 'normal',\r\n                        fontSize: '0.95rem',\r\n                        flex: 1,\r\n                        // Ensure text is left aligned\r\n                        textAlign: 'left'\r\n                    }}>\r\n                        {tag.name}\r\n                    </span>\r\n\r\n                    {/* Checkbox-style indicator for multi-select */}\r\n                    <div style={{\r\n                        width: '18px',\r\n                        height: '18px',\r\n                        border: isSelected ? '1px solid #8b5cf6' : '1px solid #666',\r\n                        borderRadius: '4px',\r\n                        backgroundColor: isSelected ? '#8b5cf6' : 'transparent',\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        justifyContent: 'center',\r\n                        marginLeft: '8px'\r\n                    }}>\r\n                        {isSelected && <span style={{ color: '#fff', fontSize: '12px' }}>Ô£ô</span>}\r\n                    </div>\r\n                </div>\r\n\r\n                {/* Children */}\r\n                {hasChildren && isExpanded && (\r\n                    <TagTreeList\r\n                        tags={tag.childNodes}\r\n                        expandedTagIds={expandedTagIds}\r\n                        selectedIds={selectedIds}\r\n                        onToggleExpand={onToggleExpand}\r\n                        onSelect={onSelect}\r\n                        isRoot={false}\r\n                    />\r\n                )}\r\n            </li>\r\n        );\r\n    };\r\n\r\n    // Recursive List Component\r\n    const TagTreeList: React.FC<{\r\n        tags: TagTreeNode[];\r\n        expandedTagIds: Set<number>;\r\n        selectedIds: Set<number>;\r\n        onToggleExpand: (tagId: number, e: React.MouseEvent) => void;\r\n        onSelect: (tagId: number) => void;\r\n        isRoot?: boolean;\r\n    }> = ({ tags, expandedTagIds, selectedIds, onToggleExpand, onSelect, isRoot = true }) => {\r\n        return (\r\n            <ul style={{\r\n                listStyle: 'none',\r\n                // Updated padding to align strictly if desired, but 20px indent for hierarchy is good. \r\n                // The prompt asked to \"left justify the title\". \r\n                // We'll trust the modal padding adjustment below.\r\n                paddingLeft: isRoot ? '0' : '20px',\r\n                margin: 0\r\n            }}>\r\n                {tags.map(tag => (\r\n                    <TagItem\r\n                        key={tag.id}\r\n                        tag={tag}\r\n                        expandedTagIds={expandedTagIds}\r\n                        selectedIds={selectedIds}\r\n                        onToggleExpand={onToggleExpand}\r\n                        onSelect={onSelect}\r\n                    />\r\n                ))}\r\n            </ul>\r\n        );\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return (\r\n        <div style={{\r\n            position: 'fixed',\r\n            top: 0,\r\n            left: 0,\r\n            right: 0,\r\n            bottom: 0,\r\n            backgroundColor: 'rgba(0,0,0,0.8)',\r\n            display: 'flex',\r\n            justifyContent: 'center',\r\n            alignItems: 'center',\r\n            zIndex: 1000\r\n        }}>\r\n            <div style={{\r\n                backgroundColor: '#1a1a2e',\r\n                color: '#fff',\r\n                borderRadius: '12px',\r\n                width: '90%',\r\n                maxWidth: '500px',\r\n                height: '80vh',\r\n                display: 'flex',\r\n                flexDirection: 'column',\r\n                boxShadow: '0 8px 32px rgba(0,0,0,0.5)',\r\n                overflow: 'hidden'\r\n            }}>\r\n                {/* Header */}\r\n                <div style={{\r\n                    padding: '1.25rem', // Matches content padding now? Content was 1rem.\r\n                    // The user said \"left justify the title\". The header \"Filter by Tag\" is inside this flex.\r\n                    // Let's make padding uniform.\r\n                    paddingLeft: '1.25rem',\r\n                    paddingRight: '1.25rem',\r\n                    paddingTop: '1.25rem',\r\n                    paddingBottom: '1.25rem',\r\n                    borderBottom: '1px solid #333',\r\n                    display: 'flex',\r\n                    justifyContent: 'space-between',\r\n                    alignItems: 'center',\r\n                    background: 'linear-gradient(135deg, #16213e 0%, #1a1a2e 100%)'\r\n                }}>\r\n                    <h2 style={{ margin: 0, fontSize: '1.2rem', textAlign: 'left' }}>­ƒÅÀ´©Å Filter by Tag</h2>\r\n                    <button\r\n                        onClick={onClose}\r\n                        style={{\r\n                            background: 'none',\r\n                            border: 'none',\r\n                            color: '#888',\r\n                            fontSize: '1.5rem',\r\n                            cursor: 'pointer'\r\n                        }}\r\n                    >\r\n                        Ô£ò\r\n                    </button>\r\n                </div>\r\n\r\n                {/* Content */}\r\n                <div style={{\r\n                    flex: 1,\r\n                    overflowY: 'auto',\r\n                    // Making padding same as header for vertical alignment lines\r\n                    padding: '1.25rem'\r\n                }}>\r\n                    {loading ? (\r\n                        <div style={{ textAlign: 'center', color: '#666', padding: '2rem' }}>Loading tags...</div>\r\n                    ) : (\r\n                        <div style={{\r\n                            // Removed paddingRight: '1rem' to use the container padding\r\n\r\n                        }}>\r\n                            <TagTreeList\r\n                                tags={tags}\r\n                                expandedTagIds={expandedTagIds}\r\n                                selectedIds={tempSelectedIds}\r\n                                onToggleExpand={toggleTagExpand}\r\n                                onSelect={handleTagClick}\r\n                                isRoot={true}\r\n                            />\r\n                        </div>\r\n                    )}\r\n                </div>\r\n\r\n                {/* Footer */}\r\n                <div style={{\r\n                    padding: '1rem',\r\n                    borderTop: '1px solid #333',\r\n                    display: 'flex',\r\n                    justifyContent: 'flex-end',\r\n                    gap: '1rem',\r\n                    backgroundColor: '#0f0f1a'\r\n                }}>\r\n                    <button\r\n                        onClick={handleClearFilter}\r\n                        style={{\r\n                            padding: '0.6rem 1.2rem',\r\n                            backgroundColor: 'transparent',\r\n                            color: '#ef4444',\r\n                            border: '1px solid #ef4444',\r\n                            borderRadius: '6px',\r\n                            cursor: 'pointer',\r\n                            fontSize: '0.9rem'\r\n                        }}\r\n                    >\r\n                        Clear Selection\r\n                    </button>\r\n                    <button\r\n                        onClick={handleApply}\r\n                        style={{\r\n                            padding: '0.6rem 1.2rem',\r\n                            backgroundColor: '#8b5cf6',\r\n                            color: 'white',\r\n                            border: 'none',\r\n                            borderRadius: '6px',\r\n                            cursor: 'pointer',\r\n                            fontSize: '0.9rem',\r\n                            fontWeight: 'bold'\r\n                        }}\r\n                    >\r\n                        Apply Filter ({tempSelectedIds.size})\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\TagMaintenanceModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":32,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":32,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1145,1148],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1145,1148],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":48,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":48,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1607,1610],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1607,1610],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":59,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":59,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1961,1964],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1961,1964],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":69,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":69,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2294,2297],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2294,2297],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":4,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState, useEffect } from 'react';\r\nimport type { TagTreeNode } from '../types/tags';\r\nimport { TagService } from '../services/TagService';\r\n\r\ninterface TagMaintenanceModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n}\r\n\r\nexport const TagMaintenanceModal: React.FC<TagMaintenanceModalProps> = ({ isOpen, onClose }) => {\r\n    const [tags, setTags] = useState<TagTreeNode[]>([]);\r\n    const [loading, setLoading] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n\r\n    // Form State\r\n    const [newTagName, setNewTagName] = useState('');\r\n    const [selectedParentId, setSelectedParentId] = useState<number | null>(null);\r\n    const [editingTag, setEditingTag] = useState<{ id: number, name: string } | null>(null);\r\n    const [expandedIds, setExpandedIds] = useState<Set<number>>(new Set());\r\n\r\n    useEffect(() => {\r\n        if (isOpen) {\r\n            loadTags();\r\n        }\r\n    }, [isOpen]);\r\n\r\n    const loadTags = async () => {\r\n        setLoading(true);\r\n        try {\r\n            const tree = await TagService.fetchTagTree();\r\n            setTags(tree);\r\n        } catch (err: any) {\r\n            setError(err.message);\r\n        } finally {\r\n            setLoading(false);\r\n        }\r\n    };\r\n\r\n    const handleCreateTag = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (!newTagName.trim()) return;\r\n\r\n        try {\r\n            await TagService.createTag(newTagName, selectedParentId);\r\n            setNewTagName('');\r\n            setSelectedParentId(null);\r\n            await loadTags();\r\n        } catch (err: any) {\r\n            setError(err.message);\r\n        }\r\n    };\r\n\r\n    const handleUpdateTag = async () => {\r\n        if (!editingTag || !editingTag.name.trim()) return;\r\n        try {\r\n            await TagService.updateTag(editingTag.id, { name: editingTag.name });\r\n            setEditingTag(null);\r\n            await loadTags();\r\n        } catch (err: any) {\r\n            setError(err.message);\r\n        }\r\n    };\r\n\r\n    const handleDeleteTag = async (id: number) => {\r\n        if (!window.confirm('Are you sure? This will delete the tag and all its children.')) return;\r\n        try {\r\n            await TagService.deleteTag(id);\r\n            await loadTags();\r\n        } catch (err: any) {\r\n            setError(err.message);\r\n        }\r\n    };\r\n\r\n    const toggleExpand = (id: number) => {\r\n        setExpandedIds(prev => {\r\n            const next = new Set(prev);\r\n            if (next.has(id)) {\r\n                next.delete(id);\r\n            } else {\r\n                next.add(id);\r\n            }\r\n            return next;\r\n        });\r\n    };\r\n\r\n    const renderTree = (nodes: TagTreeNode[]) => {\r\n        return (\r\n            <ul style={{ listStyle: 'none', paddingLeft: '20px' }}>\r\n                {nodes.map(node => {\r\n                    const hasChildren = node.childNodes && node.childNodes.length > 0;\r\n                    const isExpanded = expandedIds.has(node.id);\r\n\r\n                    return (\r\n                        <li key={node.id} style={{ marginBottom: '5px' }}>\r\n                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px' }}>\r\n                                {/* Expand/Collapse toggle */}\r\n                                {hasChildren ? (\r\n                                    <button\r\n                                        onClick={() => toggleExpand(node.id)}\r\n                                        style={{\r\n                                            background: 'none',\r\n                                            border: 'none',\r\n                                            cursor: 'pointer',\r\n                                            color: '#888',\r\n                                            padding: '0',\r\n                                            fontSize: '0.9rem',\r\n                                            width: '16px'\r\n                                        }}\r\n                                    >\r\n                                        {isExpanded ? 'Ôû╝' : 'ÔûÂ'}\r\n                                    </button>\r\n                                ) : (\r\n                                    <span style={{ width: '16px', display: 'inline-block' }}></span>\r\n                                )}\r\n\r\n                                {editingTag?.id === node.id ? (\r\n                                    <>\r\n                                        <input\r\n                                            type=\"text\"\r\n                                            value={editingTag.name}\r\n                                            onChange={(e) => setEditingTag({ ...editingTag, name: e.target.value })}\r\n                                            style={{ padding: '2px 5px', borderRadius: '4px', border: '1px solid #ccc', color: '#FFD700', backgroundColor: '#333' }}\r\n                                        />\r\n                                        <button onClick={handleUpdateTag} style={{ fontSize: '0.8rem', cursor: 'pointer', backgroundColor: '#4CAF50', color: 'white', border: 'none', padding: '2px 5px', borderRadius: '3px' }}>Save</button>\r\n                                        <button onClick={() => setEditingTag(null)} style={{ fontSize: '0.8rem', cursor: 'pointer', backgroundColor: '#f44336', color: 'white', border: 'none', padding: '2px 5px', borderRadius: '3px' }}>Cancel</button>\r\n                                    </>\r\n                                ) : (\r\n                                    <>\r\n                                        <span style={{ fontWeight: 'bold' }}>{node.name}</span>\r\n                                        <button onClick={() => setEditingTag({ id: node.id, name: node.name })} style={{ fontSize: '0.7rem', cursor: 'pointer', background: 'none', border: 'none', color: '#2196F3' }}>Edit</button>\r\n                                        <button onClick={() => handleDeleteTag(node.id)} style={{ fontSize: '0.7rem', cursor: 'pointer', background: 'none', border: 'none', color: '#f44336' }}>Delete</button>\r\n                                        <button onClick={() => setSelectedParentId(node.id)} style={{ fontSize: '0.7rem', cursor: 'pointer', background: 'none', border: 'none', color: '#FF9800' }}>Add Child</button>\r\n                                    </>\r\n                                )}\r\n                            </div>\r\n                            {hasChildren && isExpanded && renderTree(node.childNodes)}\r\n                        </li>\r\n                    );\r\n                })}\r\n            </ul>\r\n        );\r\n    };\r\n\r\n    // Flatten for dropdown\r\n    const getAllTags = (nodes: TagTreeNode[]): { id: number, name: string, level: number }[] => {\r\n        let result: { id: number, name: string, level: number }[] = [];\r\n        nodes.forEach(node => {\r\n            result.push({ id: node.id, name: node.name, level: node.level });\r\n            if (node.childNodes) {\r\n                result = [...result, ...getAllTags(node.childNodes)];\r\n            }\r\n        });\r\n        return result;\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return (\r\n        <div style={{\r\n            position: 'fixed',\r\n            top: 0,\r\n            left: 0,\r\n            right: 0,\r\n            bottom: 0,\r\n            backgroundColor: 'rgba(0,0,0,0.7)',\r\n            display: 'flex',\r\n            justifyContent: 'center',\r\n            alignItems: 'center',\r\n            zIndex: 1000\r\n        }}>\r\n            <div style={{\r\n                backgroundColor: '#1E1E1E',\r\n                color: '#fff',\r\n                padding: '2rem',\r\n                borderRadius: '8px',\r\n                width: '600px',\r\n                maxHeight: '80vh',\r\n                overflowY: 'auto',\r\n                boxShadow: '0 4px 6px rgba(0,0,0,0.3)',\r\n                position: 'relative'\r\n            }}>\r\n                <button\r\n                    onClick={onClose}\r\n                    style={{\r\n                        position: 'absolute',\r\n                        top: '1rem',\r\n                        right: '1rem',\r\n                        background: 'none',\r\n                        border: 'none',\r\n                        color: '#aaa',\r\n                        fontSize: '1.5rem',\r\n                        cursor: 'pointer'\r\n                    }}\r\n                >\r\n                    &times;\r\n                </button>\r\n\r\n                <h2 style={{ marginTop: 0, marginBottom: '1.5rem' }}>Tag Maintenance</h2>\r\n\r\n                {error && (\r\n                    <div style={{ backgroundColor: 'rgba(255, 0, 0, 0.1)', color: '#ff6b6b', padding: '0.75rem', borderRadius: '4px', marginBottom: '1rem' }}>\r\n                        {error}\r\n                    </div>\r\n                )}\r\n\r\n                <form onSubmit={handleCreateTag} style={{ marginBottom: '2rem', display: 'flex', gap: '0.5rem', alignItems: 'center' }}>\r\n                    <input\r\n                        type=\"text\"\r\n                        placeholder=\"New Tag Name\"\r\n                        value={newTagName}\r\n                        onChange={(e) => setNewTagName(e.target.value)}\r\n                        style={{\r\n                            padding: '0.5rem',\r\n                            borderRadius: '4px',\r\n                            border: '1px solid #333',\r\n                            backgroundColor: '#2D2D2D',\r\n                            color: '#fff',\r\n                            flex: 1\r\n                        }}\r\n                    />\r\n                    <select\r\n                        value={selectedParentId || ''}\r\n                        onChange={(e) => setSelectedParentId(e.target.value ? Number(e.target.value) : null)}\r\n                        style={{\r\n                            padding: '0.5rem',\r\n                            borderRadius: '4px',\r\n                            border: '1px solid #333',\r\n                            backgroundColor: '#2D2D2D',\r\n                            color: '#fff'\r\n                        }}\r\n                    >\r\n                        <option value=\"\">No Parent (Root)</option>\r\n                        {getAllTags(tags).map(tag => (\r\n                            <option key={tag.id} value={tag.id}>\r\n                                {'-'.repeat(tag.level)} {tag.name}\r\n                            </option>\r\n                        ))}\r\n                    </select>\r\n                    <button\r\n                        type=\"submit\"\r\n                        disabled={loading}\r\n                        style={{\r\n                            padding: '0.5rem 1rem',\r\n                            backgroundColor: '#3B82F6',\r\n                            color: 'white',\r\n                            border: 'none',\r\n                            borderRadius: '4px',\r\n                            cursor: 'pointer'\r\n                        }}\r\n                    >\r\n                        Add\r\n                    </button>\r\n                </form>\r\n\r\n                <div style={{ borderTop: '1px solid #333', paddingTop: '1rem' }}>\r\n                    {loading ? <div>Loading tags...</div> : renderTree(tags)}\r\n                </div>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\ThemeToggle.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\UploadModal.tsx","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":73,"column":31,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":73,"endColumn":34,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3047,3050],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3047,3050],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":88,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":88,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3699,3702],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3699,3702],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import React, { useState } from 'react';\r\nimport { StorageService } from '../services/StorageService';\r\nimport { NodeService } from '../services/NodeService';\r\n\r\ninterface UploadModalProps {\r\n    isOpen: boolean;\r\n    onClose: () => void;\r\n    onUploadComplete?: () => void;\r\n}\r\n\r\nexport const UploadModal: React.FC<UploadModalProps> = ({ isOpen, onClose, onUploadComplete }) => {\r\n    const [files, setFiles] = useState<File[]>([]);\r\n    const [uploading, setUploading] = useState(false);\r\n    const [error, setError] = useState<string | null>(null);\r\n    const [successMessage, setSuccessMessage] = useState<string | null>(null);\r\n\r\n    const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n        if (e.target.files) {\r\n            setFiles(Array.from(e.target.files));\r\n        }\r\n    };\r\n\r\n    const determineUrlType = (mimeType: string): 'Video' | 'Audio' | 'Image' | 'Markdown' | 'PDF' | 'PNG' | 'Url' | 'Loop' | 'InfoGraphic' | 'Specification' | null => {\r\n        if (mimeType.startsWith('image/')) return 'Image';\r\n        if (mimeType.startsWith('video/')) return 'Video';\r\n        if (mimeType.startsWith('audio/')) return 'Audio';\r\n        if (mimeType === 'application/pdf') return 'PDF';\r\n        if (mimeType === 'text/markdown') return 'Markdown';\r\n        return 'Url';\r\n    };\r\n\r\n    const handleUpload = async (e: React.FormEvent) => {\r\n        e.preventDefault();\r\n        if (files.length === 0) return;\r\n\r\n        setUploading(true);\r\n        setError(null);\r\n        setSuccessMessage(null);\r\n\r\n        try {\r\n            let successCount = 0;\r\n            const errors: string[] = [];\r\n\r\n            for (const file of files) {\r\n                try {\r\n                    // 1. Upload to Storage\r\n                    const timestamp = new Date().getTime();\r\n                    const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');\r\n                    const path = `uploads/${timestamp}_${safeName}`;\r\n\r\n                    const { path: storagePath } = await StorageService.uploadFile(file, path);\r\n                    const publicUrl = StorageService.getPublicUrl(storagePath);\r\n\r\n                    // 2. Create Document Node\r\n                    // We need a parent node. For now, creating as root nodes or unparented?\r\n                    // User didn't specify parent. Defaulting to root (null).\r\n                    const newNode = await NodeService.createNodeWithRPC(\r\n                        file.name,\r\n                        null, // root\r\n                        '' // text\r\n                    );\r\n\r\n                    // Update node with URL and Type\r\n                    await NodeService.updateNode(newNode.nodeID, {\r\n                        url: publicUrl,\r\n                        urltype: determineUrlType(file.type)\r\n                    });\r\n\r\n                    // Note: Tag assignment is now standalone - tags are managed separately\r\n                    // and not directly linked to document nodes.\r\n\r\n                    successCount++;\r\n                } catch (err: any) {\r\n                    console.error(`Failed to upload ${file.name}:`, err);\r\n                    errors.push(`${file.name}: ${err.message}`);\r\n                }\r\n            }\r\n\r\n            if (successCount === files.length) {\r\n                setSuccessMessage(`Successfully uploaded ${successCount} files. Use \"Classify\" to assign tags.`);\r\n                setFiles([]);\r\n                if (onUploadComplete) onUploadComplete();\r\n                setTimeout(onClose, 2000);\r\n            } else {\r\n                setError(`Uploaded ${successCount}/${files.length} files. Errors: ${errors.join(', ')}`);\r\n            }\r\n\r\n        } catch (err: any) {\r\n            setError(err.message);\r\n        } finally {\r\n            setUploading(false);\r\n        }\r\n    };\r\n\r\n    if (!isOpen) return null;\r\n\r\n    return (\r\n        <div style={{\r\n            position: 'fixed',\r\n            top: 0,\r\n            left: 0,\r\n            right: 0,\r\n            bottom: 0,\r\n            backgroundColor: 'rgba(0,0,0,0.7)',\r\n            display: 'flex',\r\n            justifyContent: 'center',\r\n            alignItems: 'center',\r\n            zIndex: 1000\r\n        }}>\r\n            <div style={{\r\n                backgroundColor: '#1E1E1E',\r\n                color: '#fff',\r\n                padding: '2rem',\r\n                borderRadius: '8px',\r\n                width: '600px',\r\n                maxHeight: '90vh',\r\n                overflowY: 'auto',\r\n                boxShadow: '0 4px 6px rgba(0,0,0,0.3)',\r\n                position: 'relative'\r\n            }}>\r\n                <button\r\n                    onClick={onClose}\r\n                    style={{\r\n                        position: 'absolute',\r\n                        top: '1rem',\r\n                        right: '1rem',\r\n                        background: 'none',\r\n                        border: 'none',\r\n                        color: '#aaa',\r\n                        fontSize: '1.5rem',\r\n                        cursor: 'pointer'\r\n                    }}\r\n                >\r\n                    &times;\r\n                </button>\r\n\r\n                <h2 style={{ marginTop: 0, marginBottom: '1.5rem' }}>Upload Documents</h2>\r\n\r\n                {error && (\r\n                    <div style={{ backgroundColor: 'rgba(255, 0, 0, 0.1)', color: '#ff6b6b', padding: '0.75rem', borderRadius: '4px', marginBottom: '1rem' }}>\r\n                        {error}\r\n                    </div>\r\n                )}\r\n\r\n                {successMessage && (\r\n                    <div style={{ backgroundColor: 'rgba(0, 255, 0, 0.1)', color: '#4CAF50', padding: '0.75rem', borderRadius: '4px', marginBottom: '1rem' }}>\r\n                        {successMessage}\r\n                    </div>\r\n                )}\r\n\r\n                <form onSubmit={handleUpload}>\r\n                    <div style={{ marginBottom: '1.5rem' }}>\r\n                        <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: 'bold' }}>1. Select Files</label>\r\n                        <input\r\n                            type=\"file\"\r\n                            multiple\r\n                            onChange={handleFileChange}\r\n                            style={{\r\n                                display: 'block',\r\n                                width: '100%',\r\n                                padding: '0.5rem',\r\n                                backgroundColor: '#2D2D2D',\r\n                                borderRadius: '4px',\r\n                                border: '1px solid #333'\r\n                            }}\r\n                        />\r\n                        {files.length > 0 && (\r\n                            <div style={{ marginTop: '0.5rem', fontSize: '0.9rem', color: '#aaa' }}>\r\n                                {files.length} files selected\r\n                            </div>\r\n                        )}\r\n                    </div>\r\n\r\n                    <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '1rem' }}>\r\n                        <button\r\n                            type=\"button\"\r\n                            onClick={onClose}\r\n                            style={{\r\n                                padding: '0.5rem 1rem',\r\n                                backgroundColor: 'transparent',\r\n                                color: '#ccc',\r\n                                border: '1px solid #555',\r\n                                borderRadius: '4px',\r\n                                cursor: 'pointer'\r\n                            }}\r\n                        >\r\n                            Cancel\r\n                        </button>\r\n                        <button\r\n                            type=\"submit\"\r\n                            disabled={uploading || files.length === 0}\r\n                            style={{\r\n                                padding: '0.5rem 1.5rem',\r\n                                backgroundColor: uploading ? '#555' : '#3B82F6',\r\n                                color: 'white',\r\n                                border: 'none',\r\n                                borderRadius: '4px',\r\n                                cursor: 'pointer',\r\n                                opacity: uploading ? 0.7 : 1\r\n                            }}\r\n                        >\r\n                            {uploading ? 'Uploading...' : 'Upload & Create'}\r\n                        </button>\r\n                    </div>\r\n                </form>\r\n            </div>\r\n        </div>\r\n    );\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\components\\VNCPanel.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\lib\\supabase.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\scripts\\debug-storage.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\services\\ApiKeyService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\services\\AuthService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\services\\HierarchyService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\services\\McpService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":25,"column":16,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":25,"endColumn":19,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[568,571],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[568,571],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":47,"column":17,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":47,"endColumn":20,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1295,1298],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1295,1298],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":55,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1630,1633],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1630,1633],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import axios from 'axios';\r\n\r\nconst API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:5000';\r\n\r\nexport interface Notebook {\r\n    id: string;\r\n    title: string;\r\n    source_count: number;\r\n    url: string;\r\n    ownership: string;\r\n    is_shared: boolean;\r\n    created_at: number;\r\n    modified_at: number;\r\n}\r\n\r\nexport interface ArtifactResult {\r\n    id: string;\r\n    url: string;\r\n    status: 'completed' | 'processing' | 'failed' | 'pending';\r\n    title: string;\r\n}\r\n\r\nexport interface StudioStatusResponse {\r\n    status: string;\r\n    artifacts: any[];\r\n}\r\n\r\nexport const McpService = {\r\n    async listNotebooks(): Promise<Notebook[]> {\r\n        const response = await axios.get(`${API_BASE_URL}/api/mcp/notebooks`);\r\n        if (response.data.status === 'success') {\r\n            return response.data.notebooks;\r\n        }\r\n        throw new Error(response.data.error || 'Failed to list notebooks');\r\n    },\r\n\r\n    async createArtifact(params: {\r\n        notebook_id: string;\r\n        artifact_type: 'infographic' | 'video' | 'audio' | 'slides';\r\n        language?: string;\r\n        prompt?: string;\r\n        orientation?: number;\r\n        detail_level?: number;\r\n        format_code?: number;\r\n        style_code?: number;\r\n        length_code?: number;\r\n    }): Promise<any> {\r\n        const response = await axios.post(`${API_BASE_URL}/api/mcp/create`, params);\r\n        if (response.data.status === 'success') {\r\n            return response.data.result;\r\n        }\r\n        throw new Error(response.data.error || 'Failed to create artifact');\r\n    },\r\n\r\n    async getStatus(notebookId: string): Promise<any[]> {\r\n        const response = await axios.get(`${API_BASE_URL}/api/mcp/status/${notebookId}`);\r\n        if (response.data.status === 'success') {\r\n            return response.data.artifacts;\r\n        }\r\n        throw new Error(response.data.error || 'Failed to get status');\r\n    },\r\n\r\n    getProxyUrl(url: string): string {\r\n        return `${API_BASE_URL}/api/mcp/proxy_artifact?url=${encodeURIComponent(url)}`;\r\n    },\r\n\r\n    async fetchBlob(url: string): Promise<Blob> {\r\n        const proxyUrl = this.getProxyUrl(url);\r\n        const response = await axios.get(proxyUrl, { responseType: 'blob' });\r\n        const blob = response.data;\r\n\r\n        // If we got JSON back, it's probably an error message from our proxy\r\n        if (blob.type === 'application/json') {\r\n            const text = await blob.text();\r\n            try {\r\n                const json = JSON.parse(text);\r\n                if (json.status === 'error') {\r\n                    throw new Error(json.error || 'Proxy error');\r\n                }\r\n            } catch (e) {\r\n                // Not valid JSON or parsing failed, just throw a generic error\r\n                throw new Error('Received invalid data (likely HTML login page or JSON error)');\r\n            }\r\n        }\r\n\r\n        return blob;\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\services\\NodeService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":43,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":43,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1583,1586],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1583,1586],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'access_level' is assigned a value but never used.","line":109,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":109,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":109,"column":55,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":109,"endColumn":58,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3700,3703],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3700,3703],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'access_level' is assigned a value but never used.","line":121,"column":17,"nodeType":null,"messageId":"unusedVar","endLine":121,"endColumn":29},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":121,"column":60,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":121,"endColumn":63,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4080,4083],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4080,4083],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'access_level' is assigned a value but never used.","line":145,"column":21,"nodeType":null,"messageId":"unusedVar","endLine":145,"endColumn":33},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":145,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":145,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4811,4814],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4811,4814],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":7,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from '../lib/supabase';\r\nimport type { DocumentNode } from '../types';\r\nimport { AuthService } from './AuthService';\r\n\r\nexport const NodeService = {\r\n    async fetchNodes() {\r\n        // 1. Fetch all documents (RLS filtered)\r\n        const { data: nodes, error: nodeError } = await supabase\r\n            .from('documents')\r\n            .select('*')\r\n            .order('order', { ascending: true });\r\n\r\n        if (nodeError) throw nodeError;\r\n\r\n        return this._enrichNodesWithPermissions(nodes as DocumentNode[]);\r\n    },\r\n\r\n    async fetchNodesByTags(tagIds: number[]) {\r\n        // 1. Fetch filtered nodes via RPC\r\n        const { data: nodes, error: nodeError } = await supabase\r\n            .rpc('get_nodes_by_tags', { p_tag_ids: tagIds });\r\n\r\n        if (nodeError) throw nodeError;\r\n\r\n        return this._enrichNodesWithPermissions(nodes as DocumentNode[]);\r\n    },\r\n\r\n    async _enrichNodesWithPermissions(nodes: DocumentNode[]) {\r\n        // 2. Check if user is Admin\r\n        const isAdmin = await AuthService.checkIsAdmin();\r\n\r\n        // 3. Fetch permissions for the current user\r\n        const { data: user } = await supabase.auth.getUser();\r\n        let permissions: { node_id: number; access_level: 'read_only' | 'full_access' }[] = [];\r\n\r\n        if (user?.user && !isAdmin) {\r\n            const { data: perms } = await supabase\r\n                .from('document_permissions')\r\n                .select('node_id, access_level')\r\n                .eq('user_id', user.user.id);\r\n\r\n            if (perms) {\r\n                permissions = perms as any[];\r\n            }\r\n        }\r\n\r\n        // 4. Merge permissions\r\n        return nodes.map(node => {\r\n            // Admin has full access implicit\r\n            if (isAdmin) {\r\n                return { ...node, access_level: 'full_access' as const };\r\n            }\r\n\r\n            // Check explicit permissions\r\n            const perm = permissions.find(p => p.node_id === node.nodeID);\r\n            if (perm) {\r\n                return { ...node, access_level: perm.access_level };\r\n            }\r\n\r\n            // Default fallback\r\n            return { ...node, access_level: 'read_only' as const };\r\n        });\r\n    },\r\n\r\n    async getNodeById(nodeID: number) {\r\n        const { data, error } = await supabase\r\n            .from('documents')\r\n            .select('*')\r\n            .eq('nodeID', nodeID)\r\n            .single();\r\n\r\n        if (error) throw error;\r\n        const node = data as DocumentNode;\r\n\r\n        // Check if user is Admin\r\n        const isAdmin = await AuthService.checkIsAdmin();\r\n        if (isAdmin) {\r\n            return { ...node, access_level: 'full_access' as const };\r\n        }\r\n\r\n        // Fetch permissions for this node\r\n        const { data: user } = await supabase.auth.getUser();\r\n\r\n        // Owner has full access (REMOVED: user_id no longer exists on node)\r\n\r\n\r\n        if (user?.user) {\r\n            const { data: perm } = await supabase\r\n                .from('document_permissions')\r\n                .select('access_level')\r\n                .eq('user_id', user.user.id)\r\n                .eq('node_id', nodeID)\r\n                .single();\r\n\r\n            if (perm) {\r\n                return { ...node, access_level: perm.access_level as 'read_only' | 'full_access' };\r\n            }\r\n        }\r\n\r\n        // Default to read_only if visible but no explicit permission\r\n        // (RLS handles visibility, if we got here we can see it)\r\n        return { ...node, access_level: 'read_only' as const };\r\n    },\r\n\r\n    async createNode(node: Partial<DocumentNode>) {\r\n        // user_id removed from documents table\r\n\r\n\r\n        const { access_level, ...nodeData } = node as any;\r\n        const { data, error } = await supabase\r\n            .from('documents')\r\n            .insert([nodeData])\r\n            .select()\r\n            .single();\r\n\r\n        if (error) throw error;\r\n        return data as DocumentNode;\r\n    },\r\n\r\n    async updateNode(nodeID: number, updates: Partial<DocumentNode>) {\r\n        const { access_level, ...updateData } = updates as any;\r\n        console.log('NodeService.updateNode:', { nodeID, updateData });\r\n        const { data, error } = await supabase\r\n            .from('documents')\r\n            .update(updateData)\r\n            .eq('nodeID', nodeID)\r\n            .select()\r\n            .single();\r\n\r\n        if (error) throw error;\r\n        return data as DocumentNode;\r\n    },\r\n\r\n    async deleteNode(nodeID: number) {\r\n        const { error } = await supabase\r\n            .from('documents')\r\n            .delete()\r\n            .eq('nodeID', nodeID);\r\n\r\n        if (error) throw error;\r\n    },\r\n\r\n    async bulkUpdateNodes(nodes: Partial<DocumentNode>[]) {\r\n        const safeNodes = nodes.map(n => {\r\n            const { access_level, ...rest } = n as any;\r\n            return rest;\r\n        });\r\n\r\n        const { data, error } = await supabase\r\n            .from('documents')\r\n            .upsert(safeNodes)\r\n            .select();\r\n\r\n        if (error) throw error;\r\n        return data as DocumentNode[];\r\n    },\r\n\r\n    /**\r\n     * Create a node using the Supabase RPC function for proper ID generation\r\n     */\r\n    async createNodeWithRPC(title: string, parentNodeId: number | null, text: string = '') {\r\n        // Get current user ID\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) throw new Error('User not authenticated');\r\n\r\n        const { data, error } = await supabase.rpc('create_node', {\r\n            title: title,\r\n            parentnodeid: parentNodeId,\r\n            userid: user.id // Pass user_id to RPC for permission assignment\r\n        });\r\n\r\n        if (error) throw error;\r\n\r\n        // Fetch the created node to return it\r\n        const nodeId = data as number;\r\n        const createdNode = await this.getNodeById(nodeId);\r\n\r\n        // Update the text if provided (since RPC doesn't accept text parameter)\r\n        if (text && text !== 'New Node') {\r\n            return await this.updateNode(nodeId, { text });\r\n        }\r\n\r\n        return createdNode;\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\services\\NotebookLMService.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":67,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2522,2525],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2522,2525],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":126,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":126,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4786,4789],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4786,4789],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":2,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from '../lib/supabase';\r\nimport { McpService } from './McpService';\r\n\r\nexport interface NotebookLMNotebook {\r\n    id: number;\r\n    notebook_id: string;\r\n    notebook_grp: 'Client' | 'Tulkah AI' | 'MDM' | 'Process Mining' | 'Antigravity' | 'AI Developments' | 'Other';\r\n    notebook_nm: string;\r\n    notebook_desc: string | null;\r\n    created_at?: string;\r\n    updated_at?: string;\r\n}\r\n\r\nexport const NotebookLMService = {\r\n    /**\r\n     * Fetch all notebooks from Supabase cache\r\n     */\r\n    async fetchNotebooks(): Promise<NotebookLMNotebook[]> {\r\n        const { data: { user } } = await supabase.auth.getUser();\r\n        if (!user) return [];\r\n\r\n        const { data, error } = await supabase\r\n            .from('user_notebooks')\r\n            .select('*')\r\n            .eq('user_id', user.id)\r\n            .order('notebook_grp', { ascending: true })\r\n            .order('notebook_nm', { ascending: true });\r\n\r\n        if (error) {\r\n            console.error('Error fetching notebooks from Supabase:', error);\r\n            throw new Error('Failed to fetch notebooks');\r\n        }\r\n\r\n        return data as NotebookLMNotebook[];\r\n    },\r\n\r\n    /**\r\n     * Refresh notebooks from NotebookLM and store in Supabase\r\n     * This calls the backend MCP service to get live notebooks,\r\n     * then categorizes them and stores in Supabase\r\n     */\r\n    async refreshNotebooks(): Promise<void> {\r\n        try {\r\n            const { data: { user } } = await supabase.auth.getUser();\r\n            if (!user) throw new Error('User not authenticated');\r\n\r\n            // Fetch live notebooks from NotebookLM via MCP\r\n            const liveNotebooks = await McpService.listNotebooks();\r\n\r\n            // Categorize notebooks based on title patterns\r\n            const categorizedNotebooks = liveNotebooks.map(nb => ({\r\n                notebook_id: nb.id,\r\n                notebook_grp: this.categorizeNotebook(nb.title),\r\n                notebook_nm: nb.title,\r\n                notebook_desc: `${nb.source_count} sources` // Could be enhanced with more metadata\r\n            }));\r\n\r\n            // Call Supabase RPC to refresh the table\r\n            const { error } = await supabase.rpc('sync_user_notebooks', {\r\n                notebooks_data: categorizedNotebooks\r\n            });\r\n\r\n            if (error) {\r\n                console.error('Error refreshing notebooks in Supabase:', error);\r\n                throw new Error('Failed to refresh notebooks: ' + error.message);\r\n            }\r\n        } catch (err: any) {\r\n            console.error('Error in refreshNotebooks:', err);\r\n            throw new Error('Failed to refresh notebooks: ' + (err.message || 'Unknown error'));\r\n        }\r\n    },\r\n\r\n    /**\r\n     * Categorize a notebook based on its title\r\n     */\r\n    categorizeNotebook(title: string): NotebookLMNotebook['notebook_grp'] {\r\n        const lowerTitle = title.toLowerCase();\r\n\r\n        // Check for specific keywords in order of priority\r\n        if (lowerTitle.includes('antigravity') || lowerTitle.includes('anti-gravity')) {\r\n            return 'Antigravity';\r\n        }\r\n        if (lowerTitle.includes('tulkah') || lowerTitle.includes('tulkah ai')) {\r\n            return 'Tulkah AI';\r\n        }\r\n        if (lowerTitle.includes('mdm') || lowerTitle.includes('master data')) {\r\n            return 'MDM';\r\n        }\r\n        if (lowerTitle.includes('process mining') || lowerTitle.includes('celonis')) {\r\n            return 'Process Mining';\r\n        }\r\n        if (lowerTitle.includes('ai development') || lowerTitle.includes('machine learning') || lowerTitle.includes('llm')) {\r\n            return 'AI Developments';\r\n        }\r\n        if (lowerTitle.includes('client') || lowerTitle.includes('customer') || lowerTitle.includes('project')) {\r\n            return 'Client';\r\n        }\r\n\r\n        // Default category\r\n        return 'Other';\r\n    },\r\n\r\n    /**\r\n     * Update cookies via backend endpoint\r\n     */\r\n    async updateCookies(): Promise<void> {\r\n        const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:5000';\r\n\r\n        try {\r\n            const response = await fetch(`${API_BASE_URL}/api/mcp/update_cookies`, {\r\n                method: 'POST',\r\n                headers: {\r\n                    'Content-Type': 'application/json'\r\n                }\r\n            });\r\n\r\n            if (!response.ok) {\r\n                const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));\r\n                throw new Error(errorData.error || 'Failed to update cookies');\r\n            }\r\n\r\n            const result = await response.json();\r\n            if (result.status !== 'success') {\r\n                throw new Error(result.error || 'Failed to update cookies');\r\n            }\r\n        } catch (err: any) {\r\n            console.error('Error updating cookies:', err);\r\n            throw new Error('Failed to update cookies: ' + (err.message || 'Unknown error'));\r\n        }\r\n    }\r\n};\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\services\\NotebookService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\services\\StorageService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\services\\TagService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\types.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\types\\tags.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\seanb\\OneDrive\\Documents\\Tulkah.ai\\Antigravity\\node-hierarchy-manager\\src\\utils\\markdownUtils.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":2,"message":"Unexpected any. Specify a different type.","line":102,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":102,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4690,4693],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4690,4693],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"\r\nexport const openMarkdownWindow = async (title: string, url: string) => {\r\n    try {\r\n        // Fetch the markdown content from the URL\r\n        const response = await fetch(url);\r\n        if (!response.ok) {\r\n            throw new Error(`Failed to fetch markdown: ${response.statusText}`);\r\n        }\r\n        const markdownContent = await response.text();\r\n\r\n        // Open a new window and display the markdown\r\n        const markdownWindow = window.open('', '_blank', 'width=900,height=700');\r\n        if (markdownWindow) {\r\n            markdownWindow.document.write(`\r\n                <!DOCTYPE html>\r\n                <html>\r\n                <head>\r\n                    <title>${title} - Markdown</title>\r\n                    <meta charset=\"UTF-8\">\r\n                    <script src=\"https://cdn.jsdelivr.net/npm/marked/marked.min.js\"></script>\r\n                    <script src=\"https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js\"></script>\r\n                    <style>\r\n                        body {\r\n                            margin: 0;\r\n                            padding: 40px;\r\n                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;\r\n                            line-height: 1.6;\r\n                            color: #c9d1d9;\r\n                            background: #0d1117;\r\n                        }\r\n                        .container {\r\n                            max-width: 900px;\r\n                            margin: 0 auto;\r\n                            background: #161b22;\r\n                            padding: 40px;\r\n                            border-radius: 8px;\r\n                            border: 1px solid #30363d;\r\n                            box-shadow: 0 2px 8px rgba(0,0,0,0.5);\r\n                        }\r\n                        h1 { border-bottom: 2px solid #21262d; padding-bottom: 0.3em; color: #e6edf3; }\r\n                        h2 { border-bottom: 1px solid #21262d; padding-bottom: 0.3em; margin-top: 24px; color: #e6edf3; }\r\n                        h3, h4, h5, h6 { color: #e6edf3; }\r\n                        code {\r\n                            background: rgba(110,118,129,0.4);\r\n                            padding: 2px 6px;\r\n                            border-radius: 3px;\r\n                            font-family: 'Courier New', monospace;\r\n                            color: #e6edf3;\r\n                        }\r\n                        pre {\r\n                            background: #161b22;\r\n                            padding: 16px;\r\n                            border-radius: 6px;\r\n                            overflow-x: auto;\r\n                            border: 1px solid #30363d;\r\n                        }\r\n                        pre code {\r\n                            background: none;\r\n                            padding: 0;\r\n                            color: #e6edf3;\r\n                        }\r\n                        blockquote {\r\n                            border-left: 4px solid #30363d;\r\n                            padding-left: 16px;\r\n                            color: #8b949e;\r\n                            margin-left: 0;\r\n                        }\r\n                        a { color: #58a6ff; text-decoration: none; }\r\n                        a:hover { text-decoration: underline; }\r\n                        img { max-width: 100%; }\r\n                        table {\r\n                            border-collapse: collapse;\r\n                            width: 100%;\r\n                            margin: 16px 0;\r\n                        }\r\n                        table th, table td {\r\n                            border: 1px solid #30363d;\r\n                            padding: 8px 12px;\r\n                            color: #c9d1d9;\r\n                        }\r\n                        table th {\r\n                            background: #161b22;\r\n                            font-weight: 600;\r\n                            color: #e6edf3;\r\n                        }\r\n                    </style>\r\n                </head>\r\n                <body>\r\n                    <div class=\"container\">\r\n                        <div id=\"content\"></div>\r\n                    </div>\r\n                    <script>\r\n                        const markdown = ${JSON.stringify(markdownContent)};\r\n                        const cleanHtml = DOMPurify.sanitize(marked.parse(markdown));\r\n                        document.getElementById('content').innerHTML = cleanHtml;\r\n                    </script>\r\n                </body>\r\n                </html>\r\n            `);\r\n            markdownWindow.document.close();\r\n        }\r\n    } catch (err: any) {\r\n        console.error('Failed to display markdown:', err);\r\n        alert('Failed to load markdown content: ' + err.message);\r\n    }\r\n};\r\n","usedDeprecatedRules":[]}]
